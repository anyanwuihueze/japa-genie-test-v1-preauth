'use server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { InsightInput, InsightOutput } from '@/ai/schemas/insight-schemas';

const genAI = new GoogleGenerativeAI(process.env.NEXT_PUBLIC_GEMINI_API_KEY!);

export async function generateInsights(input: InsightInput): Promise<InsightOutput> {
  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = `You are an expert immigration analyst.

Generate insights for: "${input.question}"

Return ONLY valid JSON in this EXACT format (no markdown, no backticks):
{
  "insights": [
    {
      "headline": "Clear headline",
      "detail": "Detailed explanation",
      "url": "optional link"
    }
  ],
  "costEstimates": [
    {
      "item": "Cost item name",
      "cost": 1000,
      "currency": "USD"
    }
  ],
  "visaAlternatives": [
    {
      "visaName": "Alternative visa name",
      "description": "Why this alternative works"
    }
  ],
  "chartData": {
    "title": "Processing Times by Country",
    "data": [
      {"name": "USA", "value": 90},
      {"name": "UK", "value": 60}
    ]
  }
}

Generate 3-5 insights, 2-4 cost estimates, 2-3 alternatives, and chart data with 3-5 countries.`;

  try {
    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().trim();
    
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    return JSON.parse(text);
  } catch (error) {
    console.error('Insights API error:', error);
    return {
      insights: [{ headline: "Temporary Service Issue", detail: "The Genie is experiencing technical difficulties. Please try again in a moment." }],
      costEstimates: [],
      visaAlternatives: [],
      chartData: { title: "Processing Times", data: [{ name: "USA", value: 90 }] }
    };
  }
}
