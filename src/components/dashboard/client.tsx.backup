'use client';

import { EnhancedProfileCard } from '@/components/dashboard/enhanced-profile-card';
import { ConfidenceMeter } from '@/components/dashboard/confidence-meter';
import { QuickStats } from '@/components/dashboard/quick-stats';
import { ActionItemsWidgetFixed } from '@/components/dashboard/action-items-widget-fixed';
import { NextBestAction } from '@/components/dashboard/next-best-action';
import { ApplicationTimeline } from '@/components/dashboard/application-timeline';
import { StartVisaJourneyCard } from '@/components/dashboard/start-visa-journey-card';
import { VisaAssistantCard } from '@/components/dashboard/visa-assistant-card';
import { DocumentCheckerCard } from '@/components/dashboard/document-checker-card';
import { POFSeasoningTracker } from '@/components/dashboard/pof-seasoning-tracker';
import { DocumentAIAnalysis } from '@/components/dashboard/document-ai-analysis';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { MessageCircleQuestion, Map, Users, TrendingUp, Shield, Clock, Target, ArrowRight, AlertTriangle } from 'lucide-react';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { createClient } from '@/lib/supabase/client';
import { useIsMobile } from '@/hooks/use-mobile';

interface DashboardClientProps {
  user: any;
  userProfile?: any;
}

// Tool cards - ONLY WORKING TOOLS (3 total)
const features = [
  {
    icon: MessageCircleQuestion,
    title: 'AI Mock Interview',
    description: 'Practice with realistic questions. Upgrade to human expert feedback for personalized coaching.',
    href: '/interview',
    cta: 'Start Practicing',
    expert: true,
    expertText: 'Get human feedback'
  },
  {
    icon: Map,
    title: 'Visa Journey Tracker',
    description: 'See your detailed timeline. Connect with experts if you get stuck at any step.',
    href: '/progress',
    cta: 'View Journey',
    expert: false
  },
  {
    icon: Users,
    title: 'Human Expert Help',
    description: 'Stuck? Get 1-on-1 guidance from verified visa consultants with proven success records.',
    href: '/experts',
    cta: 'Find Experts',
    expert: true,
    highlight: true
  },
];

interface UserProgress {
  progressPercentage: number;
  nextMilestone: string;
  daysToDeadline: number;
  moneySaved: number;
  aheadOfPercentage: number;
  documentsCompleted: number;
  totalDocuments: number;
  successProbability: number;
  estimatedTimeline: string;
  currentStage: string;
}

export default function DashboardClientFinal({ user, userProfile }: DashboardClientProps) {
  const [userProgress, setUserProgress] = useState<UserProgress>({
    progressPercentage: 0,
    nextMilestone: "Complete Your Profile",
    daysToDeadline: 30,
    moneySaved: 0,
    aheadOfPercentage: 0,
    documentsCompleted: 0,
    totalDocuments: 8,
    successProbability: 65,
    estimatedTimeline: "6-8 months",
    currentStage: "Onboarding"
  });
  const [loading, setLoading] = useState(true);
  const isMobile = useIsMobile();

  useEffect(() => {
    if (user) {
      fetchUserProgress();
    }
  }, [user]);

  const fetchUserProgress = async () => {
    if (!user) return;
    
    setLoading(true);
    const supabase = createClient();
    
    try {
      // Fetch REAL chat message count
      const { count: messageCount } = await supabase
        .from('messages')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.id);

      // Fetch REAL document count
      const { count: docCount } = await supabase
        .from('user_documents')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.id);

      // Calculate REAL progress
      const realProgress = calculateRealProgress(userProfile, messageCount || 0, docCount || 0);
      setUserProgress(realProgress);
      
    } catch (error) {
      console.error('Error fetching user data:', error);
    } finally {
      setLoading(false);
    }
  };

  const calculateRealProgress = (profile: any, messageCount: number, docCount: number): UserProgress => {
    let progressPercentage = 0;
    let nextMilestone = "Complete Your Profile";
    let currentStage = "Onboarding";

    // Profile completion (KYC)
    if (profile?.country && profile?.destination_country && profile?.visa_type) {
      progressPercentage += 30;
      nextMilestone = "Upload Documents";
      currentStage = "Document Preparation";
    }

    // Chat engagement
    if (messageCount > 0) {
      progressPercentage += 20;
      if (progressPercentage >= 30) nextMilestone = "Complete Document Upload";
    }

    // Document uploads
    if (docCount > 0) {
      progressPercentage += Math.min(docCount * 5, 30);
      if (progressPercentage >= 50) {
        nextMilestone = "Schedule Interview Practice";
        currentStage = "Interview Preparation";
      }
    }

    progressPercentage = Math.min(progressPercentage, 100);

    const moneySaved = Math.round(progressPercentage * 24000);
    const aheadOfPercentage = Math.floor(progressPercentage * 0.8);
    const successProbability = Math.min(65 + Math.floor(progressPercentage / 2), 95);
    const estimatedTimeline = progressPercentage > 50 ? "4-5 months" : "6-8 months";
    const daysToDeadline = Math.max(30 - Math.floor(progressPercentage / 3), 7);

    return {
      progressPercentage,
      nextMilestone,
      daysToDeadline,
      moneySaved,
      aheadOfPercentage,
      documentsCompleted: docCount,
      totalDocuments: 8,
      successProbability,
      estimatedTimeline,
      currentStage
    };
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p>Loading your dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`space-y-8 ${isMobile ? 'p-4' : ''}`}>
      {/* Header - Responsive */}
      <header className="space-y-2">
        <h1 className={`${isMobile ? 'text-2xl' : 'text-4xl'} font-bold tracking-tight`}>
          {userProfile?.destination_country 
            ? `Your Visa Journey to ${userProfile.destination_country}`
            : `Welcome back, ${user?.email?.split('@')[0] || 'Traveler'}! üëã`
          }
        </h1>
        <p className={`${isMobile ? 'text-base' : 'text-lg'} text-muted-foreground`}>
          Your personalized AI guide to visa success. Here's your journey at a glance.
        </p>
      </header>

      {/* üçé APPLE HEALTH RINGS - Hero Component */}
      <QuickStats userId={user.id} className="w-full" />

      {/* NEW: ACTION ITEMS WIDGET - Real-time task extraction */}
      <ActionItemsWidgetFixed userId={user.id} className="w-full" />

      {/* üéØ SMART TOOLS GRID - Apple-style layout */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <VisaAssistantCard 
          userId={user.id} 
          userProfile={userProfile} 
          userProgress={userProgress} 
        />
        <NextBestAction 
          userId={user.id} 
          userProfile={userProfile} 
          currentProgress={userProgress.progressPercentage}
          className="w-full" 
        />
      </div>

      {/* üåç POF SEASONING TRACKER - Progressive unlocking */}
      <POFSeasoningTracker 
        userId={user.id} 
        userProfile={userProfile} 
        className="w-full" 
      />

      {/* üìÑ DOCUMENT AI ANALYSIS - Intelligent compliance */}
      <DocumentAIAnalysis 
        userId={user.id} 
        className="w-full" 
      />

      {/* NEXT BEST ACTION & CONFIDENCE METER */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <NextBestAction 
          userId={user.id} 
          userProfile={userProfile} 
          currentProgress={userProgress.progressPercentage}
          className="w-full" 
        />
        <ConfidenceMeter 
          userId={user.id} 
          userProfile={userProfile} 
          currentProgress={userProgress.progressPercentage} 
          className="w-full" 
        />
      </div>

      {/* APPLICATION TIMELINE */}
      <ApplicationTimeline 
        userId={user.id} 
        userProfile={userProfile} 
        currentProgress={userProgress.progressPercentage}
        className="w-full" 
      />

      {/* JOURNEY LOCK-IN & DOCUMENT CHECKER */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <StartVisaJourneyCard 
          userId={user.id} 
          userProfile={userProfile}
          userProgressSummary={userProgress}
          onStartJourney={async () => {
            const supabase = createClient();
            await supabase.from('user_progress_summary').upsert({
              user_id: user.id,
              journey_started: new Date().toISOString(),
              current_stage: 'planning',
              overall_progress: 25
            });
          }}
        />
        <DocumentCheckerCard 
          userId={user.id} 
          userProgress={userProgress} 
        />
      </div>

      {/* PROFILE CARD */}
      <EnhancedProfileCard 
        userProfile={userProfile} 
        userId={user.id} 
        onProfileUpdate={() => window.location.reload()} 
      />

      {/* ENHANCED FEATURES GRID - Simplified */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        {features.map((feature) => (
          <Card 
            key={feature.title} 
            className={`flex flex-col group hover:border-primary transition-all ${
              feature.highlight ? 'border-2 border-orange-300 bg-orange-50' : ''
            }`}
          >
            <CardHeader className="flex-1">
              <div className="flex items-start gap-4">
                <div className={`p-3 rounded-full transition-colors ${
                  feature.highlight 
                    ? 'bg-orange-100 text-orange-600' 
                    : 'bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground'
                }`}>
                  <feature.icon className="w-7 h-7" />
                </div>
                <div className='flex-1'>
                  <div className="flex items-center gap-2 mb-1">
                    <CardTitle className={`${isMobile ? 'text-base' : 'text-xl'}`}>{feature.title}</CardTitle>
                    {feature.expert && (
                      <Badge variant="outline" className={`${isMobile ? 'text-xs' : 'text-xs'} bg-blue-50`}>
                        <Shield className="w-3 h-3 mr-1" />
                        Expert Available
                      </Badge>
                    )}
                  </div>
                  <CardDescription className={`${isMobile ? 'text-sm' : 'text-base'}`}>{feature.description}</CardDescription>
                </div>
              </div>
            </CardHeader>
            <div className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
              <Button asChild className={`w-full transition-colors ${
                feature.highlight 
                  ? 'bg-orange-500 hover:bg-orange-600' 
                  : 'group-hover:bg-amber-400'
              }`}>
                <Link href={feature.href} className="flex items-center justify-center gap-2">
                  {feature.cta} <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
                </Link>
              </Button>
            </div>
          </Card>
        ))}
      </div>

      {/* URGENT ACTION CARD */}
      {userProgress.daysToDeadline < 7 && (
        <Card className="border-red-200 bg-red-50">
          <CardHeader>
            <CardTitle className="text-red-800 flex items-center gap-2">
              <Clock className="w-5 h-5" />
              Urgent Action Needed
            </CardTitle>
            <CardDescription className="text-red-700">
              Your {userProgress.nextMilestone} deadline is in {userProgress.daysToDeadline} days.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex gap-4">
              <Button variant="outline" asChild>
                <Link href="/experts">
                  Get Expert Help
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
