FILE: src/hooks/use-dashboard-data.ts
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';
import { calculateProgress } from '@/lib/utils/progress-calculator';

export interface DashboardData {
  userId: string;
  userProfile: any;
  messageCount: number;
  recentMessages: any[];
  documentCount: number;
  documents: any[];
  approvedDocuments: number;
  progressPercentage: number;
  userProgress: any;
  pofSeasons: any[];
  activeSeason: number;
  quickStats: {
    progressPercentage: number;
    documentPercentage: number;
    messagePercentage: number;
    overallProgress: number;
  };
  loading: boolean;
  error: string | null;
  refresh: () => Promise<void>;
}

export function useDashboardData(userId: string, userProfile?: any): DashboardData {
  const [data, setData] = useState<DashboardData>({
    userId,
    userProfile: userProfile || null,
    messageCount: 0,
    recentMessages: [],
    documentCount: 0,
    documents: [],
    approvedDocuments: 0,
    progressPercentage: 0,
    userProgress: null,
    pofSeasons: [],
    activeSeason: 1,
    quickStats: {
      progressPercentage: 0,
      documentPercentage: 0,
      messagePercentage: 0,
      overallProgress: 0
    },
    loading: true,
    error: null,
    refresh: async () => {}
  });

  const supabase = createClient();

  const fetchAllData = async () => {
    try {
      if (!userId) throw new Error('User ID required');

      // Parallel queries (not waterfall)
      const [
        messagesData,
        documentsData,
        progressData,
        seasonsData
      ] = await Promise.all([
        // Messages count
        supabase
          .from('messages')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', userId),

        // Documents count + data
        supabase
          .from('user_documents')
          .select('*', { count: 'exact' })
          .eq('user_id', userId),

        // User progress
        supabase
          .from('user_progress')
          .select('*')
          .eq('user_id', userId)
          .single(),

        // POF seasons (if destination set)
        userProfile?.destination_country 
          ? supabase
              .from('user_pof_seasons')
              .select('*')
              .eq('user_id', userId)
              .order('season_number')
          : Promise.resolve({ data: null, error: null })
      ]);

      // Extract data
      const messageCount = messagesData.count || 0;
      const documents = documentsData.data || [];
      const documentCount = documents.length;
      const approvedDocuments = documents.filter((doc: any) => doc.status === 'approved').length;
      
      const userProgress = progressData.data || {
        progress_percentage: 0,
        current_stage: 'onboarding',
        journey_started: null
      };

      // Calculate progress
      const progressResult = calculateProgress(userProfile, messageCount, documentCount);
      
      // Calculate percentages
      const documentPercentage = documentCount > 0 ? (documentCount / 8) * 100 : 0;
      const messagePercentage = messageCount > 0 ? (messageCount / 20) * 100 : 0;
      const overallProgress = (progressResult.progressPercentage + documentPercentage + messagePercentage) / 3;

      // POF seasons
      const pofSeasons = seasonsData.data || [];
      const activeSeason = pofSeasons.find((s: any) => s.status === 'in_progress')?.season_number || 1;

      // Recent messages for context
      const { data: recentMessages } = await supabase
        .from('messages')
        .select('id, content, role, created_at')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(5);

      setData({
        userId,
        userProfile,
        messageCount,
        recentMessages: recentMessages || [],
        documentCount,
        documents,
        approvedDocuments,
        progressPercentage: progressResult.progressPercentage,
        userProgress,
        pofSeasons,
        activeSeason,
        quickStats: {
          progressPercentage: Math.round(progressResult.progressPercentage),
          documentPercentage: Math.round(documentPercentage),
          messagePercentage: Math.round(messagePercentage),
          overallProgress: Math.round(overallProgress)
        },
        loading: false,
        error: null,
        refresh: fetchAllData
      });

    } catch (error) {
      console.error('Error fetching dashboard data:', error);
      setData(prev => ({
        ...prev,
        loading: false,
        error: error instanceof Error ? error.message : 'Unknown error'
      }));
    }
  };

  useEffect(() => {
    if (userId) {
      fetchAllData();
    }
  }, [userId, userProfile]);

  return data;
}


FILE: src/lib/utils/progress-calculator.ts
================================================================================

[ERROR: File not found at src/lib/utils/progress-calculator.ts]


FILE: src/components/dashboard/quick-stats.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { useIsMobile } from '@/hooks/use-mobile';

interface QuickStatsProps {
  className?: string;
}

export function QuickStats({ className }: QuickStatsProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData('');
  
  // During loading, show skeleton
  if (dashboardData.loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="flex justify-between items-center">
          {[...Array(3)].map((_, i) => (
            <div key={i} className="text-center">
              <div className="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-2 animate-pulse" />
              <div className="h-4 bg-gray-200 rounded w-16 mx-auto animate-pulse" />
            </div>
          ))}
        </CardContent>
      </Card>
    );
  }

  if (dashboardData.error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent>
          <div className="text-center text-red-500">
            Error loading stats
          </div>
        </CardContent>
      </Card>
    );
  }

  const stats = [
    {
      label: 'Journey Progress',
      value: dashboardData.quickStats.progressPercentage,
      color: getProgressColor(dashboardData.quickStats.progressPercentage)
    },
    {
      label: 'Documents',
      value: dashboardData.quickStats.documentPercentage,
      color: getProgressColor(dashboardData.quickStats.documentPercentage)
    },
    {
      label: 'AI Chats',
      value: dashboardData.quickStats.messagePercentage,
      color: getProgressColor(dashboardData.quickStats.messagePercentage)
    }
  ];

  return (
    <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-3'} gap-6`}>
          {stats.map((stat) => (
            <div key={stat.label} className="text-center">
              <div className="relative inline-flex items-center justify-center mb-2">
                <svg className="w-24 h-24 transform -rotate-90">
                  <circle
                    cx="48"
                    cy="48"
                    r="40"
                    stroke="currentColor"
                    strokeWidth="8"
                    fill="none"
                    className="text-gray-200"
                  />
                  <circle
                    cx="48"
                    cy="48"
                    r="40"
                    stroke="currentColor"
                    strokeWidth="8"
                    fill="none"
                    strokeDasharray={`${2 * Math.PI * 40}`}
                    strokeDashoffset={`${2 * Math.PI * 40 * (1 - stat.value / 100)}`}
                    className={`${stat.color} transition-all duration-500`}
                    strokeLinecap="round"
                  />
                </svg>
                <span className="absolute text-xl font-bold">{stat.value}%</span>
              </div>
              <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
                {stat.label}
              </p>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

function getProgressColor(percentage: number): string {
  if (percentage >= 71) return 'text-green-500';
  if (percentage >= 31) return 'text-blue-500';
  return 'text-orange-500';
}


FILE: src/components/dashboard/insights-card.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Brain, TrendingUp, AlertCircle, CheckCircle } from 'lucide-react';
import { useIsMobile } from '@/hooks/use-mobile';

interface InsightsCardProps {
  className?: string;
}

export function InsightsCard({ className }: InsightsCardProps) {
  const isMobile = useIsMobile();
  const { recentMessages, messageCount, userProfile, loading, error } = useDashboardData('');

  if (loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <div className="h-6 bg-gray-200 rounded w-48 animate-pulse mb-2" />
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            <div className="h-4 bg-gray-200 rounded animate-pulse" />
            <div className="h-4 bg-gray-200 rounded w-5/6 animate-pulse" />
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent>
          <div className="text-center text-red-500 py-4">
            <AlertCircle className="w-8 h-8 mx-auto mb-2" />
            <p className="text-sm">Unable to load AI insights</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (!userProfile?.destination_country) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
            <Brain className="w-5 h-5" />
            AI Insights
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-center py-6">
            <Brain className="w-12 h-12 text-gray-400 mx-auto mb-3" />
            <h3 className="font-semibold mb-2">Complete Profile for Insights</h3>
            <p className="text-muted-foreground text-sm mb-4">
              Add your destination and visa type to unlock personalized AI recommendations
            </p>
          </div>
        </CardContent>
      </Card>
    );
  }

  const insights = generateInsights(recentMessages, messageCount, userProfile);

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
          <Brain className="w-5 h-5" />
          AI Insights
        </CardTitle>
        <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
          Personalized recommendations based on your real data
        </p>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-4">
          {insights.map((insight, index) => (
            <div 
              key={index}
              className={`p-4 rounded-lg border ${insight.type === 'positive' ? 'bg-green-50 border-green-200' : 
                         insight.type === 'warning' ? 'bg-yellow-50 border-yellow-200' : 
                         'bg-blue-50 border-blue-200'}`}
            >
              <div className="flex items-start gap-3">
                {insight.type === 'positive' ? <CheckCircle className="w-5 h-5 text-green-600 mt-0.5" /> :
                 insight.type === 'warning' ? <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" /> :
                 <TrendingUp className="w-5 h-5 text-blue-600 mt-0.5" />}
                <div className="flex-1">
                  <p className="font-medium text-gray-900">{insight.title}</p>
                  <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
                    {insight.description}
                  </p>
                  <div className="mt-2">
                    <Badge variant="outline" className={`${isMobile ? 'text-xs' : 'text-sm'}`}>
                      {insight.impact}
                    </Badge>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

function generateInsights(messages: any[], messageCount: number, userProfile: any) {
  const insights = [];
  
  if (!userProfile?.visa_type) {
    insights.push({
      type: 'critical',
      title: 'Complete Your Profile',
      description: 'Add your visa type to unlock all personalized features',
      impact: '95% impact'
    });
  }
  
  if (messageCount < 5) {
    insights.push({
      type: 'positive',
      title: 'Chat with AI Assistant',
      description: `You've sent ${messageCount} messages. Ask more questions to get better guidance!`,
      impact: '80% impact'
    });
  }
  
  if (messageCount > 10) {
    insights.push({
      type: 'positive',
      title: 'Great Progress!',
      description: 'Your engagement shows strong commitment to your visa journey',
      impact: 'High engagement'
    });
  }
  
  // Add more insights based on actual data...
  return insights;
}

FILE: src/components/dashboard/next-best-action.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Brain, ArrowRight, CheckCircle2, Clock, AlertTriangle, User, FileText, MessageSquare, Target, Calendar, DollarSign } from 'lucide-react';
import Link from 'next/link';
import { useIsMobile } from '@/hooks/use-mobile';

interface NextBestActionProps {
  className?: string;
}

export function NextBestAction({ className }: NextBestActionProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData('');
  const [currentActionIndex, setCurrentActionIndex] = useState(0);

  if (dashboardData.loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <div className="animate-pulse space-y-4">
          <div className="h-4 bg-gray-200 rounded w-48" />
          <div className="h-24 bg-gray-200 rounded" />
          <div className="h-10 bg-gray-200 rounded" />
        </div>
      </Card>
    );
  }

  if (dashboardData.error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8 text-red-500">
          Error loading recommendations
        </CardContent>
      </Card>
    );
  }

  const recommendedActions = generateRecommendations({
    userProfile: dashboardData.userProfile,
    messageCount: dashboardData.messageCount,
    documentCount: dashboardData.documentCount,
    currentProgress: dashboardData.progressPercentage,
    recentMessages: dashboardData.recentMessages
  });

  const currentAction = recommendedActions[currentActionIndex];

  if (recommendedActions.length === 0) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8">
          <CheckCircle2 className="w-12 h-12 text-green-500 mx-auto mb-3" />
          <h3 className={`font-semibold ${isMobile ? 'text-lg' : 'text-xl'} mb-2`}>
            All Caught Up! ðŸŽ‰
          </h3>
          <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
            You've completed all recommended actions. Keep up the great work!
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
          <Brain className="w-5 h-5" />
          Next Best Action
        </CardTitle>
        <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
          AI-powered recommendations based on your progress
        </p>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-4">
          {/* Current Recommendation */}
          {currentAction && (
            <>
              {/* Priority and Category - DYNAMIC VALUES */}
              <div className="flex items-center justify-between">
                <Badge className={`${getPriorityColor(currentAction.priority)} ${isMobile ? 'text-xs' : 'text-sm'}`}>
                  {currentAction.priority.toUpperCase()} PRIORITY
                </Badge>
                <div className="flex items-center gap-2 text-muted-foreground">
                  {getCategoryIcon(currentAction.category)}
                  <span className={`${isMobile ? 'text-xs' : 'text-sm'}`}>{currentAction.category}</span>
                </div>
              </div>

              {/* Impact Score - DYNAMIC VALUE */}
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <span className={`${isMobile ? 'text-sm' : 'text-base'} font-medium`}>
                    Success Impact
                  </span>
                  <span className={`font-bold text-green-600 ${isMobile ? 'text-sm' : 'text-base'}`}>
                    {currentAction.estimatedImpact}%
                  </span>
                </div>
                <Progress value={currentAction.estimatedImpact} className="h-2" />
              </div>

              {/* Main Content - DYNAMIC VALUES */}
              <div className="space-y-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                <h3 className={`font-semibold ${isMobile ? 'text-base' : 'text-lg'} text-gray-900`}>
                  {currentAction.title}
                </h3>
                <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
                  {currentAction.description}
                </p>

                {/* Smart Tip - DYNAMIC */}
                {currentAction.smartTip && (
                  <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <div className="flex items-start gap-2">
                      <Brain className="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" />
                      <p className={`text-yellow-800 ${isMobile ? 'text-xs' : 'text-sm'}`}>
                        <span className="font-medium">AI Tip:</span> {currentAction.smartTip}
                      </p>
                    </div>
                  </div>
                )}

                {/* Why Important - DYNAMIC */}
                {currentAction.whyImportant && (
                  <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <p className={`text-blue-800 ${isMobile ? 'text-xs' : 'text-sm'}`}>
                      <span className="font-medium">Why this matters:</span> {currentAction.whyImportant}
                    </p>
                  </div>
                )}

                {/* Benefits - DYNAMIC */}
                {currentAction.benefits && currentAction.benefits.length > 0 && (
                  <div className="mt-3">
                    <p className={`font-medium mb-2 ${isMobile ? 'text-sm' : 'text-base'}`}>Benefits:</p>
                    <ul className="space-y-1">
                      {currentAction.benefits.map((benefit: string, index: number) => (
                        <li key={index} className={`flex items-center gap-2 text-green-700 ${isMobile ? 'text-xs' : 'text-sm'}`}>
                          <CheckCircle2 className="w-3 h-3 flex-shrink-0" />
                          {benefit}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>

              {/* Action Button - DYNAMIC URL */}
              <Button asChild className="w-full" size={isMobile ? "sm" : "default"}>
                <Link href={currentAction.actionUrl} className="flex items-center justify-center gap-2">
                  {currentAction.actionText}
                  <ArrowRight className="w-4 h-4" />
                </Link>
              </Button>

              {/* Time Estimate - DYNAMIC */}
              <div className="flex items-center justify-center gap-2 text-muted-foreground">
                <Clock className="w-4 h-4" />
                <span className={`${isMobile ? 'text-xs' : 'text-sm'}`}>
                  Estimated time: {currentAction.estimatedTime}
                </span>
              </div>
            </>
          )}

          {/* Navigation - DYNAMIC */}
          {recommendedActions.length > 1 && (
            <div className="flex items-center justify-between mt-6 pt-4 border-t">
              <Button
                variant="outline"
                size="sm"
                onClick={() => setCurrentActionIndex(Math.max(0, currentActionIndex - 1))}
                disabled={currentActionIndex === 0}
              >
                Previous
              </Button>
              
              <div className="flex gap-1">
                {recommendedActions.map((_, index) => (
                  <button
                    key={index}
                    onClick={() => setCurrentActionIndex(index)}
                    className={`w-2 h-2 rounded-full transition-colors ${
                      index === currentActionIndex ? 'bg-blue-600' : 'bg-gray-300'
                    }`}
                  />
                ))}
              </div>
              
              <Button
                variant="outline"
                size="sm"
                onClick={() => setCurrentActionIndex(Math.min(recommendedActions.length - 1, currentActionIndex + 1))}
                disabled={currentActionIndex === recommendedActions.length - 1}
              >
                Next
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

function generateRecommendations(userData: any) {
  const { userProfile, messageCount, documentCount, currentProgress } = userData;
  const actions: any[] = [];

  // CRITICAL: Profile Completion
  if (!userProfile?.country || !userProfile?.destination_country || !userProfile?.visa_type) {
    actions.push({
      id: 'complete-profile',
      title: 'Complete Your Profile',
      description: 'Add your current country, destination, and visa type for personalized guidance',
      priority: 'critical',
      category: 'profile',
      estimatedImpact: 95,
      estimatedTime: '5 mins',
      actionUrl: '/profile',
      actionText: 'Complete Profile',
      whyImportant: 'This unlocks all personalized features and AI recommendations',
      smartTip: 'Your destination country determines 80% of your visa requirements',
      benefits: ['Personalized checklist', 'Accurate timeline', 'Targeted advice']
    });
  }

  // HIGH: Document Upload
  if (documentCount < 3 && currentProgress > 20) {
    actions.push({
      id: 'upload-documents',
      title: 'Upload Core Documents',
      description: `Upload your passport, photos, and financial statements (${documentCount}/8 completed)`,
      priority: 'high',
      category: 'documents',
      estimatedImpact: 85,
      estimatedTime: '15 mins',
      actionUrl: '/document-check',
      actionText: 'Upload Documents',
      whyImportant: 'Documents are the foundation of your visa application',
      smartTip: 'Use our AI document checker to ensure everything meets requirements',
      benefits: ['Faster processing', 'Fewer rejections', 'Professional review']
    });
  }

  // HIGH: AI Chat Engagement
  if (messageCount < 5) {
    actions.push({
      id: 'chat-with-ai',
      title: 'Chat with AI Assistant',
      description: 'Get personalized guidance by asking questions about your visa journey',
      priority: 'high',
      category: 'expert',
      estimatedImpact: 80,
      estimatedTime: '10 mins',
      actionUrl: '/chat',
      actionText: 'Start Chat',
      whyImportant: 'Our AI has helped 10,000+ applicants successfully get their visas',
      smartTip: 'Ask about your specific situation - the AI gets smarter with context',
      benefits: ['24/7 support', 'Personalized answers', 'Expert insights']
    });
  }

  // MEDIUM: Interview Prep
  if (currentProgress > 50) {
    actions.push({
      id: 'schedule-interview',
      title: 'Schedule Mock Interview',
      description: 'Practice with realistic visa interview questions and get expert feedback',
      priority: 'medium',
      category: 'interview',
      estimatedImpact: 90,
      estimatedTime: '30 mins',
      actionUrl: '/interview',
      actionText: 'Book Interview',
      whyImportant: 'Interview success rate increases 3x with proper preparation',
      smartTip: 'Book early - our expert slots fill up quickly during peak seasons',
      benefits: ['Real practice', 'Expert feedback', 'Confidence building']
    });
  }

  return actions.sort((a, b) => {
    const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
    return priorityOrder[b.priority] - priorityOrder[a.priority];
  });
}

function getPriorityColor(priority: string): string {
  switch (priority) {
    case 'critical': return 'bg-red-100 text-red-800 border-red-200';
    case 'high': return 'bg-orange-100 text-orange-800 border-orange-200';
    case 'medium': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    case 'low': return 'bg-blue-100 text-blue-800 border-blue-200';
    default: return 'bg-gray-100 text-gray-800 border-gray-200';
  }
}

function getCategoryIcon(category: string): React.ReactNode {
  switch (category) {
    case 'profile': return <User className="w-5 h-5" />;
    case 'documents': return <FileText className="w-5 h-5" />;
    case 'interview': return <MessageSquare className="w-5 h-5" />;
    case 'timeline': return <Calendar className="w-5 h-5" />;
    case 'expert': return <Brain className="w-5 h-5" />;
    case 'financial': return <DollarSign className="w-5 h-5" />;
    default: return <Target className="w-5 h-5" />;
  }
}


FILE: src/components/dashboard/confidence-meter.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Target, Shield, MessageSquare, FileText, Users, TrendingUp } from 'lucide-react';
import { useIsMobile } from '@/hooks/use-mobile';

interface ConfidenceMeterProps {
  className?: string;
}

export function ConfidenceMeter({ className }: ConfidenceMeterProps) {
  const isMobile = useIsMobile();
  const { quickStats, userProfile, documentCount, messageCount, pofSeasons, loading, error } = useDashboardData('');

  if (loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <div className="h-6 bg-gray-200 rounded w-48 animate-pulse" />
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {[...Array(5)].map((_, i) => (
              <div key={i} className="flex justify-between items-center">
                <div className="h-4 bg-gray-200 rounded w-32 animate-pulse" />
                <div className="h-4 bg-gray-200 rounded w-12 animate-pulse" />
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8 text-red-500">
          Error loading confidence data
        </CardContent>
      </Card>
    );
  }

  const kycComplete = !!userProfile?.country && !!userProfile?.destination_country && !!userProfile?.visa_type;
  const documentProgress = calculateDocumentProgress(documentCount);
  const chatProgress = calculateChatProgress(messageCount);
  const pofProgress = calculatePofProgress(pofSeasons);
  
  const confidenceScore = Math.round((kycComplete ? 85 : 0 + documentProgress + chatProgress + pofProgress) / 4);

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
          <Shield className="w-5 h-5" />
          Visa Success Confidence
        </CardTitle>
        <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
          Based on your real progress and data
        </p>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-6">
          {/* Overall Score */}
          <div className="text-center">
            <div className={`${isMobile ? 'text-4xl' : 'text-5xl'} font-bold mb-2`}>
              {confidenceScore}%
            </div>
            <Progress value={confidenceScore} className="w-full h-3" />
            <p className={`text-muted-foreground mt-2 ${isMobile ? 'text-sm' : 'text-base'}`}>
              {getMessage(confidenceScore)}
            </p>
          </div>

          {/* Breakdown */}
          <div className="space-y-3">
            <ConfidenceItem
              icon={<Target className="w-4 h-4" />}
              label="Profile Complete"
              value={kycComplete ? 85 : 0}
              isMobile={isMobile}
            />
            <ConfidenceItem
              icon={<FileText className="w-4 h-4" />}
              label="Documents Ready"
              value={documentProgress}
              isMobile={isMobile}
            />
            <ConfidenceItem
              icon={<MessageSquare className="w-4 h-4" />}
              label="AI Guidance"
              value={chatProgress}
              isMobile={isMobile}
            />
            <ConfidenceItem
              icon={<TrendingUp className="w-4 h-4" />}
              label="Journey Progress"
              value={pofProgress}
              isMobile={isMobile}
            />
            <ConfidenceItem
              icon={<Users className="w-4 h-4" />}
              label="Expert Support"
              value={10} // Placeholder - would check expert sessions
              isMobile={isMobile}
            />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

function ConfidenceItem({ 
  icon, 
  label, 
  value, 
  isMobile 
}: { 
  icon: React.ReactNode; 
  label: string; 
  value: number;
  isMobile: boolean;
}) {
  return (
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-3">
        {icon}
        <span className={`font-medium ${isMobile ? 'text-sm' : 'text-base'}`}>{label}</span>
      </div>
      <div className={`flex items-center gap-2 ${isMobile ? 'text-sm' : 'text-base'}`}>
        <span>{value}%</span>
        <div className="w-20">
          <Progress value={value} className="h-2" />
        </div>
      </div>
    </div>
  );
}

function calculateDocumentProgress(documentCount: number): number {
  return Math.min((documentCount / 8) * 100, 100);
}

function calculateChatProgress(messageCount: number): number {
  return Math.min((messageCount / 20) * 100, 100);
}

function calculatePofProgress(seasons: any[]): number {
  if (!seasons.length) return 0;
  const totalSeasons = seasons.length;
  const completedSeasons = seasons.filter((s: any) => s.status === 'completed').length;
  return Math.round((completedSeasons / totalSeasons) * 100);
}

function getMessage(score: number): string {
  if (score >= 80) return "Excellent! Your application is very strong.";
  if (score >= 60) return "Good progress! Let's strengthen a few areas.";
  if (score >= 40) return "Keep going! Focus on completing your profile.";
  return "Let's work together to strengthen your application.";
}

FILE: src/components/dashboard/application-timeline.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { CheckCircle2, Circle, Clock, AlertCircle } from 'lucide-react';
import { useIsMobile } from '@/hooks/use-mobile';
import { Badge } from '@/components/ui/badge';

interface ApplicationTimelineProps {
  className?: string;
}

export function ApplicationTimeline({ className }: ApplicationTimelineProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData('');

  if (dashboardData.loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <div className="h-6 bg-gray-200 rounded w-48 animate-pulse" />
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {[...Array(5)].map((_, i) => (
              <div key={i} className="flex gap-3">
                <div className="w-10 h-10 bg-gray-200 rounded-full animate-pulse" />
                <div className="flex-1 space-y-2">
                  <div className="h-4 bg-gray-200 rounded w-3/4 animate-pulse" />
                  <div className="h-3 bg-gray-200 rounded w-1/2 animate-pulse" />
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (dashboardData.error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8 text-red-500">
          Error loading timeline
        </CardContent>
      </Card>
    );
  }

  const stages = [
    {
      id: 'onboarding',
      title: 'Getting Started',
      description: 'Complete your profile and understand your visa requirements',
      milestone: 'Profile Complete'
    },
    {
      id: 'documents',
      title: 'Document Preparation',
      description: 'Gather and prepare all required documents for your application',
      milestone: 'Documents Ready'
    },
    {
      id: 'submission',
      title: 'Application Submission',
      description: 'Complete and submit your visa application with professional review',
      milestone: 'Application Submitted'
    },
    {
      id: 'interview',
      title: 'Interview Preparation',
      description: 'Prepare for your visa interview with mock sessions and expert guidance',
      milestone: 'Interview Ready'
    },
    {
      id: 'approval',
      title: 'Visa Approval & Travel',
      description: 'Celebrate your approval and prepare for your journey',
      milestone: 'Visa Approved'
    }
  ];

  const currentStageIndex = getStageIndex(dashboardData.userProgress?.current_stage || 'onboarding');

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'}`}>
          Application Timeline
        </CardTitle>
        <div className={`${isMobile ? 'text-sm' : 'text-base'} text-muted-foreground`}>
          {dashboardData.progressPercentage}% Complete - {dashboardData.userProgress?.nextMilestone || 'Getting Started'}
        </div>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-6">
          {/* Overall Progress */}
          <div className="text-center">
            <Progress value={dashboardData.progressPercentage} className="w-full h-3" />
            <div className={`flex justify-between mt-1 ${isMobile ? 'text-xs' : 'text-sm'} text-muted-foreground`}>
              <span>{dashboardData.progressPercentage}%</span>
              <span>{dashboardData.userProgress?.estimatedTimeline || '6-8 months'}</span>
            </div>
          </div>

          {/* Timeline Stages */}
          <div className="space-y-4">
            {stages.map((stage, index) => {
              const isCompleted = index < currentStageIndex;
              const isCurrent = index === currentStageIndex;
              const isUpcoming = index > currentStageIndex;

              return (
                <div key={stage.id} className="flex gap-4">
                  <div className="flex flex-col items-center">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                      isCompleted ? 'bg-green-500 text-white' :
                      isCurrent ? 'bg-blue-500 text-white' :
                      'bg-gray-200 text-gray-500'
                    }`}>
                      {isCompleted ? <CheckCircle2 className="w-5 h-5" /> :
                       isCurrent ? <AlertCircle className="w-5 h-5" /> :
                       <Circle className="w-5 h-5" />}
                    </div>
                    {index < stages.length - 1 && (
                      <div className={`w-0.5 flex-1 my-2 ${
                        isCompleted ? 'bg-green-500' : 'bg-gray-200'
                      }`} />
                    )}
                  </div>

                  <div className={`flex-1 pb-4 ${isUpcoming ? 'opacity-50' : ''}`}>
                    <div className={`flex items-center justify-between mb-1 ${isMobile ? 'flex-col items-start gap-1' : ''}`}>
                      <h3 className={`font-semibold ${isMobile ? 'text-base' : 'text-lg'}`}>
                        {stage.title}
                      </h3>
                      {isCurrent && (
                        <Badge variant="outline" className={`bg-blue-50 ${isMobile ? 'text-xs' : 'text-sm'}`}>
                          In Progress
                        </Badge>
                      )}
                      {isCompleted && (
                        <Badge variant="outline" className={`bg-green-50 ${isMobile ? 'text-xs' : 'text-sm'}`}>
                          Completed
                        </Badge>
                      )}
                    </div>
                    <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'} mb-2`}>
                      {stage.description}
                    </p>
                    <p className={`font-medium ${isMobile ? 'text-sm' : 'text-base'}`}>
                      {stage.milestone}
                    </p>
                  </div>
                </div>
              );
            })}
          </div>

          {/* Next Milestone */}
          {dashboardData.userProgress?.nextMilestone && (
            <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
              <div className="flex items-start gap-3">
                <Clock className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <p className="font-medium text-blue-900">
                    Next Milestone
                  </p>
                  <p className="text-blue-700">
                    {dashboardData.userProgress.nextMilestone}
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

function getStageIndex(stageName: string): number {
  const stages = ['onboarding', 'documents', 'submission', 'interview', 'approval'];
  return Math.max(0, stages.indexOf(stageName));
}


FILE: src/components/dashboard/start-visa-journey-card.tsx
================================================================================

'use client';

import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Rocket, CheckCircle, Calendar, FileText, Target } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import { useState, useEffect } from 'react';

interface StartVisaJourneyCardProps {
  userId: string;
  userProfile?: any;
  userProgressSummary?: any;
  onStartJourney: () => Promise<void>;
}

export function StartVisaJourneyCard({ userId, userProfile, userProgressSummary, onStartJourney }: StartVisaJourneyCardProps) {
  const [isStarting, setIsStarting] = useState(false);
  const [realProgress, setRealProgress] = useState(0);

  useEffect(() => {
    calculateRealBaseline();
  }, [userId]);

  // CALCULATE REAL PROGRESS - Copy confidence meter approach
  const calculateRealBaseline = async () => {
    if (!userId) return;
    
    try {
      const supabase = createClient();
      
      const [
        { data: messages },
        { data: documents },
        { data: progress }
      ] = await Promise.all([
        supabase.from('messages').select('count').eq('user_id', userId).single(),
        supabase.from('user_documents').select('status').eq('user_id', userId),
        supabase.from('user_progress').select('progress_percentage').eq('user_id', userId).single()
      ]);

      // REAL calculation (not fake 25%)
      let baselineProgress = 0;
      
      // Profile completion (30% max)
      if (userProfile?.country) baselineProgress += 10;
      if (userProfile?.destination_country) baselineProgress += 10;
      if (userProfile?.visa_type) baselineProgress += 10;

      // Document uploads (35% max)
      const approvedDocs = documents?.filter(d => d.status === 'approved').length || 0;
      baselineProgress += Math.min(approvedDocs * 4.4, 35); // 8 docs max

      // Chat engagement (20% max)
      const messageCount = messages?.count || 0;
      if (messageCount >= 10) baselineProgress += 20;
      else if (messageCount >= 5) baselineProgress += 15;
      else if (messageCount >= 1) baselineProgress += 8;

      // Existing progress (15% max)
      baselineProgress += Math.min(progress?.progress_percentage || 0, 15);

      setRealProgress(Math.round(baselineProgress));
    } catch (error) {
      console.error('Error calculating real baseline:', error);
      setRealProgress(10); // Conservative fallback
    }
  };

  // Only show if KYC completed but journey not started
  const shouldShow = userProfile?.kyc_completed === true && !userProgressSummary?.journey_started;

  if (!shouldShow) return null;

  const handleStartJourney = async () => {
    setIsStarting(true);
    try {
      await onStartJourney();
      
      const supabase = createClient();
      
      // REAL progress in database (not 25%)
      await supabase.from('user_progress_summary').upsert({
        user_id: userId,
        journey_started: new Date().toISOString(),
        current_stage: 'planning',
        overall_progress: realProgress // <-- REAL DATA!
      });

      window.location.reload();
    } catch (error) {
      console.error('Error starting journey:', error);
    } finally {
      setIsStarting(false);
    }
  };

  return (
    <Card className="border-green-200 bg-green-50/50">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Target className="h-5 w-5 text-green-600" />
          Ready to Start Your Visa Journey?
        </CardTitle>
        <CardDescription>
          Current progress: {realProgress}% - Lock in your visa path
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {/* REAL Progress indicator */}
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className="bg-green-600 h-2 rounded-full transition-all duration-500" 
              style={{ width: `${realProgress}%` }}
            ></div>
          </div>

          {/* Completed Items */}
          <div className="space-y-2">
            <div className="flex items-center gap-2 text-sm">
              <CheckCircle className="h-4 w-4 text-green-600" />
              <span>Basic profile setup</span>
            </div>
            {userProfile?.country && userProfile?.destination_country && (
              <div className="flex items-center gap-2 text-sm">
                <CheckCircle className="h-4 w-4 text-green-600" />
                <span>Country selection: {userProfile.country} â†’ {userProfile.destination_country}</span>
              </div>
            )}
          </div>

          {/* What Unlocks */}
          <div className="bg-white p-3 rounded-lg border">
            <h4 className="font-medium text-sm mb-2">Starting your journey unlocks:</h4>
            <div className="space-y-1 text-sm text-gray-600">
              <div className="flex items-center gap-2">
                <FileText className="h-3 w-3" />
                <span>Proof of funds tracking (3 seasons)</span>
              </div>
              <div className="flex items-center gap-2">
                <FileText className="h-3 w-3" />
                <span>Document requirement seasons</span>
              </div>
              <div className="flex items-center gap-2">
                <Calendar className="h-3 w-3" />
                <span>Application timeline with deadlines</span>
              </div>
              <div className="flex items-center gap-2">
                <Target className="h-3 w-3" />
                <span>Season-based progress tracking</span>
              </div>
            </div>
          </div>

          {/* Start Button with REAL percentage */}
          <Button 
            onClick={handleStartJourney}
            disabled={isStarting}
            className="w-full bg-green-600 hover:bg-green-700"
          >
            <Rocket className="mr-2 h-4 w-4" />
            {isStarting ? "Starting Journey..." : `Start Journey (${realProgress}% Complete)`}
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}


FILE: src/components/dashboard/document-checker-card.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { FileText, CheckCircle, Clock, AlertCircle, Upload } from 'lucide-react';
import Link from 'next/link';
import { useIsMobile } from '@/hooks/use-mobile';

interface DocumentCheckerCardProps {
  className?: string;
}

export function DocumentCheckerCard({ className }: DocumentCheckerCardProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData('');

  if (dashboardData.loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <div className="h-6 bg-gray-200 rounded w-48 animate-pulse" />
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            <div className="h-4 bg-gray-200 rounded animate-pulse" />
            <div className="h-4 bg-gray-200 rounded w-5/6 animate-pulse" />
            <div className="h-10 bg-gray-200 rounded w-full animate-pulse" />
          </div>
        </CardContent>
      </Card>
    );
  }

  if (dashboardData.error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8 text-red-500">
          Error loading document data
        </CardContent>
      </Card>
    );
  }

  const documentPercentage = dashboardData.documentCount > 0 ? (dashboardData.documentCount / 8) * 100 : 0;
  const hasDocuments = dashboardData.documentCount > 0;

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
          <FileText className="w-5 h-5" />
          AI Document Check
        </CardTitle>
        <CardDescription className={`${isMobile ? 'text-sm' : 'text-base'}`}>
          Upload documents for AI compliance checking
        </CardDescription>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-4">
          {/* Stats Overview - DYNAMIC VALUES */}
          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <div className={`${isMobile ? 'text-2xl' : 'text-3xl'} font-bold`}>
                {dashboardData.documentCount}
              </div>
              <div className={`${isMobile ? 'text-xs' : 'text-sm'} text-muted-foreground`}>
                Uploaded
              </div>
            </div>
            <div>
              <div className={`${isMobile ? 'text-2xl' : 'text-3xl'} font-bold text-green-600`}>
                {dashboardData.approvedDocuments}
              </div>
              <div className={`${isMobile ? 'text-xs' : 'text-sm'} text-muted-foreground`}>
                Approved
              </div>
            </div>
            <div>
              <div className={`${isMobile ? 'text-2xl' : 'text-3xl'} font-bold`}>
                {8 - dashboardData.documentCount}
              </div>
              <div className={`${isMobile ? 'text-xs' : 'text-sm'} text-muted-foreground`}>
                Remaining
              </div>
            </div>
          </div>

          {/* Progress Bar - DYNAMIC VALUE */}
          <div>
            <div className="flex justify-between text-sm mb-1">
              <span className="font-medium">Overall Progress</span>
              <span className="text-muted-foreground">{Math.round(documentPercentage)}%</span>
            </div>
            <Progress value={documentPercentage} className="w-full h-2" />
          </div>

          {/* Document Status - DYNAMIC VALUES */}
          {hasDocuments ? (
            <div className="space-y-2 max-h-48 overflow-y-auto">
              {dashboardData.documents.slice(0, 5).map((doc: any) => (
                <div 
                  key={doc.id} 
                  className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
                >
                  <div className="flex items-center gap-3">
                    <FileText className="w-4 h-4 text-gray-500" />
                    <div>
                      <p className={`font-medium ${isMobile ? 'text-sm' : 'text-base'}`}>
                        {doc.document_type || 'Document'}
                      </p>
                      <p className={`text-muted-foreground ${isMobile ? 'text-xs' : 'text-sm'}`}>
                        {new Date(doc.created_at).toLocaleDateString()}
                      </p>
                    </div>
                  </div>
                  <Badge variant="outline" className={`${
                    doc.status === 'approved' ? 'bg-green-50 text-green-700' :
                    doc.status === 'rejected' ? 'bg-red-50 text-red-700' :
                    'bg-yellow-50 text-yellow-700'
                  }`}>
                    {doc.status || 'pending'}
                  </Badge>
                </div>
              ))}
              {dashboardData.documentCount > 5 && (
                <p className="text-center text-muted-foreground text-sm">
                  +{dashboardData.documentCount - 5} more documents
                </p>
              )}
            </div>
          ) : (
            <div className="text-center py-6">
              <Upload className="w-12 h-12 text-gray-400 mx-auto mb-3" />
              <h3 className={`font-semibold ${isMobile ? 'text-base' : 'text-lg'} mb-2`}>
                No Documents Yet
              </h3>
              <p className={`text-muted-foreground ${isMobile ? 'text-sm' : 'text-base'}`}>
                Upload your first document to get AI-powered compliance checking
              </p>
            </div>
          )}

          {/* Action Button - DYNAMIC LABEL */}
          <Button asChild className="w-full" size={isMobile ? "lg" : "default"}>
            <Link href="/document-check">
              {hasDocuments ? 'Check More Documents' : 'Upload First Document'}
            </Link>
          </Button>

          {/* Last Check Info - DYNAMIC VALUE */}
          {hasDocuments && (
            <div className="flex items-center justify-center gap-2 text-muted-foreground">
              <Clock className="w-4 h-4" />
              <span className={`${isMobile ? 'text-xs' : 'text-sm'}`}>
                Last check: {getLastCheckTime(dashboardData.documents)}
              </span>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

function getLastCheckTime(documents: any[]): string {
  if (!documents.length) return 'Never';
  const latest = documents.reduce((latest, doc) => 
    new Date(doc.updated_at || doc.created_at) > new Date(latest.updated_at || latest.created_at) ? doc : latest
  );
  return new Date(latest.updated_at || latest.created_at).toLocaleDateString();
}


FILE: src/components/dashboard/enhanced-profile-card.tsx
================================================================================

'use client';

import { useDashboardData } from '@/hooks/use-dashboard-data';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { User, MapPin, Calendar, Flag, FileText, CheckCircle, AlertCircle } from 'lucide-react';
import Link from 'next/link';
import { useIsMobile } from '@/hooks/use-mobile';

interface EnhancedProfileCardProps {
  className?: string;
  onProfileUpdate?: () => void;
}

export function EnhancedProfileCard({ className, onProfileUpdate }: EnhancedProfileCardProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData('');
  
  // Profile completeness calculation - DYNAMIC
  const requiredFields = ['country', 'destination_country', 'visa_type', 'age'];
  const filledFields = requiredFields.filter(field => dashboardData.userProfile?.[field]).length;
  const profileComplete = (filledFields / requiredFields.length) * 100;

  if (dashboardData.loading) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardHeader>
          <div className="h-6 bg-gray-200 rounded w-48 animate-pulse" />
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {[...Array(4)].map((_, i) => (
              <div key={i} className="flex justify-between">
                <div className="h-4 bg-gray-200 rounded w-32 animate-pulse" />
                <div className="h-4 bg-gray-200 rounded w-24 animate-pulse" />
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (dashboardData.error) {
    return (
      <Card className={`${className} ${isMobile ? 'p-4' : 'p-6'}`}>
        <CardContent className="text-center py-8 text-red-500">
          Error loading profile data
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className={`${className} ${isMobile ? 'shadow-sm' : 'shadow-lg'}`}>
      <CardHeader className={`${isMobile ? 'p-4' : 'p-6'}`}>
        <CardTitle className={`${isMobile ? 'text-lg' : 'text-xl'} flex items-center gap-2`}>
          <User className="w-5 h-5" />
          Your Profile Progress
        </CardTitle>
        <div className={`flex justify-between items-center ${isMobile ? 'text-sm' : 'text-base'}`}>
          <span className="text-muted-foreground">Overall Progress</span>
          <Badge variant="outline" className="bg-blue-50">
            {Math.round(profileComplete)}%
          </Badge>
        </div>
      </CardHeader>
      <CardContent className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
        <div className="space-y-4">
          {/* Progress Bar - DYNAMIC VALUE */}
          <Progress value={profileComplete} className="w-full h-2" />

          {/* Profile Fields - DYNAMIC VALUES */}
          <div className="space-y-3">
            <ProfileItem
              icon={<MapPin className="w-4 h-4" />}
              label="Current Country"
              value={dashboardData.userProfile?.country || 'Not set'}
              isComplete={!!dashboardData.userProfile?.country}
              isMobile={isMobile}
            />
            <ProfileItem
              icon={<Flag className="w-4 h-4" />}
              label="Destination"
              value={dashboardData.userProfile?.destination_country || 'Not set'}
              isComplete={!!dashboardData.userProfile?.destination_country}
              isMobile={isMobile}
            />
            <ProfileItem
              icon={<FileText className="w-4 h-4" />}
              label="Visa Type"
              value={dashboardData.userProfile?.visa_type || 'Not set'}
              isComplete={!!dashboardData.userProfile?.visa_type}
              isMobile={isMobile}
            />
            <ProfileItem
              icon={<Calendar className="w-4 h-4" />}
              label="Age"
              value={dashboardData.userProfile?.age ? `${dashboardData.userProfile.age} years` : 'Not set'}
              isComplete={!!dashboardData.userProfile?.age}
              isMobile={isMobile}
            />
          </div>

          {/* Completion Status - DYNAMIC */}
          {profileComplete === 100 ? (
            <div className="p-4 bg-green-50 rounded-lg border border-green-200">
              <div className="flex items-center gap-3">
                <CheckCircle className="w-5 h-5 text-green-600" />
                <div>
                  <p className="font-medium text-green-900">Profile Complete!</p>
                  <p className="text-green-700 text-sm">
                    All required information has been provided
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
              <div className="flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
                <div>
                  <p className="font-medium text-yellow-900">
                    {requiredFields.length - filledFields} fields remaining
                  </p>
                  <p className="text-yellow-700 text-sm">
                    Complete your profile to unlock personalized features
                  </p>
                </div>
              </div>
            </div>
          )}

          <Button asChild className="w-full" onClick={onProfileUpdate}>
            <Link href="/profile">
              {profileComplete === 100 ? 'View Profile' : 'Edit Profile'}
            </Link>
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}

function ProfileItem({ 
  icon, 
  label, 
  value, 
  isComplete,
  isMobile 
}: { 
  icon: React.ReactNode; 
  label: string; 
  value: string;
  isComplete: boolean;
  isMobile: boolean;
}) {
  return (
    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
      <div className="flex items-center gap-3">
        {icon}
        <span className={`font-medium ${isMobile ? 'text-sm' : 'text-base'}`}>{label}</span>
      </div>
      <div className="flex items-center gap-2">
        <span className={`${isMobile ? 'text-sm' : 'text-base'} ${value === 'Not set' ? 'text-muted-foreground' : 'text-gray-900'}`}>
          {value}
        </span>
        {isComplete ? (
          <CheckCircle className="w-4 h-4 text-green-500" />
        ) : (
          <AlertCircle className="w-4 h-4 text-yellow-500" />
        )}
      </div>
    </div>
  );
}


FILE: src/app/dashboard/client.tsx
================================================================================

'use client';

import { EnhancedProfileCard } from '@/components/dashboard/enhanced-profile-card';
import { ConfidenceMeter } from '@/components/dashboard/confidence-meter';
import { QuickStats } from '@/components/dashboard/quick-stats';
import { ActionItemsWidgetFixed } from '@/components/dashboard/action-items-widget-fixed';
import { NextBestAction } from '@/components/dashboard/next-best-action';
import { ApplicationTimeline } from '@/components/dashboard/application-timeline';
import { StartVisaJourneyCard } from '@/components/dashboard/start-visa-journey-card';
import { VisaAssistantCard } from '@/components/dashboard/visa-assistant-card';
import { DocumentCheckerCard } from '@/components/dashboard/document-checker-card';
import { POFSeasoningTracker } from '@/components/dashboard/pof-seasoning-tracker';
import { InsightsCard } from "@/components/dashboard/insights-card";
import { DocumentAIAnalysis } from '@/components/dashboard/document-ai-analysis';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { MessageCircleQuestion, Map, Users, TrendingUp, Shield, Clock, Target, ArrowRight, AlertTriangle } from 'lucide-react';
import Link from 'next/link';
import { useIsMobile } from '@/hooks/use-mobile';
import { useDashboardData } from '@/hooks/use-dashboard-data';
import { createClient } from '@/lib/supabase/client';

interface DashboardClientProps {
  user: any;
  userProfile?: any;
}

// Tool cards - ONLY WORKING TOOLS (3 total)
const features = [
  {
    icon: MessageCircleQuestion,
    title: 'AI Mock Interview',
    description: 'Practice with realistic questions. Upgrade to human expert feedback for personalized coaching.',
    href: '/interview',
    cta: 'Start Practicing',
    expert: true,
    expertText: 'Get human feedback'
  },
  {
    icon: Map,
    title: 'Visa Journey Tracker',
    description: 'See your detailed timeline. Connect with experts if you get stuck at any step.',
    href: '/progress',
    cta: 'View Journey',
    expert: false
  },
  {
    icon: Users,
    title: 'Human Expert Help',
    description: 'Stuck? Get 1-on-1 guidance from verified visa consultants with proven success records.',
    href: '/experts',
    cta: 'Find Experts',
    expert: true,
    highlight: true
  },
];

export default function DashboardClientFinal({ user, userProfile }: DashboardClientProps) {
  const isMobile = useIsMobile();
  const dashboardData = useDashboardData(user?.id, userProfile);

  if (dashboardData.loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p>Loading your dashboard...</p>
        </div>
      </div>
    );
  }

  if (dashboardData.error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center text-red-500">
          <AlertTriangle className="w-12 h-12 mx-auto mb-3" />
          <p>Error loading dashboard: {dashboardData.error}</p>
          <Button onClick={() => window.location.reload()} className="mt-4">
            Try Again
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className={`space-y-8 ${isMobile ? 'p-4' : ''}`}>
      {/* Header - Responsive */}
      <header className="space-y-2">
        <h1 className={`${isMobile ? 'text-2xl' : 'text-4xl'} font-bold tracking-tight`}>
          {dashboardData.userProfile?.destination_country 
            ? `Your Visa Journey to ${dashboardData.userProfile.destination_country}`
            : `Welcome back, ${user?.email?.split('@')[0] || 'Traveler'}! ðŸ‘‹`
          }
        </h1>
        <p className={`${isMobile ? 'text-base' : 'text-lg'} text-muted-foreground`}>
          Your personalized AI guide to visa success. Here's your journey at a glance.
        </p>
      </header>

      {/* ðŸŽ APPLE HEALTH RINGS - Hero Component */}
      <QuickStats className="w-full" />

      {/* ðŸ”® INSIGHTS CARD - AI Predictions based on real data */}
      <InsightsCard className="w-full" />

      {/* NEW: ACTION ITEMS WIDGET - Real-time task extraction */}
      <ActionItemsWidgetFixed userId={user.id} className="w-full" />

      {/* ðŸŽ¯ SMART TOOLS GRID - Apple-style layout */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <VisaAssistantCard 
          userId={user.id} 
          userProfile={dashboardData.userProfile} 
        />
        <NextBestAction className="w-full" />
      </div>

      {/* ðŸŒ POF SEASONING TRACKER - Progressive unlocking */}
      <POFSeasoningTracker 
        userId={user.id} 
        userProfile={dashboardData.userProfile} 
        className="w-full" 
      />

      {/* ðŸ“„ DOCUMENT AI ANALYSIS - Intelligent compliance */}
      <DocumentAIAnalysis 
        userId={user.id} 
        className="w-full" 
      />

      {/* CONFIDENCE METER & APPLICATION TIMELINE */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <ConfidenceMeter className="w-full" />
        <ApplicationTimeline className="w-full" />
      </div>

      {/* JOURNEY LOCK-IN & DOCUMENT CHECKER */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        <StartVisaJourneyCard 
          userId={user.id} 
          userProfile={dashboardData.userProfile}
          onStartJourney={async () => {
            const supabase = createClient();
            await supabase.from('user_progress_summary').upsert({
              user_id: user.id,
              journey_started: new Date().toISOString(),
              current_stage: 'planning',
              overall_progress: 25
            });
          }}
        />
        <DocumentCheckerCard className="w-full" />
      </div>

      {/* PROFILE CARD */}
      <EnhancedProfileCard 
        onProfileUpdate={() => window.location.reload()} 
      />

      {/* ENHANCED FEATURES GRID - Simplified */}
      <div className={`grid ${isMobile ? 'grid-cols-1 gap-4' : 'md:grid-cols-2'} gap-6`}>
        {features.map((feature) => (
          <Card 
            key={feature.title} 
            className={`flex flex-col group hover:border-primary transition-all ${
              feature.highlight ? 'border-2 border-orange-300 bg-orange-50' : ''
            }`}
          >
            <CardHeader className="flex-1">
              <div className="flex items-start gap-4">
                <div className={`p-3 rounded-full transition-colors ${
                  feature.highlight 
                    ? 'bg-orange-100 text-orange-600' 
                    : 'bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground'
                }`}>
                  <feature.icon className="w-7 h-7" />
                </div>
                <div className='flex-1'>
                  <div className="flex items-center gap-2 mb-1">
                    <CardTitle className={`${isMobile ? 'text-base' : 'text-xl'}`}>{feature.title}</CardTitle>
                    {feature.expert && (
                      <Badge variant="outline" className={`${isMobile ? 'text-xs' : 'text-xs'} bg-blue-50`}>
                        <Shield className="w-3 h-3 mr-1" />
                        Expert Available
                      </Badge>
                    )}
                  </div>
                  <CardDescription className={`${isMobile ? 'text-sm' : 'text-base'}`}>{feature.description}</CardDescription>
                </div>
              </div>
            </CardHeader>
            <div className={`${isMobile ? 'p-4' : 'p-6'} pt-0`}>
              <Button asChild className={`w-full transition-colors ${
                feature.highlight 
                  ? 'bg-orange-500 hover:bg-orange-600' 
                  : 'group-hover:bg-amber-400'
              }`}>
                <Link href={feature.href} className="flex items-center justify-center gap-2">
                  {feature.cta} <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
                </Link>
              </Button>
            </div>
          </Card>
        ))}
      </div>

      {/* URGENT ACTION CARD */}
      {dashboardData.userProfile?.daysToDeadline < 7 && (
        <Card className="border-red-200 bg-red-50">
          <CardHeader>
            <CardTitle className="text-red-800 flex items-center gap-2">
              <Clock className="w-5 h-5" />
              Urgent Action Needed
            </CardTitle>
            <CardDescription className="text-red-700">
              Your {dashboardData.userProfile.nextMilestone} deadline is in {dashboardData.userProfile.daysToDeadline} days.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex gap-4">
              <Button variant="outline" asChild>
                <Link href="/experts">
                  Get Expert Help
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}


