=== JAPA GENIE PROJECT AUDIT ===
Generated: Wed Jan 14 10:50:38 AM UTC 2026

=== 1. ALL PAGES ===
--- src/app/checkout/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter } from 'next/navigation';
import { useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Loader2 } from 'lucide-react';

const USD_TO_NGN_RATE = 1500;

function CheckoutContent() {
  const router = useRouter();
  const [plan, setPlan] = useState<any>(null);
  const [paymentMethod, setPaymentMethod] = useState('stripe');
  const [loading, setLoading] = useState(false);
  const searchParams = useSearchParams();

  useEffect(() => {
    // Try to get plan from URL params first
    const planParam = searchParams?.get('plan');
    if (planParam) {
      try {
        const decodedPlan = JSON.parse(decodeURIComponent(planParam));
        setPlan(decodedPlan);
        // Also save to localStorage as backup
        localStorage.setItem('selectedPlan', JSON.stringify(decodedPlan));
        return;
      } catch (error) {
        console.error('Error parsing plan from URL:', error);
      }
    }
    
    // Fallback to localStorage
    const saved = localStorage.getItem('selectedPlan');
    if (saved) {
      setPlan(JSON.parse(saved));
    }
  }, [searchParams]);

  const handlePayment = async () => {
    if (!plan) return;
    setLoading(true);

    try {
      const endpoint = paymentMethod === 'paystack' 
        ? '/api/paystack/create' 
        : '/api/create-checkout';

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: plan.name,
          price: plan.price,
          duration: plan.duration || plan.interval
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Payment failed');
      }

      const data = await response.json();
      
      // Show conversion info for Paystack
      if (paymentMethod === 'paystack' && data.ngnAmount) {
        console.log(`‚úÖ Converted: $${data.usdAmount} ‚Üí ‚Ç¶${data.ngnAmount.toLocaleString()}`);
      }
      
      // ‚úÖ KEEP for external payment URLs (Stripe/Paystack)
      // These MUST open in browser for payment processing
      window.location.href = data.url;
    } catch (error: any) {
      alert(error.message || 'Payment error. Please try again.');
      setLoading(false);
    }
  };

  if (!plan) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold mb-4">No Plan Selected</h2>
          {/* ‚úÖ FIXED: Use router.push for PWA compatibility */}
          <Button onClick={() => router.push('/pricing')}>
            Back to Plans
          </Button>
        </div>
      </div>
    );
  }

  const ngnPrice = plan.price * USD_TO_NGN_RATE;

  return (
    <div className="min-h-screen py-12 bg-gray-50">
      <div className="container mx-auto px-4 max-w-md">
        <Card>
          <CardHeader>
            <CardTitle>Checkout</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <p className="text-2xl font-bold">${plan.price} USD</p>
              <p className="text-sm text-gray-600">{plan.name}</p>
              {paymentMethod === 'paystack' && (
                <p className="text-sm text-blue-600 mt-1">
                  ‚âà ‚Ç¶{ngnPrice.toLocaleString()} NGN
                </p>
              )}
            </div>

            <RadioGroup value={paymentMethod} onValueChange={setPaymentMethod}>
              <div className="flex items-center space-x-2 border p-3 rounded">
                <RadioGroupItem value="stripe" id="stripe" />
                <label htmlFor="stripe" className="cursor-pointer flex-1">
                  <div>
                    <p className="font-medium">Stripe (International Cards)</p>
                    <p className="text-xs text-gray-500">Pay in USD</p>
                  </div>
                </label>
              </div>
              <div className="flex items-center space-x-2 border p-3 rounded">
                <RadioGroupItem value="paystack" id="paystack" />
                <label htmlFor="paystack" className="cursor-pointer flex-1">
                  <div>
                    <p className="font-medium">Paystack (Nigeria)</p>
                    <p className="text-xs text-gray-500">
                      Pay ‚Ç¶{ngnPrice.toLocaleString()} (@ ‚Ç¶{USD_TO_NGN_RATE}/$1)
                    </p>
                  </div>
                </label>
              </div>
            </RadioGroup>
          </CardContent>
          <CardFooter className="flex flex-col space-y-2">
            <Button onClick={handlePayment} disabled={loading} className="w-full">
              {loading ? (
                <>
                  <Loader2 className="animate-spin mr-2" /> Processing...
                </>
              ) : (
                `Pay ${paymentMethod === 'paystack' ? `‚Ç¶${ngnPrice.toLocaleString()}` : `$${plan.price}`}`
              )}
            </Button>
            {/* ‚úÖ FIXED: Use router.push for PWA compatibility */}
            <Button 
              variant="outline" 
              onClick={() => router.push('/pricing')}
              className="w-full"
            >
              Back to Plans
            </Button>
          </CardFooter>
        </Card>
      </div>
    </div>
  );
}

export default function CheckoutPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="animate-spin h-8 w-8" />
      </div>
    }>
      <CheckoutContent />
    </Suspense>
  );
}

--- src/app/talk-to-someone/page.tsx ---
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default function TalkToSomeone() {
  return (
    <section className="py-20 bg-white">
      <div className="container mx-auto px-4 max-w-3xl text-center">
        <h1 className="text-3xl md:text-4xl font-bold mb-6">
          Talk to Someone Like You
        </h1>
        <p className="text-xl text-gray-600 mb-8">
          Not another agent. Not another bot. 
          Just someone who‚Äôs been where you are ‚Äî ready to help.
        </p>

        <div className="bg-gray-50 rounded-xl p-8 border border-gray-100 mb-10">
          <div className="flex flex-col items-center space-y-4">
            <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className="w-8 h-8 text-white">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <div>
              <h2 className="text-xl font-semibold">Real Help. Real People.</h2>
              <p className="text-gray-600 mt-2">
                Connect with verified guides who‚Äôve walked this path ‚Äî 
                not salespeople, but supporters.
              </p>
            </div>
          </div>
        </div>

        <div className="space-y-4">
          <Button size="lg" className="w-full max-w-md" asChild>
            <Link href="/kyc">
              Start Chatting Now <span className="ml-2">üí¨</span>
            </Link>
          </Button>
          
          <p className="text-sm text-gray-500">
            Available 24/7 ‚Äî no wait times, no gatekeeping.
          </p>
        </div>
      </div>
    </section>
  );
}

--- src/app/admin/chats/page.tsx ---
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';

export default async function AdminChatsPage() {
  const supabase = await createClient();
  
  // Check if user is admin (you can implement proper admin check)
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/auth');
  }

  // Fetch all messages with user info
  const { data: messages, error } = await supabase
    .from('messages')
    .select(`
      *,
      user_profiles:user_id (
        id,
        country,
        destination_country,
        visa_type
      )
    `)
    .order('created_at', { ascending: false })
    .limit(100);

  if (error) {
    console.error('Error fetching messages:', error);
  }

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Chat History - All Users</h1>
      
      <div className="bg-white rounded-lg shadow border">
        <div className="p-4 border-b">
          <h2 className="text-xl font-semibold">Recent Messages ({messages?.length || 0})</h2>
        </div>
        
        <div className="divide-y">
          {messages?.map((message) => (
            <div key={message.id} className="p-4 hover:bg-gray-50">
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-2">
                  <span className={`px-2 py-1 rounded text-xs ${
                    message.role === 'user' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                  }`}>
                    {message.role === 'user' ? 'USER' : 'GENIE'}
                  </span>
                  <span className="text-sm text-gray-500">
                    {message.user_profiles ? 
                      `${message.user_profiles.country || 'No country'} ‚Üí ${message.user_profiles.destination_country || 'No destination'}` 
                      : 'No profile'
                    }
                  </span>
                </div>
                <span className="text-xs text-gray-400">
                  {new Date(message.created_at).toLocaleString()}
                </span>
              </div>
              
              <div className={`p-3 rounded ${
                message.role === 'user' ? 'bg-blue-50 border border-blue-100' : 'bg-green-50 border border-green-100'
              }`}>
                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
              </div>
            </div>
          ))}
        </div>

        {!messages?.length && (
          <div className="p-8 text-center text-gray-500">
            No messages found
          </div>
        )}
      </div>
    </div>
  );
}

--- src/app/eligibility-results/page.tsx ---
import { Suspense } from 'react';
import EligibilityResultsClient from './client';
import { Loader2 } from 'lucide-react';

export default function EligibilityResultsPage() {
  return (
    <div className="container py-12">
      <Suspense fallback={
        <div className="flex items-center justify-center min-h-[400px]">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
        </div>
      }>
        <EligibilityResultsClient />
      </Suspense>
    </div>
  );
}
--- src/app/how-it-works/page.tsx ---
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { UserPlus, FileInput, Sparkles, Plane, BarChart, Bot, CheckCircle, Users, ShieldCheck, Calculator, ChevronRight } from 'lucide-react';
import Link from 'next/link';

const steps = [
  {
    icon: UserPlus,
    title: '1. Tell Us About Yourself',
    description: 'Provide your background, intended destination, and budget. The more details you share, the more personalized your visa roadmap will be.',
  },
  {
    icon: Calculator,
    title: '2. Get Proof of Funds Plan',
    description: 'We calculate exactly how much money you need based on embassy policies and create a step-by-step plan for your financial documentation.',
  },
  {
    icon: Sparkles,
    title: '3. Get AI-Powered Insights',
    description: "Our AI, Japa Genie, analyzes your profile to generate personalized visa recommendations, cost estimates, and approval chances in seconds.",
  },
  {
    icon: BarChart,
    title: '4. Compare & Choose Your Path',
    description: 'Use our interactive dashboard to compare visa options. Sort by cost, processing time, or success rate to find the perfect fit for you.',
  },
  {
    icon: FileInput,
    title: '5. Check Your Documents',
    description: 'Upload your application documents, and our AI will scan them for errors, missing information, and formatting issues, helping prevent costly delays.',
  },
  {
    icon: Bot,
    title: '6. Ask Our AI Assistant',
    description: 'Have questions anytime? Our AI Chat Assistant is available 24/7 to provide instant answers about any part of the visa process.',
  },
  {
    icon: Users,
    title: '7. Get Human Expert Backup',
    description: 'For complex cases or when you need extra confidence, connect with our verified visa consultants for 1-on-1 guidance and document review.',
    highlight: true
  },
  {
    icon: Plane,
    title: '8. Apply with Confidence',
    description: 'With your personalized roadmap, verified documents, and expert support, you can submit your visa application with peace of mind. Your journey awaits!',
  },
];

export default function HowItWorksPage() {
  return (
    <div className="max-w-4xl mx-auto space-y-12">
      <header className="text-center space-y-4">
        <h1 className="text-4xl md:text-5xl font-bold tracking-tight">How Japa Genie Works</h1>
        <p className="text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto">
          From personalized recommendations to expert human guidance, we simplify every step of your visa application journey.
        </p>
      </header>

      <div className="space-y-8">
        {steps.map((step, index) => (
          <Card 
            key={index} 
            className={`transition-all hover:shadow-lg hover:border-primary/50 ${
              step.highlight ? 'border-2 border-orange-200 bg-orange-50/50' : ''
            }`}
          >
            <CardHeader className="flex flex-col md:flex-row items-start gap-6">
                <div className={`flex-shrink-0 p-4 rounded-full ${
                  step.highlight 
                    ? 'bg-orange-100 text-orange-600 border-2 border-orange-200' 
                    : 'bg-primary/10 text-primary'
                }`}>
                    <step.icon className="w-8 h-8" />
                </div>
                <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <CardTitle className="text-2xl">{step.title}</CardTitle>
                      {step.highlight && (
                        <span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full font-medium">
                          Expert Help Available
                        </span>
                      )}
                    </div>
                    <CardDescription className="mt-2 text-base">
                        {step.description}
                    </CardDescription>
                </div>
            </CardHeader>
          </Card>
        ))}
      </div>

      {/* Enhanced CTA Section */}
      <div className="text-center py-8">
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-8 border border-blue-100">
          <h2 className="text-3xl font-bold mb-4">Start Your Visa Journey Today</h2>
          <p className="text-muted-foreground mb-6 max-w-2xl mx-auto">
            Whether you need AI guidance or human expert support, Japa Genie has you covered. 
            Get personalized proof of funds calculations, document reviews, and interview coaching.
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
            {/* AI Assistant Button with Chevrons */}
            <div className="flex items-center gap-2">
              <div className="flex items-center">
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse" style={{ animationDelay: '0s' }} />
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse -ml-1.5" style={{ animationDelay: '0.2s' }} />
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse -ml-1.5" style={{ animationDelay: '0.4s' }} />
              </div>
              <Button asChild size="lg" className="bg-gradient-to-r from-amber-400 to-primary text-primary-foreground hover:shadow-lg transition-shadow">
                <Link href="/kyc">
                  Start with AI Assistant <Sparkles className="ml-2 w-4 h-4" />
                </Link>
              </Button>
            </div>

            {/* Human Experts Button with Chevrons */}
            <div className="flex items-center gap-2">
              <div className="flex items-center">
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse" style={{ animationDelay: '0s' }} />
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse -ml-1.5" style={{ animationDelay: '0.2s' }} />
                <ChevronRight className="w-5 h-5 text-primary animate-chevron-pulse -ml-1.5" style={{ animationDelay: '0.4s' }} />
              </div>
              <Button asChild size="lg" variant="outline" className="border-orange-200 text-orange-700 hover:bg-orange-50">
                <Link href="/experts">
                  Connect with Human Experts <Users className="ml-2 w-4 h-4" />
                </Link>
              </Button>
            </div>
          </div>
          <p className="text-sm text-muted-foreground mt-4">
            ‚úÖ Free AI assistance ‚Ä¢ ‚úÖ Verified experts ‚Ä¢ ‚úÖ Money-back guarantee
          </p>
        </div>
      </div>
    </div>
  );
}
--- src/app/rejection-reversal/page.tsx ---
import RejectionReversalClient from './client';

export default function RejectionReversalPage() {
  return (
    <div className="space-y-8">
      <header className="space-y-2 text-center max-w-3xl mx-auto">
        <h1 className="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-amber-400 to-primary bg-clip-text text-transparent">
          Don't Let a "No" Be the Final Answer
        </h1>
        <p className="text-lg text-muted-foreground">
          A visa rejection feels like the end of the road, but it's often a solvable puzzle. Our AI analyzes why you were rejected and creates a new strategy to turn your next application into a success.
        </p>
      </header>
      <RejectionReversalClient />
    </div>
  );
}

--- src/app/chat/page.tsx ---

// src/app/chat/page.tsx - FINAL FIX VERSION
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { createClient } from '@/lib/supabase/client';
import { WelcomeNameModal } from '@/components/onboarding/welcome-name-modal';
import ChatClient from './client';
import { useSearchParams } from 'next/navigation';

function ChatPageContent() {
  const { user, loading: authLoading } = useAuth();
  const [showModal, setShowModal] = useState(false);
  const [isCheckingProfile, setIsCheckingProfile] = useState(true);
  const [initialKycData, setInitialKycData] = useState(null);
  const supabase = createClient();
  const searchParams = useSearchParams();

  useEffect(() => {
    console.log('üîç ChatPageContent: Mounted. Checking for KYC data...');
    
    // Read from URL params once on component mount
    const country = searchParams.get('country');
    const destination = searchParams.get('destination');
    const age = searchParams.get('age');
    const visaType = searchParams.get('visaType');
    const sessionId = searchParams.get('sessionId');

    if (country && destination && age && visaType) {
      console.log('‚úÖ Found KYC data in URL params. Saving to sessionStorage...');
      
      const kycData = {
        country,
        destination,
        age,
        visaType,
        profession: searchParams.get('profession') || undefined,
        userType: searchParams.get('userType') || undefined,
        timelineUrgency: searchParams.get('timelineUrgency') || undefined,
      };
      
      sessionStorage.setItem('kycData', JSON.stringify(kycData));
      if (sessionId) {
        sessionStorage.setItem('kyc_session_id', sessionId);
      }
      
      setInitialKycData(kycData); // Pass data directly to client
      console.log('‚úÖ KYC data ready to be passed to ChatClient:', kycData);
    } else {
      console.log('‚ö†Ô∏è No KYC data found in URL. ChatClient will check sessionStorage.');
    }

    // This effect should only run once to grab initial URL params.
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    async function checkOnboarding() {
      if (authLoading || !user) {
        setIsCheckingProfile(false);
        return;
      }

      const onboardingComplete = localStorage.getItem('name_onboarding_complete');
      if (onboardingComplete === 'true') {
        setIsCheckingProfile(false);
        return;
      }

      try {
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('preferred_name')
          .eq('id', user.id)
          .single();

        if (!profile?.preferred_name) {
          setShowModal(true);
        } else {
          localStorage.setItem('name_onboarding_complete', 'true');
        }
      } catch (error) {
        console.error('Error checking profile for onboarding:', error);
      } finally {
        setIsCheckingProfile(false);
      }
    }

    checkOnboarding();
  }, [user, authLoading, supabase]);

  if (authLoading || isCheckingProfile) {
    return (
      <div className="flex items-center justify-center h-[calc(100vh-4rem)]">
        <div className="text-center">
          <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">Loading your chat...</p>
        </div>
      </div>
    );
  }

  return (
    <>
      {showModal && user && (
        <WelcomeNameModal user={user} onComplete={() => setShowModal(false)} />
      )}
      <ChatClient />
    </>
  );
}

export default function ChatPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    }>
      <ChatPageContent />
    </Suspense>
  );
}

--- src/app/public-proof-of-funds/page.tsx ---
// src/app/public-proof-of-funds/page.tsx - FIXED VERSION WITH REAL AI
"use client";

import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Calculator, CheckCircle, AlertTriangle, Lock, Sparkles, TrendingUp, Shield, Clock } from 'lucide-react';
import { useState } from 'react';
import Link from 'next/link';

const countryData = {
  'United States': { flag: 'üá∫üá∏', currency: 'USD' },
  'Canada': { flag: 'üá®üá¶', currency: 'CAD' },
  'United Kingdom': { flag: 'üá¨üáß', currency: 'GBP' },
  'Germany': { flag: 'üá©üá™', currency: 'EUR' },
  'Australia': { flag: 'üá¶üá∫', currency: 'AUD' },
  'France': { flag: 'üá´üá∑', currency: 'EUR' },
  'Netherlands': { flag: 'üá≥üá±', currency: 'EUR' },
  'Ireland': { flag: 'üáÆüá™', currency: 'EUR' },
  'New Zealand': { flag: 'üá≥üáø', currency: 'NZD' },
  'Singapore': { flag: 'üá∏üá¨', currency: 'SGD' },
  'Dubai (UAE)': { flag: 'üá¶üá™', currency: 'AED' },
  'Switzerland': { flag: 'üá®üá≠', currency: 'CHF' },
  'Spain': { flag: 'üá™üá∏', currency: 'EUR' },
  'Italy': { flag: 'üáÆüáπ', currency: 'EUR' },
  'Portugal': { flag: 'üáµüáπ', currency: 'EUR' },
  'Belgium': { flag: 'üáßüá™', currency: 'EUR' },
  'Sweden': { flag: 'üá∏üá™', currency: 'SEK' },
  'Norway': { flag: 'üá≥üá¥', currency: 'NOK' },
  'Denmark': { flag: 'üá©üá∞', currency: 'DKK' },
  'Finland': { flag: 'üá´üáÆ', currency: 'EUR' },
};

const visaTypes = [
  { value: 'student', label: 'üéì Student Visa' },
  { value: 'work', label: 'üíº Work Visa' },
  { value: 'visitor', label: '‚úàÔ∏è Visitor Visa' },
];

const familyOptions = [
  { value: 1, label: 'Just me (solo)' },
  { value: 2, label: 'Me + 1 family member' },
  { value: 3, label: 'Me + 2 family members' },
  { value: 4, label: 'Me + 3 family members' },
];

const trackPOFEvent = async (event: string, metadata?: any) => {
  try {
    await fetch('/api/analytics/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event,
        page: 'public-proof-of-funds',
        metadata: {
          ...metadata,
          timestamp: new Date().toISOString()
        }
      })
    });
  } catch (error) {
    console.log('üìä Analytics event failed (non-critical):', error);
  }
};

export default function PublicProofOfFunds() {
  const [selectedCountry, setSelectedCountry] = useState('');
  const [selectedVisa, setSelectedVisa] = useState('');
  const [selectedFamily, setSelectedFamily] = useState(1);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [results, setResults] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);

  const handleCountryChange = (country: string) => {
    setSelectedCountry(country);
    if (country) trackPOFEvent('country_selected', { country });
  };

  const handleVisaChange = (visa: string) => {
    setSelectedVisa(visa);
    if (visa) trackPOFEvent('visa_selected', { visaType: visa });
  };

  const handleFamilyChange = (family: number) => {
    setSelectedFamily(family);
    trackPOFEvent('family_updated', { familyMembers: family });
  };

  const analyzeRequirements = async () => {
    if (!selectedCountry || !selectedVisa) return;

    await trackPOFEvent('analysis_started', {
      country: selectedCountry,
      visaType: selectedVisa,
      familyMembers: selectedFamily
    });

    setIsAnalyzing(true);
    setError(null);

    try {
      // üî• REAL AI CALL - Using our new Groq-powered flow
      const response = await fetch('/api/analyze-pof', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetCountry: selectedCountry,
          visaType: selectedVisa,
          familyMembers: selectedFamily,
          accountData: {
            balance: 0, // Public tool - no account data yet
            currency: countryData[selectedCountry as keyof typeof countryData]?.currency || 'USD',
            accountAge: 0
          }
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Analysis failed');
      }

      const data = await response.json();
      
      // Transform API response to match our display format
      const transformedResults = {
        summary: {
          destinationCountry: selectedCountry,
          minimumAmountUSD: data.financial.totalRequired,
          minimumAmountNGN: Math.round(data.financial.totalRequired * 1600), // Rough conversion
          seasoningDays: data.financial.seasoningDays,
          familyMembers: selectedFamily
        },
        basicRequirements: data.requirements.map((req: any) => req.requirement),
        criticalWarnings: data.redFlags.slice(0, 2).map((flag: any) => ({
          title: flag.flag,
          description: flag.severity === 'critical' ? flag.recommendation : flag.flag
        })),
        hiddenIssuesCount: Math.max(data.redFlags.length - 2, 0) + 3, // Show some are hidden
        rejectionStats: {
          rate: '42%',
          year: '2024',
          topReason: 'Insufficient proof of genuine fund sourcing'
        }
      };

      setResults(transformedResults);
      
      await trackPOFEvent('analysis_completed', {
        country: selectedCountry,
        visaType: selectedVisa,
        hasWarnings: transformedResults.criticalWarnings.length > 0,
        warningCount: transformedResults.criticalWarnings.length
      });

    } catch (err: any) {
      console.error('Analysis error:', err);
      setError(err.message || 'Failed to analyze. Please try again.');
      
      await trackPOFEvent('analysis_failed', {
        country: selectedCountry,
        visaType: selectedVisa,
        error: err.message
      });
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleUpgradeClick = () => {
    trackPOFEvent('upgrade_clicked', {
      country: selectedCountry,
      visaType: selectedVisa,
      fromPage: 'public-proof-of-funds'
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
      <div className="container mx-auto px-4 max-w-6xl">
        <header className="text-center mb-16">
          <h1 className="text-4xl md:text-6xl font-bold tracking-tight bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-6">
            Proof of Funds Calculator
          </h1>
          <p className="text-xl text-gray-600 max-w-3xl mx-auto mb-8">
            Get AI-powered embassy requirements in 30 seconds. Stop guessing ‚Äî know exactly what you need.
          </p>
          
          <div className="flex flex-wrap justify-center gap-6 mb-8">
            <div className="flex items-center gap-2">
              <CheckCircle className="w-5 h-5 text-green-600" />
              <span className="text-sm font-medium">2,000+ Successful Applications</span>
            </div>
            <div className="flex items-center gap-2">
              <CheckCircle className="w-5 h-5 text-green-600" />
              <span className="text-sm font-medium">60+ Countries Covered</span>
            </div>
            <div className="flex items-center gap-2">
              <Shield className="w-5 h-5 text-green-600" />
              <span className="text-sm font-medium">AI-Powered Analysis</span>
            </div>
          </div>
        </header>

        <Card className="bg-gradient-to-r from-green-500 to-blue-600 text-white border-0 shadow-2xl mb-16">
          <CardHeader className="text-center">
            <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-6">
              <Calculator className="w-10 h-10" />
            </div>
            <CardTitle className="text-2xl mb-4">Get Your AI-Powered Analysis</CardTitle>
            <CardDescription className="text-white/90 mb-6 max-w-2xl mx-auto text-lg">
              Answer 3 questions. AI analyzes embassy requirements in real-time.
            </CardDescription>
            
            <div className="max-w-2xl mx-auto space-y-4 mb-8">
              <div className="text-left">
                <label className="text-white/80 text-sm font-medium mb-2 block">üéØ Target Country</label>
                <select 
                  value={selectedCountry} 
                  onChange={(e) => handleCountryChange(e.target.value)}
                  className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white focus:bg-white/20 focus:border-white/40 transition-all"
                >
                  <option value="" className="text-gray-900">Select your destination...</option>
                  {Object.entries(countryData).map(([name, data]) => (
                    <option key={name} value={name} className="text-gray-900">
                      {data.flag} {name}
                    </option>
                  ))}
                </select>
              </div>
              
              <div className="text-left">
                <label className="text-white/80 text-sm font-medium mb-2 block">üìù Visa Type</label>
                <select 
                  value={selectedVisa} 
                  onChange={(e) => handleVisaChange(e.target.value)}
                  className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white focus:bg-white/20 focus:border-white/40 transition-all"
                >
                  <option value="" className="text-gray-900">What's your visa goal?</option>
                  {visaTypes.map(visa => (
                    <option key={visa.value} value={visa.value} className="text-gray-900">
                      {visa.label}
                    </option>
                  ))}
                </select>
              </div>
              
              <div className="text-left">
                <label className="text-white/80 text-sm font-medium mb-2 block">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Members</label>
                <select 
                  value={selectedFamily} 
                  onChange={(e) => handleFamilyChange(Number(e.target.value))}
                  className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white focus:bg-white/20 focus:border-white/40 transition-all"
                >
                  {familyOptions.map(option => (
                    <option key={option.value} value={option.value} className="text-gray-900">
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <Button 
              size="lg" 
              className="bg-white text-green-600 hover:bg-gray-100 font-semibold text-lg py-6 px-8 shadow-lg"
              onClick={analyzeRequirements}
              disabled={!selectedCountry || !selectedVisa || isAnalyzing}
            >
              {isAnalyzing ? (
                <>‚è≥ AI Analyzing...</>
              ) : (
                <>ü§ñ Get AI Analysis</>
              )}
            </Button>

            {error && (
              <div className="mt-6 p-4 bg-red-500/20 rounded-lg border border-red-300">
                <p className="text-white font-semibold">‚ö†Ô∏è {error}</p>
              </div>
            )}
          </CardHeader>
        </Card>

        {results && !isAnalyzing && (
          <>
            <Card className="mb-8 border-2 border-green-200 shadow-xl">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <TrendingUp className="w-6 h-6 text-green-600" />
                  AI Analysis Results
                </CardTitle>
                <CardDescription>
                  Based on current {results.summary?.destinationCountry || selectedCountry} embassy requirements
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="grid md:grid-cols-3 gap-6 mb-6">
                  <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl text-center">
                    <div className="text-sm text-green-800 mb-2">Minimum Required</div>
                    <div className="text-3xl font-bold text-green-600">
                      ${results.summary?.minimumAmountUSD?.toLocaleString() || '0'}
                    </div>
                    <div className="text-sm text-green-700 mt-1">
                      ‚âà ‚Ç¶{results.summary?.minimumAmountNGN?.toLocaleString() || '0'}
                    </div>
                  </div>

                  <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl text-center">
                    <div className="text-sm text-blue-800 mb-2">Account Seasoning</div>
                    <div className="text-3xl font-bold text-blue-600">
                      {results.summary?.seasoningDays || 90} days
                    </div>
                    <div className="text-sm text-blue-700 mt-1">Minimum required</div>
                  </div>

                  <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl text-center">
                    <div className="text-sm text-purple-800 mb-2">Visa Type</div>
                    <div className="text-2xl font-bold text-purple-600">
                      {visaTypes.find(v => v.value === selectedVisa)?.label}
                    </div>
                    <div className="text-sm text-purple-700 mt-1">
                      {results.summary?.familyMembers || selectedFamily} {(results.summary?.familyMembers || selectedFamily) === 1 ? 'person' : 'people'}
                    </div>
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                  <h3 className="font-semibold text-blue-900 mb-3 flex items-center gap-2">
                    <CheckCircle className="w-5 h-5" />
                    Basic Requirements
                  </h3>
                  <ul className="space-y-2">
                    {(results.basicRequirements || []).slice(0, 5).map((req: string, i: number) => (
                      <li key={i} className="flex items-start gap-2 text-sm text-blue-800">
                        <CheckCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                        <span>{req}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="space-y-4">
                  <h3 className="font-semibold text-gray-900 flex items-center gap-2">
                    <AlertTriangle className="w-5 h-5 text-amber-600" />
                    Critical Warnings Detected
                  </h3>
                  
                  {(results.criticalWarnings || []).map((warning: any, i: number) => (
                    <div key={i} className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-amber-600 mt-0.5" />
                        <div>
                          <p className="font-semibold text-amber-900">{warning.title}</p>
                          <p className="text-sm text-amber-800 mt-1">{warning.description}</p>
                        </div>
                      </div>
                    </div>
                  ))}

                  <div className="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center relative overflow-hidden">
                    <div className="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                    <Lock className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                    <p className="font-semibold text-gray-700">
                      {results.hiddenIssuesCount || 5} more critical issues detected
                    </p>
                    <p className="text-sm text-gray-600 mt-1">
                      Upgrade to see full compliance analysis
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {results.rejectionStats && (
              <Card className="mb-8 bg-red-50 border-2 border-red-200">
                <CardContent className="pt-6">
                  <div className="flex items-start gap-4">
                    <div className="bg-red-100 p-3 rounded-full">
                      <AlertTriangle className="w-6 h-6 text-red-600" />
                    </div>
                    <div>
                      <h3 className="font-bold text-red-900 text-lg mb-2">
                        {results.rejectionStats.rate} Rejection Rate
                      </h3>
                      <p className="text-red-800">
                        <strong>{results.rejectionStats.rate}</strong> of Nigerian applicants were rejected for 
                        {' '}<strong>{results.summary?.destinationCountry || selectedCountry}</strong> visas in {results.rejectionStats.year}.
                      </p>
                      <p className="text-sm text-red-700 mt-2">
                        Top reason: {results.rejectionStats.topReason}
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}
          </>
        )}

        <Card className="border-2 border-amber-300 bg-gradient-to-br from-amber-50 to-orange-50">
          <CardHeader className="text-center">
            <div className="flex justify-center mb-4">
              <Sparkles className="w-12 h-12 text-amber-600" />
            </div>
            <CardTitle className="text-3xl mb-4">Upgrade for Full Analysis</CardTitle>
            <CardDescription className="text-lg text-gray-700">
              This free version shows basics. Premium unlocks AI document analysis, red flag detection, and embassy-ready reports.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="grid md:grid-cols-2 gap-6 mb-8">
              <div className="space-y-4">
                <h3 className="font-bold text-lg flex items-center gap-2">
                  <Lock className="w-5 h-5 text-red-500" />
                  Free Version (Current):
                </h3>
                <ul className="space-y-3 text-sm">
                  <li className="flex items-start gap-2 opacity-60">
                    <CheckCircle className="w-4 h-4 text-gray-400 mt-0.5" />
                    <span>Basic minimum amount calculation</span>
                  </li>
                  <li className="flex items-start gap-2 opacity-60">
                    <CheckCircle className="w-4 h-4 text-gray-400 mt-0.5" />
                    <span>Generic requirements list</span>
                  </li>
                  <li className="flex items-start gap-2 opacity-60">
                    <CheckCircle className="w-4 h-4 text-gray-400 mt-0.5" />
                    <span>2 critical warnings (partial)</span>
                  </li>
                  <li className="flex items-start gap-2 opacity-60">
                    <AlertTriangle className="w-4 h-4 text-red-500 mt-0.5" />
                    <span className="line-through">No document upload</span>
                  </li>
                  <li className="flex items-start gap-2 opacity-60">
                    <AlertTriangle className="w-4 h-4 text-red-500 mt-0.5" />
                    <span className="line-through">No AI statement analysis</span>
                  </li>
                  <li className="flex items-start gap-2 opacity-60">
                    <AlertTriangle className="w-4 h-4 text-red-500 mt-0.5" />
                    <span className="line-through">No compliance score</span>
                  </li>
                </ul>
              </div>

              <div className="space-y-4">
                <h3 className="font-bold text-lg flex items-center gap-2 text-green-700">
                  <CheckCircle className="w-5 h-5 text-green-600" />
                  Premium Features:
                </h3>
                <ul className="space-y-3 text-sm">
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">Upload & analyze bank statements (PDF/images)</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">AI detects ALL red flags (suspicious transactions)</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">Account-by-account breakdown</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">Compliance score (0-10) for your embassy</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">Professional PDF report generation</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="w-4 h-4 text-green-600 mt-0.5" />
                    <span className="font-semibold">Bank letter templates</span>
                  </li>
                </ul>
              </div>
            </div>

            <div className="text-center">
              <Link href="/pricing" onClick={handleUpgradeClick}>
                <Button size="lg" className="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-bold text-lg py-6 px-12 shadow-xl">
                  Unlock Full AI Analysis
                  <Sparkles className="w-5 h-5 ml-2" />
                </Button>
              </Link>
              <p className="text-sm text-gray-600 mt-4">Starting at $10 for 1 week access</p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
--- src/app/about-us/page.tsx ---

import { Button } from '@/components/ui/button';

export default function AboutUs() {
  return (
    <section className="py-20 bg-white">
      <div className="container mx-auto px-4 max-w-4xl">
        <div className="text-center mb-16">
          <h1 className="text-3xl md:text-4xl font-bold mb-6">
            Why Japa Genie Exists
          </h1>
          <p className="text-xl text-gray-600 max-w-2xl mx-auto">
            Built by Africans, for Africans ‚Äî because we've seen too many lose everything to fake promises.
          </p>
        </div>

        {/* The Real Problem Section */}
        <div className="bg-gray-50 rounded-xl p-8 border border-gray-100 mb-16">
          <h2 className="text-2xl font-bold mb-6 text-center">The Problem We Saw</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <ProblemCard 
              title="Bleeding Money"
              description="N150,000+ paid to 'agents' who disappear after taking payment"
              icon="üí∏"
            />
            <ProblemCard 
              title="Inadequate Information"
              description="'Just apply online' ‚Äî no guidance for African applicants"
              icon="‚ùì"
            />
            <ProblemCard 
              title="Generic Western Advice"
              description="Tips that work for Europeans but get Africans rejected"
              icon="üåç"
            />
          </div>

          <div className="mt-8 text-center">
            <p className="text-gray-600 italic max-w-2xl mx-auto">
              We've seen friends lose life savings, miss deadlines, and get rejected because they couldn't access the right information.
            </p>
          </div>
        </div>

        {/* Our Solution Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-20">
          <div>
            <h2 className="text-2xl font-bold mb-4">How We Fixed It</h2>
            <p className="text-gray-600 mb-4">
              Our team spent 18 months:
            </p>
            <ul className="space-y-3 mb-6">
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Interviewing 100+ successful African immigrants</span>
              </li>
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Documenting real embassy requirements (not guesswork)</span>
              </li>
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Building verification for real experts (no more scams)</span>
              </li>
            </ul>
            <p className="text-gray-600">
              Japa Genie exists so you never have to waste money or time like we saw so many do.
            </p>
          </div>
          
          <div className="bg-blue-50 rounded-xl p-6 border border-blue-100">
            <div className="flex flex-col items-center space-y-4">
              <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className="w-8 h-8 text-white">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div>
                <h3 className="text-xl font-semibold">Built for Us, by Us</h3>
                <p className="text-gray-600 mt-2">
                  Every feature was created after helping 100+ Africans get their visas.
                  No theory. Just what actually works.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* How We're Different - ENHANCED */}
        <div className="mb-16">
          <h2 className="text-2xl font-bold text-center mb-8">How We're Different</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <FeatureCard 
              title="No Fake Promises"
              description="We don't sell 'guaranteed visas' ‚Äî just real help for real applications. If your embassy rejects you, we'll help you understand why."
              icon="üõ°Ô∏è"
            />
            <FeatureCard 
              title="Price-Conscious"
              description="We know money is tight. Pay only what makes sense for your journey ‚Äî starting with 3 free wishes."
              icon="üí∞"
            />
            <FeatureCard 
              title="African-Centered"
              description="Visa advice that understands your context ‚Äî from document requirements to interview questions that actually get asked in African embassies."
              icon="üåç"
            />
          </div>
        </div>

        <div className="text-center">
          <Button size="lg" className="bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:opacity-90" asChild>
            <a href="/kyc">
              Start Your Journey <span className="ml-2">‚ú®</span>
            </a>
          </Button>
        </div>
      </div>
    </section>
  );
}

function ProblemCard({ title, description, icon }: { title: string, description: string, icon: string }) {
  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100 text-center">
      <div className="text-3xl mb-4">{icon}</div>
      <h3 className="text-xl font-bold mb-2">{title}</h3>
      <p className="text-gray-600">{description}</p>
    </div>
  );
}

function FeatureCard({ title, description, icon }: { title: string, description: string, icon: string }) {
  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
      <div className="text-3xl mb-4">{icon}</div>
      <h3 className="text-xl font-bold mb-2">{title}</h3>
      <p className="text-gray-600">{description}</p>
    </div>
  );
}

--- src/app/progress-map/page.tsx ---
import ProgressMapClient from './client';

export default function ProgressMapPage() {
  return <ProgressMapClient />;
}

--- src/app/chat.backup.20251006_003500/page.tsx ---
import ChatClient from './client';

export default function ChatPage() {
  return <ChatClient />;
}

--- src/app/where-youre-stuck/page.tsx ---
'use client';

import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';
import Link from 'next/link';

const stuckPoints = [
  {
    title: "Your visa got denied",
    description: "AI analyzes your rejection letter in 90 seconds to identify the exact reasons. For complex appeals, connect with immigration lawyers who specialize in reversals.",
    emoji: "üíî",
    cta: "Analyze my rejection",
    mobileCta: "Rejection Analysis",
    path: "/rejection-reversal",
  },
  {
    title: "You're overwhelmed by documents",
    description: "AI scans your documents for common red flags and missing items. Upgrade to document verification with immigration specialists if needed.",
    emoji: "üìë",
    cta: "Check my documents",
    mobileCta: "Document Check",
    path: "/document-check",
  },
  {
    title: "You don't know which country to choose",
    description: "Our AI matchmaker analyzes your profile and recommends countries with the highest approval odds for someone like you.",
    emoji: "üåç",
    cta: "Help me choose a country",
    mobileCta: "Country Match",
    path: "/visa-matchmaker",
  },
  {
    title: "You need step-by-step guidance",
    description: "Get a personalized roadmap with daily tasks, document checklists, and deadline reminders tailored to your specific visa type.",
    emoji: "üó∫Ô∏è",
    cta: "Guide me step-by-step",
    mobileCta: "Step-by-Step Guide",
    path: "/kyc",
  },
];

export default function WhereYoureStuck() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-blue-50">
      <div className="container mx-auto px-4 py-12">
        {/* Header */}
        <div className="text-center mb-12">
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Where are you stuck?
          </h1>
          <p className="text-gray-600 max-w-2xl mx-auto">
            Pick your biggest challenge. We'll show you exactly how Japa Genie can help.
          </p>
        </div>

        {/* Stuck Points Grid */}
        <div className="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
          {stuckPoints.map((point, index) => (
            <Card 
              key={index}
              className="mobile-card-btn cursor-pointer p-6 rounded-xl border hover:shadow-lg transition-all duration-300 hover:-translate-y-1"
            >
              <Link href={point.path} className="block h-full">
                <div className="flex items-start gap-4 mb-4">
                  <div className="text-3xl flex-shrink-0">{point.emoji}</div>
                  <div className="flex-grow">
                    <h3 className="font-bold text-lg text-gray-900 mb-2">
                      {point.title}
                    </h3>
                    <p className="text-gray-600 text-sm mb-6">
                      {point.description}
                    </p>
                  </div>
                </div>
                <Button 
                  className="w-full mobile-btn-fix bg-gradient-to-r from-blue-500 to-purple-600 text-white"
                >
                  <span className="hidden sm:inline">{point.cta}</span>
                  <span className="sm:hidden">{point.mobileCta}</span>
                  <ArrowRight className="ml-2 w-4 h-4" />
                </Button>
              </Link>
            </Card>
          ))}
        </div>

        {/* Bottom CTA */}
        <div className="text-center mt-12">
          <Card className="inline-block bg-gradient-to-r from-amber-400 to-orange-500 border-0">
            <div className="p-6 text-white">
              <h3 className="text-xl font-bold mb-2">Still not sure where to start?</h3>
              <p className="mb-4">Take our 2-minute visa assessment</p>
              <Button 
                asChild 
                className="bg-white text-amber-600 hover:bg-amber-50 mobile-btn-fix"
                size="lg"
              >
                <Link href="/visa-readiness-check">
                  Start Assessment
                </Link>
              </Button>
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
}

--- src/app/features/page.tsx ---
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { Target, BarChart, Clock, CheckCircle, Building2, Users, ArrowRight } from 'lucide-react';

const features = [
  {
    icon: Target,
    title: 'AI Visa Matchmaker',
    description: 'Get matched to countries with highest acceptance rates for YOUR specific profile, qualifications, and budget.',
    href: '/visa-matchmaker',
  },
  {
    icon: BarChart,
    title: 'Real-Time Success Rates',
    description: 'Live data on visa acceptance rates, processing times, and costs updated by our AI agents daily.',
    href: '/kyc',
  },
  {
    icon: Clock,
    title: 'Visual Progress Tracking',
    description: 'See exactly where you are in your journey with our interactive progress map. No more guessing.',
    href: '/progress-map',
  },
  {
    icon: CheckCircle,
    title: '24/7 AI Guidance',
    description: 'Get instant answers to your visa questions. No more waiting for consultants or outdated forums.',
    href: '/kyc',
  },
  {
    icon: Building2,
    title: 'Jobs in Demand',
    description: 'Discover which skills are most wanted in your target countries and how to position yourself.',
    href: '/kyc',
  },
  {
    icon: Users,
    title: 'Rejection Recovery',
    description: 'Been rejected before? Our AI analyzes why and creates a comeback strategy that works.',
    href: '/rejection-reversal',
  },
];

export default function FeaturesPage() {
  return (
    <div className="py-12 md:py-20">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8">
        <header className="text-center space-y-4 mb-12">
          <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-primary">
            Everything You Need to Succeed
          </h1>
          <p className="text-lg md:text-xl text-muted-foreground max-w-3xl mx-auto">
            Built specifically for African professionals who refuse to settle for rejection.
          </p>
        </header>

        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {features.map((feature, index) => (
            <Link href={feature.href} key={index} className="block group">
                <Card className="flex flex-col text-center items-center p-8 transition-all hover:shadow-xl hover:-translate-y-1 h-full">
                  <div className="mb-4 bg-primary/10 text-primary rounded-full p-3 group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
                    <feature.icon className="w-8 h-8" />
                  </div>
                  <CardHeader className="p-0">
                    <CardTitle className="text-xl mb-2">{feature.title}</CardTitle>
                    <CardDescription className="text-base">{feature.description}</CardDescription>
                  </CardHeader>
                </Card>
            </Link>
          ))}
        </div>

        <div className="text-center mt-16">
          <Button asChild size="lg" className="bg-gradient-to-r from-amber-400 to-primary text-primary-foreground hover:shadow-lg transition-shadow rounded-full px-10 py-6 text-lg font-bold">
            <Link href="/kyc">
              Get Answers Now <ArrowRight className="ml-2 w-5 h-5" />
            </Link>
          </Button>
        </div>
      </div>
    </div>
  );
}

--- src/app/progress/page.tsx ---
// src/app/progress/page.tsx - DYNAMIC VERSION
'use client';

import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { CheckCircle, FileText, Send, Clock, Plane, Loader2 } from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { createClient } from '@/lib/supabase/client';
import { useAuth } from '@/lib/AuthContext';

const allSteps = [
  {
    icon: FileText,
    title: 'Step 1: Document Gathering',
    description: 'Collect all necessary documents, such as your passport, photos, financial statements, and letters of invitation or employment.',
    key: 'documents_uploaded',
  },
  {
    icon: CheckCircle,
    title: 'Step 2: Application Completion',
    description: 'Fill out the visa application form accurately. Double-check all information before submission. Use our Document Checker for AI-powered verification.',
    key: 'documents_verified',
  },
  {
    icon: Send,
    title: 'Step 3: Submission',
    description: 'Submit your application and supporting documents to the embassy or consulate. This can often be done online or at a visa application center.',
    key: 'application_submitted',
  },
  {
    icon: Clock,
    title: 'Step 4: Waiting for Decision',
    description: 'The embassy/consulate will process your application. Processing times vary by visa type and country. You can track your status online.',
    key: 'decision_received',
  },
  {
    icon: Plane,
    title: 'Step 5: Visa Approval & Travel',
    description: 'Once approved, you will receive your visa. You can now make your travel arrangements.',
    key: 'travel_ready',
  },
];

const statusStyles = {
  completed: 'border-green-500/50 bg-green-500/10',
  active: 'border-primary/50 bg-primary/10',
  pending: 'border-border bg-card'
};

const iconStyles = {
  completed: 'text-green-500',
  active: 'text-primary',
  pending: 'text-muted-foreground'
};

const statusBadges = {
  completed: 'Completed',
  active: 'In Progress',
  pending: 'Not Started'
};

const statusBadgeVariants = {
  completed: 'default',
  active: 'secondary',
  pending: 'outline'
};

export default function ProgressPage() {
  const { user, loading: authLoading } = useAuth();
  const [progressData, setProgressData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const supabase = createClient();

  useEffect(() => {
    const fetchProgress = async () => {
      if (!user) {
        setLoading(false);
        return;
      }

      try {
        const { data, error } = await supabase
          .from('user_progress')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.error('Error fetching progress:', error);
        }

        setProgressData(data || {
          profile_completed: false,
          documents_uploaded: false,
          documents_verified: false,
          application_submitted: false,
          decision_received: false,
          travel_ready: false,
        });
      } catch (error) {
        console.error('Error:', error);
      } finally {
        setLoading(false);
      }
    };

    if (!authLoading) {
      fetchProgress();
    }
  }, [user, authLoading]);

  // Calculate progress steps with real data
  const progressSteps = allSteps.map((step, index) => {
    const isCompleted = progressData?.[step.key] || false;
    const previousCompleted = index === 0 ? true : (progressData?.[allSteps[index - 1].key] || false);
    
    let status: 'completed' | 'active' | 'pending';
    if (isCompleted) {
      status = 'completed';
    } else if (previousCompleted && !isCompleted) {
      status = 'active';
    } else {
      status = 'pending';
    }

    return {
      ...step,
      status,
    };
  });

  const completedSteps = progressSteps.filter(step => step.status === 'completed').length;
  const progressPercentage = (completedSteps / progressSteps.length) * 100;

  if (authLoading || loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!user) {
    return (
      <div className="space-y-8">
        <header className="space-y-2">
          <h1 className="text-4xl font-bold tracking-tight">Visa Application Journey</h1>
          <p className="text-lg text-muted-foreground">
            Sign in to track your personalized visa application progress.
          </p>
        </header>
        <Card>
          <CardHeader>
            <CardTitle>Sign In Required</CardTitle>
            <CardDescription>
              Please sign in to view your visa application progress and track your journey.
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-8">
      <header className="space-y-2">
        <h1 className="text-4xl font-bold tracking-tight">Visa Application Journey</h1>
        <p className="text-lg text-muted-foreground">
          Follow these steps to navigate your visa application process successfully.
        </p>
      </header>

      <Card>
        <CardHeader>
          <div className="flex justify-between items-center mb-2">
            <CardTitle className="text-xl">Your Progress</CardTitle>
            <p className="text-lg font-bold text-primary">{Math.round(progressPercentage)}% Complete</p>
          </div>
          <Progress value={progressPercentage} className="w-full" />
        </CardHeader>
      </Card>

      <div className="relative space-y-8">
        <div className="absolute left-6 top-6 bottom-6 w-0.5 bg-border -z-10 md:left-8"></div>
        {progressSteps.map((step, index) => (
          <div key={index} className="flex items-start gap-4 md:gap-8">
            <div className={`flex items-center justify-center rounded-full size-12 shrink-0 ${statusStyles[step.status]}`}>
              <step.icon className={`w-6 h-6 ${iconStyles[step.status]}`} />
            </div>
            <Card className={`flex-1 ${statusStyles[step.status]}`}>
              <CardHeader>
                <div className="flex flex-col sm:flex-row justify-between sm:items-center">
                  <CardTitle>{step.title}</CardTitle>
                  <Badge 
                    variant={statusBadgeVariants[step.status] as "default" | "secondary" | "outline"} 
                    className="mt-2 sm:mt-0 max-w-fit"
                  >
                    {statusBadges[step.status]}
                  </Badge>
                </div>
                <CardDescription className="pt-2">{step.description}</CardDescription>
              </CardHeader>
            </Card>
          </div>
        ))}
      </div>
    </div>
  );
}

--- src/app/asylum/page.tsx ---
import { Button } from '@/components/ui/button';
import Link from 'next/link';

function BenefitCard({ title, description, icon }: { title: string, description: string, icon: string }) {
  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
      <div className="text-3xl mb-4">{icon}</div>
      <h3 className="text-xl font-bold mb-2">{title}</h3>
      <p className="text-gray-600">{description}</p>
    </div>
  );
}

function StepCard({ step, title, description }: { step: string, title: string, description: string }) {
  return (
    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
      <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mb-4">
        {step}
      </div>
      <h3 className="text-xl font-bold mb-2">{title}</h3>
      <p className="text-gray-600">{description}</p>
    </div>
  );
}

export default function AsylumPage() {
  return (
    <section className="py-20 bg-white">
      <div className="container mx-auto px-4 max-w-4xl">
        <div className="text-center mb-16">
          <h1 className="text-3xl md:text-4xl font-bold mb-6">
            Asylum & Refugee Protection Guidance
          </h1>
          <p className="text-xl text-gray-600 max-w-2xl mx-auto">
            Compassionate support for those seeking safety and protection. Your journey matters.
          </p>
        </div>

        {/* Understanding Asylum Section */}
        <div className="bg-blue-50 rounded-xl p-8 border border-blue-100 mb-16">
          <h2 className="text-2xl font-bold mb-6 text-center">Understanding Your Options</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <BenefitCard 
              title="Asylum Seeker Support"
              description="Guidance through the complex asylum application process with dignity and respect for your situation."
              icon="üïäÔ∏è"
            />
            <BenefitCard 
              title="Refugee Protection"
              description="Information about refugee status determination and your rights under international law."
              icon="üèõÔ∏è"
            />
          </div>
        </div>

        {/* How We Can Help Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center mb-20">
          <div>
            <h2 className="text-2xl font-bold mb-4">Compassionate Guidance</h2>
            <p className="text-gray-600 mb-4">
              We understand that seeking protection is one of the most difficult decisions anyone can make. Our approach is:
            </p>
            <ul className="space-y-3 mb-6">
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Confidential and respectful of your privacy</span>
              </li>
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Based on current international protection laws</span>
              </li>
              <li className="flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-green-500 mr-2 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
                <span>Focused on your safety and wellbeing</span>
              </li>
            </ul>
          </div>
          
          <div className="bg-green-50 rounded-xl p-6 border border-green-100">
            <div className="flex flex-col items-center space-y-4">
              <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                <span className="text-white text-2xl">ü§ù</span>
              </div>
              <div>
                <h3 className="text-xl font-semibold">Safe & Confidential</h3>
                <p className="text-gray-600 mt-2">
                  Your information is protected. We provide guidance while respecting the sensitive nature of your situation.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Process Steps */}
        <div className="mb-16">
          <h2 className="text-2xl font-bold text-center mb-8">Understanding the Process</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <StepCard 
              step="1"
              title="Initial Assessment"
              description="Understand your situation and determine if you may qualify for protection under international law."
            />
            <StepCard 
              step="2"
              title="Document Preparation"
              description="Guidance on gathering necessary evidence and preparing your application with care."
            />
            <StepCard 
              step="3"
              title="Professional Support"
              description="Connection to qualified legal professionals who specialize in asylum and refugee cases."
            />
          </div>
        </div>

        {/* Important Notice & Professional Help */}
        <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-8 border border-orange-200 mb-16">
          <div className="text-center mb-6">
            <h3 className="text-2xl font-bold mb-2">Professional Legal Assistance</h3>
            <p className="text-gray-600 mb-4">Asylum cases require specialized legal expertise. Let us connect you with qualified professionals.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div className="bg-white rounded-lg p-6 border border-gray-200">
              <div className="flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full mb-3 mx-auto">
                <span className="text-orange-600 text-xl">‚öñÔ∏è</span>
              </div>
              <h4 className="font-semibold text-center mb-2">Legal Expertise</h4>
              <p className="text-sm text-gray-600 text-center">Connect with lawyers specializing in asylum and refugee law who understand the complexities of protection cases</p>
            </div>

            <div className="bg-white rounded-lg p-6 border border-gray-200">
              <div className="flex items-center justify-center w-12 h-12 bg-orange-100 rounded-full mb-3 mx-auto">
                <span className="text-orange-600 text-xl">üí¨</span>
              </div>
              <h4 className="font-semibold text-center mb-2">Cultural Understanding</h4>
              <p className="text-sm text-gray-600 text-center">Professionals who respect your background and understand the unique challenges you may face</p>
            </div>
          </div>

          <div className="text-center space-y-4">
            <div>
              <Button 
                variant="default" 
                className="bg-gradient-to-r from-orange-500 to-red-600 text-white hover:opacity-90" 
                asChild
              >
                <Link href="/experts">Request Professional Assistance</Link>
              </Button>
              <p className="text-xs text-gray-500 mt-2">
                Free initial consultation to understand your options
              </p>
            </div>
            
            <div>
              <Button 
                variant="outline" 
                className="border-blue-500 text-blue-600 hover:bg-blue-50" 
                asChild
              >
                <Link href="/kyc">Get General Guidance First</Link>
              </Button>
              <p className="text-xs text-gray-500 mt-2">
                Start with our AI assistant for basic information
              </p>
            </div>
          </div>
        </div>

        {/* Final CTA */}
        <div className="text-center">
          <p className="text-gray-600 mb-4">
            You don't have to navigate this alone. We're here to help guide you with compassion and expertise.
          </p>
          <Button size="lg" className="bg-gradient-to-r from-green-500 to-blue-600 text-white hover:opacity-90" asChild>
            <Link href="/kyc">Begin Your Safe Journey <span className="ml-2">üïäÔ∏è</span></Link>
          </Button>
        </div>
      </div>
    </section>
  );
}

--- src/app/proof-of-funds/page.tsx ---
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Banknote, ShieldCheck, TrendingUp, HelpCircle } from 'lucide-react';
import Link from 'next/link';

export default function ProofOfFundsPage() {
  return (
    <div className="space-y-8">
      <header className="space-y-2 text-center max-w-3xl mx-auto">
        <h1 className="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-amber-400 to-primary bg-clip-text text-transparent">
          Master Your Proof of Funds
        </h1>
        <p className="text-lg text-muted-foreground">
          Your financial documents are critical. We provide trusted, embassy-compliant strategies to present your funds, ensuring your application is seen as low-risk and credible.
        </p>
      </header>
      
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <Card>
          <CardHeader>
            <div className="flex items-center gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <Banknote className="w-7 h-7" />
                </div>
                <div>
                    <CardTitle>Structuring Your Funds</CardTitle>
                    <CardDescription>Learn how to properly season funds and document large transactions to avoid suspicion.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
        <Card>
          <CardHeader>
              <div className="flex items-center gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <ShieldCheck className="w-7 h-7" />
                </div>
                <div>
                    <CardTitle>Verifiable Statements</CardTitle>
                    <CardDescription>We guide you on obtaining bank statements and letters that meet strict embassy standards for verification.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
        <Card>
          <CardHeader>
             <div className="flex items-center gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <TrendingUp className="w-7 h-7" />
                </div>
                <div>
                    <CardTitle>Sponsorship & Gifts</CardTitle>
                    <CardDescription>Correctly document financial support from family or sponsors with legally sound gift deeds and affidavits.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
      </div>

       <Card className="bg-primary/5 border-primary/20">
        <CardHeader className="text-center">
            <div className="w-16 h-16 bg-primary text-primary-foreground rounded-full flex items-center justify-center mx-auto mb-4">
                <HelpCircle className="w-8 h-8" />
            </div>
            <CardTitle>Confused About Your Financials?</CardTitle>
            <CardDescription className="max-w-xl mx-auto mb-4">
                Our AI assistant can analyze your specific situation and provide a personalized financial documentation strategy.
            </CardDescription>
            <Button asChild>
                <Link href="/kyc">Ask Japa Genie</Link>
            </Button>
        </CardHeader>
      </Card>
    </div>
  );
}
--- src/app/visa-rejection/page.tsx ---
'use client';

import { Card } from '@/components/ui/card';

export default function VisaRejectionPage() {
  return (
    <section className="py-20 bg-slate-900 text-slate-50">
      <div className="container mx-auto px-4 max-w-3xl">
        <Card className="p-8 bg-slate-800/50 border-slate-700">
          <h1 className="text-3xl font-bold mb-4 text-primary">Visa Rejection Reversal</h1>
          <p className="text-slate-300">
            Got a rejection letter? Don‚Äôt panic. JapaGenie specializes in structured appeals that 
            address the exact reasons for your denial ‚Äî turning ‚Äúno‚Äù into a second chance. 
            Learn how to boost your approval odds with tailored guidance.
          </p>
        </Card>
      </div>
    </section>
  );
}

--- src/app/visa-readiness-results/page.tsx ---
'use client';

import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { useEffect, useState } from 'react';
import { ArrowRight, AlertCircle, CheckCircle, TrendingUp } from 'lucide-react';
import { calculateVisaReadiness, type UserProfile, type RiskScoreResult } from '@/lib/visa-readiness-calculator';

export default function VisaReadinessResults() {
  const [results, setResults] = useState<RiskScoreResult | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const answersJson = localStorage.getItem('visaReadinessAnswers');
    if (answersJson) {
      const answers = JSON.parse(answersJson) as Partial<UserProfile>;
      
      // Fill in defaults for unanswered questions
      const completeProfile: UserProfile = {
        hasValidPassport: answers.hasValidPassport ?? false,
        allFormsCompleted: answers.allFormsCompleted ?? false,
        photosMeetRequirements: true,
        employmentHistoryConsistent: true,
        bankBalanceAdequate: answers.bankBalanceAdequate ?? false,
        fundsInOwnName: true,
        savingsDurationMonths: answers.savingsDurationMonths ?? 0,
        noLargeRecentDeposits: true,
        canUnderstandBasicInstructions: true,
        hasLanguageCertification: answers.hasLanguageCertification ?? false,
        hasPreviousVisas: answers.hasPreviousVisas ?? false,
        neverOverstayed: answers.neverOverstayed ?? true,
        returnedHomeAfterTrips: true,
        internationalTravelCount: answers.hasPreviousVisas ? 2 : 0,
        educationVerified: answers.educationVerified ?? false,
        workExperienceMatchesJob: answers.workExperienceMatchesJob ?? false,
        skillsInDemand: true,
        employmentGapsExplained: true,
        knowsCommonQuestions: true,
        practicedMockInterview: answers.practicedMockInterview ?? false,
        clearPurposeStatement: true,
        dependentsInHomeCountry: answers.dependentsInHomeCountry ?? false,
        propertyOwnership: answers.propertyOwnership ?? false,
        familyObligations: answers.dependentsInHomeCountry ?? false
      };

      const calculatedResults = calculateVisaReadiness(completeProfile);
      setResults(calculatedResults);
    }
    setLoading(false);
  }, []);

  if (loading || !results) {
    return (
      <section className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Analyzing your readiness...</p>
        </div>
      </section>
    );
  }

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getScoreBg = (score: number) => {
    if (score >= 80) return 'bg-green-100';
    if (score >= 60) return 'bg-yellow-100';
    return 'bg-red-100';
  };

  return (
    <section className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 py-20">
      <div className="container mx-auto px-4 max-w-4xl">
        {/* Score Display */}
        <Card className="p-8 md:p-12 text-center mb-8 bg-white/80 backdrop-blur-sm border-2 border-white/60 shadow-xl">
          <h1 className="text-2xl md:text-3xl font-bold mb-6">Your Visa Readiness Score</h1>
          
          <div className={`inline-block ${getScoreBg(results.totalScore)} rounded-full p-8 mb-6`}>
            <div className={`text-6xl font-bold ${getScoreColor(results.totalScore)}`}>
              {results.totalScore}
            </div>
            <div className="text-sm font-medium text-gray-600 mt-2">out of 100</div>
          </div>

          <div className="mb-6">
            <span className={`inline-block px-6 py-3 rounded-full text-lg font-semibold ${getScoreBg(results.totalScore)} ${getScoreColor(results.totalScore)}`}>
              {results.readinessLevel}
            </span>
          </div>

          <p className="text-gray-700 text-lg max-w-2xl mx-auto">
            {results.readinessLevel === 'Excellent' 
              ? "You're in excellent shape! Your application shows strong fundamentals across all areas."
              : results.readinessLevel === 'Good'
              ? "You're on the right track! Focus on strengthening a few key areas to maximize your chances."
              : "Your application needs improvement in several areas. The good news: we can help you fix them."}
          </p>
        </Card>

        {/* Top Weaknesses */}
        <Card className="p-8 mb-8 bg-white/80 backdrop-blur-sm border-2 border-white/60 shadow-xl">
          <div className="flex items-center gap-3 mb-6">
            <AlertCircle className="w-8 h-8 text-orange-600" />
            <h2 className="text-2xl font-bold">Your 3 Critical Weaknesses</h2>
          </div>

          <div className="space-y-4">
            {results.topWeaknesses.slice(0, 3).map((weakness, index) => (
              <div key={index} className="flex gap-4 p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                <div className="flex-shrink-0">
                  <div className="w-8 h-8 rounded-full bg-orange-500 text-white flex items-center justify-center font-bold">
                    {index + 1}
                  </div>
                </div>
                <p className="text-gray-700 flex-1">{weakness}</p>
              </div>
            ))}
          </div>
        </Card>

        {/* Detailed Breakdown */}
        <Card className="p-8 mb-8 bg-white/80 backdrop-blur-sm border-2 border-white/60 shadow-xl">
          <h2 className="text-2xl font-bold mb-6">Detailed Assessment</h2>
          
          <div className="space-y-6">
            {results.breakdown.map((category, index) => {
              const percentage = (category.score / category.maxScore) * 100;
              return (
                <div key={index}>
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold text-gray-700">{category.category}</span>
                    <span className={`font-bold ${getScoreColor(percentage)}`}>
                      {Math.round(percentage)}%
                    </span>
                  </div>
                  <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div 
                      className={`h-full ${percentage >= 80 ? 'bg-green-500' : percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}`}
                      style={{ width: `${percentage}%` }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </Card>

        {/* CTA */}
        <Card className="p-8 md:p-12 text-center bg-gradient-to-br from-purple-600 to-pink-600 text-white shadow-xl">
          <TrendingUp className="w-16 h-16 mx-auto mb-6" />
          <h2 className="text-3xl font-bold mb-4">Ready to Strengthen Your Application?</h2>
          <p className="text-lg mb-8 text-purple-100">
            Get personalized guidance from our AI assistant. Learn exactly how to fix your weaknesses and maximize your approval chances.
          </p>
          
          <Button 
            size="lg" 
            className="bg-white text-purple-600 hover:bg-purple-50 text-lg px-8 py-6"
            asChild
          >
            <a href="/kyc">
              Get Your Action Plan <ArrowRight className="ml-2 h-5 w-5" />
            </a>
          </Button>
          
          <p className="text-sm text-purple-200 mt-4">
            Join 2,847+ applicants who improved their readiness score
          </p>
        </Card>
      </div>
    </section>
  );
}

--- src/app/page.tsx ---
import { HeroSection } from '@/components/landing/hero-section';
import LandingClient from '@/components/landing/landing-client';

export default function Home() {
  return (
    <>
      <HeroSection />
      <LandingClient />
    </>
  );
}

--- src/app/visa-matchmaker/page.tsx ---
// src/app/visa-matchmaker/page.tsx - PRODUCTION READY VERSION
'use client';
import { useState, useCallback } from 'react';
import { Crown, Sparkles, CheckCircle, Loader2, X, Lock, ChevronDown, ChevronUp, Star, MapPin } from 'lucide-react';
import Link from 'next/link';

const QuickQuiz = ({ answers, updateAnswer, isLoading, getRealAIMatches }) => (
  <div className="max-w-2xl mx-auto space-y-8">
    <div className="text-center space-y-4">
      <div className="inline-flex items-center gap-2 px-4 py-2 bg-amber-500/10 rounded-full">
        <Sparkles className="w-4 h-4 text-amber-500" />
        <span className="text-sm font-medium text-amber-700">AI Visa Assessment</span>
      </div>
      <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-amber-400 to-blue-500 bg-clip-text text-transparent">
        Find Your Best Visa Match
      </h1>
      <p className="text-lg text-gray-600">
        Answer key questions for personalized AI analysis against global visa requirements.
      </p>
    </div>

    <div className="bg-white rounded-2xl shadow-xl p-8 space-y-6">
      {/* Age Range */}
      <div>
        <label className="block text-lg font-semibold mb-3">1. Age range? üéÇ</label>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
          {['18-24', '25-34', '35-44', '45-54', '55+'].map(age => (
            <button
              key={age}
              onClick={() => updateAnswer('age', age)}
              className={`p-4 rounded-xl border-2 transition-all ${
                answers.age === age ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300'
              }`}
            >
              <div className="font-medium">{age}</div>
            </button>
          ))}
        </div>
      </div>

      {/* Work Experience */}
      {answers.age && (
        <div>
          <label className="block text-lg font-semibold mb-3">2. Work experience? üíº</label>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            {['0-2', '3-5', '6-10', '10+'].map(exp => (
              <button
                key={exp}
                onClick={() => updateAnswer('experience', exp)}
                className={`p-4 rounded-xl border-2 transition-all ${
                  answers.experience === exp ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="font-medium">{exp} years</div>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* English Level */}
      {answers.experience && (
        <div>
          <label className="block text-lg font-semibold mb-3">3. English level? üó£Ô∏è</label>
          <div className="grid grid-cols-2 gap-3">
            {['Basic', 'Intermediate', 'Advanced', 'Native'].map(level => (
              <button
                key={level}
                onClick={() => updateAnswer('englishLevel', level)}
                className={`p-4 rounded-xl border-2 transition-all ${
                  answers.englishLevel === level ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="font-medium">{level}</div>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Profession */}
      {answers.englishLevel && (
        <div>
          <label className="block text-lg font-semibold mb-3">4. Profession? üíº</label>
          <input
            type="text"
            placeholder="Software Engineer, Nurse, Accountant"
            value={answers.profession}
            onChange={(e) => updateAnswer('profession', e.target.value)}
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
          />
        </div>
      )}

      {/* Education */}
      {answers.profession && (
        <div>
          <label className="block text-lg font-semibold mb-3">5. Education? üéì</label>
          <div className="grid grid-cols-2 gap-3">
            {['High School', 'Bachelors', 'Masters', 'PhD'].map(education => (
              <button
                key={education}
                onClick={() => updateAnswer('education', education)}
                className={`p-4 rounded-xl border-2 transition-all ${
                  answers.education === education ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="font-medium">{education}</div>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Goal */}
      {answers.education && (
        <div>
          <label className="block text-lg font-semibold mb-3">6. Primary goal? üéØ</label>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
            {['Study', 'Work', 'Business', 'Family', 'Tourism'].map(goal => (
              <button
                key={goal}
                onClick={() => updateAnswer('goal', goal)}
                className={`p-4 rounded-xl border-2 transition-all ${
                  answers.goal === goal ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-gray-200 hover:border-blue-300'
                }`}
              >
                <div className="font-medium">{goal}</div>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Submit */}
      {answers.goal && (
        <button
          onClick={() => getRealAIMatches(answers)}
          disabled={isLoading}
          className="w-full py-4 bg-gradient-to-r from-amber-500 to-blue-500 text-white rounded-xl font-bold text-lg hover:shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50"
        >
          {isLoading ? (
            <>
              <Loader2 className="w-5 h-5 animate-spin" />
              AI Analyzing Your Profile...
            </>
          ) : (
            <>
              Get AI-Powered Matches
              <Sparkles className="w-5 h-5" />
            </>
          )}
        </button>
      )}
    </div>
  </div>
);

export default function VisaMatchmakerReal() {
  const [step, setStep] = useState(1);
  const [answers, setAnswers] = useState({
    age: '', experience: '', englishLevel: '', profession: '', education: '', goal: ''
  });
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [aiResults, setAiResults] = useState<any>(null);
  const [isPremium, setIsPremium] = useState(false);
  const [expandedFeatures, setExpandedFeatures] = useState(false);

  const updateAnswer = useCallback((field: string, value: string) => {
    setAnswers(prev => ({ ...prev, [field]: value }));
  }, []);

  const getAgeFromRange = (ageRange: string) => ({
    '18-24': 21, '25-34': 29, '35-44': 39, '45-54': 49, '55+': 57
  }[ageRange] || 30);

  const getExperienceFromRange = (expRange: string) => ({
    '0-2': 1, '3-5': 4, '6-10': 8, '10+': 12
  }[expRange] || 3);

  const getRealAIMatches = async (userProfile: any) => {
    setIsLoading(true);
    try {
      const response = await fetch('/api/visa-matchmaker', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userProfile: {
            age: getAgeFromRange(userProfile.age),
            education: userProfile.education,
            profession: userProfile.profession,
            workExperience: getExperienceFromRange(userProfile.experience),
            englishProficiency: userProfile.englishLevel,
            budget: 15000,
            primaryGoal: userProfile.goal,
            preferredRegions: ['North America', 'Europe'],
            currentCountry: 'Nigeria',
            hasSpouse: false,
            hasDependents: false,
          },
          isPremium: false
        })
      });
      
      if (!response.ok) throw new Error('API call failed');
      const results = await response.json();
      setAiResults(results);
      setStep(2);
    } catch (error) {
      console.error('AI Error:', error);
      alert('AI service temporarily down. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  const TeaserResults = () => {
    const visibleMatches = aiResults?.topMatches?.slice(0, 2) || [];
    const hiddenMatches = aiResults?.topMatches?.slice(2) || [];
    const hiddenMatchesCount = hiddenMatches.length;

    // Fallback values for missing data
    const getSuccessRate = (match: any) => match.successRate || match.successProbability || 70;
    const getProcessingTime = (match: any) => match.processingTime || "4-6 months";
    const getStrengths = (match: any) => match.strengths?.slice(0, 3) || ["Good education match", "Favorable age", "English proficiency"];

    return (
      <div className="max-w-6xl mx-auto space-y-8">
        <div className="text-center space-y-4">
          <div className="inline-flex items-center gap-2 px-4 py-2 bg-green-500/10 rounded-full">
            <Sparkles className="w-4 h-4 text-green-500" />
            <span className="text-sm font-medium text-green-700">AI Analysis Complete</span>
          </div>
          <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
            Your Visa Matches
          </h1>
          <p className="text-lg text-gray-600 max-w-2xl mx-auto">
            Based on your profile, we found {aiResults?.topMatches?.length || 0} countries where you have strong visa opportunities
          </p>
        </div>

        {/* Visible Matches */}
        <div className="grid md:grid-cols-2 gap-6">
          {visibleMatches.map((match: any, index: number) => (
            <div key={index} className="bg-white rounded-2xl shadow-lg border border-green-100 overflow-hidden">
              <div className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <MapPin className="w-6 h-6 text-blue-500" />
                    <div>
                      <h3 className="text-xl font-bold text-gray-900">{match.country}</h3>
                      <p className="text-gray-600 text-sm">{match.visaType}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold text-green-500">{match.matchScore}%</div>
                    <div className="text-xs text-gray-500">Match Score</div>
                  </div>
                </div>

                <div className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-sm text-gray-700 mb-2">‚úÖ Key Advantages</h4>
                    <ul className="space-y-1">
                      {getStrengths(match).map((strength: string, i: number) => (
                        <li key={i} className="flex items-center gap-2 text-sm text-gray-600">
                          <CheckCircle className="w-4 h-4 text-green-500 flex-shrink-0" />
                          <span>{strength}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div className="flex justify-between items-center text-sm">
                    <div className="flex items-center gap-2">
                      <Star className="w-4 h-4 text-amber-500" />
                      <span className="text-gray-700">Success Rate: {getSuccessRate(match)}%</span>
                    </div>
                    <div className="text-blue-600 font-medium">
                      Processing: {getProcessingTime(match)}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Hidden Matches Teaser - MOVED TO BOTTOM */}
        {!isPremium && hiddenMatchesCount > 0 && (
          <div className="bg-gradient-to-r from-purple-500 to-blue-600 rounded-2xl p-8 text-white text-center mt-8">
            <Lock className="w-16 h-16 mx-auto mb-4 opacity-80" />
            <h3 className="text-2xl font-bold mb-2">
              üîí Unlock {hiddenMatchesCount} More Premium Matches
            </h3>
            <p className="text-purple-100 mb-4 max-w-md mx-auto">
              Get complete access to all {aiResults?.topMatches?.length} countries with detailed analysis
            </p>
            
            {/* Expandable Features */}
            <div className="bg-white/10 rounded-xl p-4 mb-6">
              <button
                onClick={() => setExpandedFeatures(!expandedFeatures)}
                className="flex items-center justify-center gap-2 w-full text-purple-100 font-semibold"
              >
                What you're missing {expandedFeatures ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              </button>
              
              {expandedFeatures && (
                <div className="mt-4 grid md:grid-cols-2 gap-4 text-left">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">All {aiResults?.topMatches?.length} country matches</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">Step-by-step visa roadmaps</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">Rejection risk analysis</span>
                    </div>
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">Document checklist</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">Mock interviews</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-300" />
                      <span className="text-sm">AI chat support</span>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Main CTA */}
            <div className="space-y-4">
              <div className="bg-white/20 rounded-lg p-4">
                <div className="text-2xl font-bold">$10<span className="text-lg font-normal">/week</span></div>
                <div className="text-purple-100 text-sm">Full access to all countries + tools</div>
              </div>
              
              <Link 
                href="/pricing"
                className="inline-flex items-center gap-2 bg-white text-purple-600 px-8 py-4 rounded-xl font-bold hover:shadow-lg transition-all hover:scale-105"
              >
                <Crown className="w-5 h-5" />
                Unlock Complete Results & Visa Roadmaps
              </Link>
              
              <p className="text-purple-200 text-sm mt-2">
                Everything you need to continue your visa journey
              </p>
            </div>
          </div>
        )}

        {/* Additional Value Proposition */}
        {!isPremium && (
          <div className="bg-gradient-to-r from-amber-400 to-orange-500 rounded-2xl p-8 text-white text-center">
            <div className="flex items-center justify-center gap-2 mb-4">
              <Crown className="w-6 h-6" />
              <h3 className="text-2xl font-bold">Ready to Start Your Visa Journey?</h3>
            </div>
            <p className="text-amber-100 mb-6 max-w-2xl mx-auto">
              Get personalized visa roadmaps, document checklists, and expert guidance for all matched countries
            </p>
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <div className="bg-white/20 rounded-lg p-4">
                <div className="text-lg font-semibold">Step-by-Step Roadmaps</div>
                <div className="text-amber-100 text-sm">Clear guidance for each country</div>
              </div>
              <div className="bg-white/20 rounded-lg p-4">
                <div className="text-lg font-semibold">Risk Analysis</div>
                <div className="text-amber-100 text-sm">Avoid common rejection reasons</div>
              </div>
              <div className="bg-white/20 rounded-lg p-4">
                <div className="text-lg font-semibold">AI Support</div>
                <div className="text-amber-100 text-sm">24/7 visa expert assistance</div>
              </div>
            </div>
            <Link 
              href="/pricing"
              className="inline-flex items-center gap-2 bg-white text-amber-600 px-8 py-4 rounded-xl font-bold hover:shadow-lg transition-all"
            >
              View All Pricing Plans
            </Link>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-amber-50 to-white py-12 px-4">
      {step === 1 && (
        <QuickQuiz 
          answers={answers}
          updateAnswer={updateAnswer}
          isLoading={isLoading}
          getRealAIMatches={getRealAIMatches}
        />
      )}
      {step === 2 && <TeaserResults />}
    </div>
  );
}
--- src/app/how-it-helps/page.tsx ---
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { ArrowRight } from 'lucide-react';

export default function HowItHelpsPage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-gray-50">
      <div className="container mx-auto px-4 py-12">
        {/* Hero Section */}
        <div className="text-center mb-12">
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            How Japa Genie Helps You
          </h1>
          <p className="text-gray-600 max-w-2xl mx-auto">
            From document preparation to interview coaching, we've got every step covered.
          </p>
        </div>

        {/* Proof of Funds Section */}
        <section className="mb-16">
          <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-8 text-white">
            <div className="flex flex-col md:flex-row items-center justify-between">
              <div className="md:w-2/3 mb-6 md:mb-0">
                <h2 className="text-2xl font-bold mb-2">Proof of Funds Guidance</h2>
                <p className="text-green-100">
                  Get expert review of your financial documents to ensure they meet embassy requirements.
                </p>
              </div>
              <div className="md:w-1/3">
                <Button asChild className="mobile-btn-fix bg-white text-green-600 hover:bg-green-50 w-full md:w-auto">
                  <Link href="/public-proof-of-funds">
                    <span className="hidden sm:inline">Get Funds Review</span>
                    <span className="sm:hidden">Funds Review</span>
                    <ArrowRight className="ml-2 w-4 h-4" />
                  </Link>
                </Button>
              </div>
            </div>
          </div>
        </section>

        {/* Expert Coaching Section */}
        <section className="mb-16">
          <div className="bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl p-8 text-white">
            <div className="flex flex-col md:flex-row items-center justify-between">
              <div className="md:w-2/3 mb-6 md:mb-0">
                <h2 className="text-2xl font-bold mb-2">1:1 Expert Coaching</h2>
                <p className="text-purple-100">
                  Book personalized sessions with immigration experts for complex cases.
                </p>
              </div>
              <div className="md:w-1/3">
                <Button asChild className="mobile-btn-fix bg-white text-purple-600 hover:bg-purple-50 w-full md:w-auto">
                  <Link href="/experts">
                    <span className="hidden sm:inline">Book Coach Session</span>
                    <span className="sm:hidden">Book Session</span>
                  </Link>
                </Button>
              </div>
            </div>
          </div>
        </section>

        {/* Connect with Experts Section */}
        <section className="mb-16">
          <div className="bg-white rounded-2xl border shadow-lg p-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
              Connect with Verified Experts
            </h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div className="border rounded-xl p-6 hover:shadow-md transition-shadow">
                <h3 className="font-bold text-lg mb-2">Document Specialists</h3>
                <p className="text-gray-600 mb-4">
                  Get your documents reviewed by professionals who know embassy requirements.
                </p>
                <Button asChild variant="outline" className="mobile-btn-fix w-full">
                  <Link href="/verified-agents">Find Specialists</Link>
                </Button>
              </div>
              <div className="border rounded-xl p-6 hover:shadow-md transition-shadow">
                <h3 className="font-bold text-lg mb-2">Immigration Lawyers</h3>
                <p className="text-gray-600 mb-4">
                  Legal experts for complex cases, appeals, and legal consultations.
                </p>
                <Button asChild className="mobile-btn-fix w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                  <Link href="/talk-to-someone">
                    <span className="hidden sm:inline">Connect with Expert</span>
                    <span className="sm:hidden">Expert Help</span>
                  </Link>
                </Button>
              </div>
            </div>
          </div>
        </section>

        {/* Additional Resources */}
        <section className="text-center">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">
            More Ways We Can Help
          </h2>
          <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <Button asChild variant="outline" className="mobile-btn-fix h-auto py-4">
              <Link href="/visa-matchmaker">Visa Matchmaker</Link>
            </Button>
            <Button asChild variant="outline" className="mobile-btn-fix h-auto py-4">
              <Link href="/document-check">Document Check</Link>
            </Button>
            <Button asChild variant="outline" className="mobile-btn-fix h-auto py-4">
              <Link href="/interview">Mock Interview</Link>
            </Button>
          </div>
        </section>
      </div>
    </div>
  );
}

--- src/app/pricing/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { Checkbox } from '@/components/ui/checkbox';
import { oneTimeCredits, subscriptionTiers } from '@/lib/pricing';
import Link from 'next/link';
import { 
  AlertDialog, 
  AlertDialogContent, 
  AlertDialogDescription, 
  AlertDialogFooter, 
  AlertDialogHeader, 
  AlertDialogTitle 
} from '@/components/ui/alert-dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Info, Check, Sparkles, Lock, Zap, Ticket, Users, Calendar } from 'lucide-react';
import { useAuth } from '@/lib/AuthContext';

// Define proper types for your plans
interface OneTimeCreditPlan {
  name: string;
  price: number;
  priceId: string;
  duration: string;
  features: string[];
  cta: string;
  description?: string;
}

interface SubscriptionTier {
  name: string;
  price: number;
  priceId: string;
  frequency: string;
  duration: string;
  features: string[];
  cta: string;
  popular: boolean;
  description: string;
}

export default function PricingPage() {
  return (
    <Suspense fallback={<div className="min-h-screen flex items-center justify-center">Loading pricing...</div>}>
      <PricingContent />
    </Suspense>
  );
}

function PricingContent() {
  const [showModal, setShowModal] = useState(false);
  const [selectedPlan, setSelectedPlan] = useState<any>(null);
  const [acceptedTerms, setAcceptedTerms] = useState(false);
  const [showLoginAlert, setShowLoginAlert] = useState(false);
  const [showPromo, setShowPromo] = useState(false);
  const [promoCode, setPromoCode] = useState('');
  const [promoLoading, setPromoLoading] = useState(false);
  const [promoMessage, setPromoMessage] = useState('');
  const searchParams = useSearchParams();
  const { user, signInWithGoogle } = useAuth();

  useEffect(() => {
    if (searchParams?.get('login_required') === 'true') {
      setShowLoginAlert(true);
      const timer = setTimeout(() => setShowLoginAlert(false), 10000);
      return () => clearTimeout(timer);
    }
  }, [searchParams]);

  // ‚úÖ ENHANCED: Get redirect reason for context-aware messaging
  const redirectReason = searchParams?.get('reason');
  const returnTo = searchParams?.get('returnTo');

  // ‚úÖ ENHANCED: Context-aware header messaging
  const getHeaderMessage = () => {
    switch (redirectReason) {
      case 'wishes_exhausted':
        return {
          title: "Continue Your Visa Journey",
          subtitle: "You've used your free wishes. Choose a plan for unlimited AI guidance and personalized support."
        };
      case 'dashboard_access':
        return {
          title: "Unlock Your Dashboard",
          subtitle: "Access your progress tracking, saved conversations, and personalized roadmap."
        };
      case 'tool_access':
        return {
          title: "Access Premium Tools",
          subtitle: "Upgrade to use document verification, visa matchmaker, and other advanced features."
        };
      default:
        return {
          title: "Find the Plan That's Right for You",
          subtitle: "Start your visa journey with confidence and expert guidance."
        };
    }
  };

  const headerMessage = getHeaderMessage();

  const handlePlanClick = (plan: any) => {
    if (!user) {
      setShowLoginAlert(true);
      return;
    }
    setSelectedPlan(plan);
    setAcceptedTerms(false);
    setShowModal(true);
  };

  const handleAccept = () => {
    localStorage.setItem('selectedPlan', JSON.stringify(selectedPlan));
    
    // ‚úÖ ENHANCED: Preserve returnTo parameter for seamless redirect after payment
    const urlParams = new URLSearchParams(window.location.search);
    const returnTo = urlParams.get('returnTo');
    const checkoutUrl = returnTo ? `/checkout?returnTo=${encodeURIComponent(returnTo)}` : '/checkout';
    
    window.location.href = checkoutUrl;
  };

  // ‚úÖ NEW: Promo code handler
  const handlePromoSubmit = async () => {
    if (!promoCode.trim()) return;
    
    if (!user) {
      setShowLoginAlert(true);
      return;
    }
    
    setPromoLoading(true);
    setPromoMessage('');
    
    try {
      const response = await fetch('/api/promo/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ promoCode: promoCode.trim() }),
      });

      const data = await response.json();

      if (response.ok) {
        setPromoMessage(`‚úÖ ${data.message} Redirecting to dashboard...`);
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 2000);
      } else {
        setPromoMessage(`‚ùå ${data.error}`);
      }
    } catch (error: any) {
      setPromoMessage('‚ùå Failed to activate promo code. Please try again.');
    } finally {
      setPromoLoading(false);
    }
  };

  // ‚úÖ ENHANCED: Context-aware CTA button
  const getCtaButton = (plan: any) => {
    if (!user) {
      return plan.cta;
    }
    
    switch (redirectReason) {
      case 'wishes_exhausted':
        return `Continue Chat ‚Ä¢ ${plan.cta}`;
      case 'dashboard_access':
        return `Access Dashboard ‚Ä¢ ${plan.cta}`;
      case 'tool_access':
        return `Unlock Tools ‚Ä¢ ${plan.cta}`;
      default:
        return plan.cta;
    }
  };

  return (
    <div className="relative overflow-hidden bg-white">
      <div className="container px-4 py-12 md:py-20">
        <header className="text-center space-y-4 mb-12">
          {/* ‚úÖ ENHANCED: Context-aware header */}
          {redirectReason && (
            <div className="flex justify-center mb-4">
              <div className="inline-flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm">
                {redirectReason === 'wishes_exhausted' && <Sparkles className="w-4 h-4" />}
                {redirectReason === 'dashboard_access' && <Lock className="w-4 h-4" />}
                {redirectReason === 'tool_access' && <Zap className="w-4 h-4" />}
                <span className="font-medium">
                  {redirectReason === 'wishes_exhausted' && 'Free Wishes Used'}
                  {redirectReason === 'dashboard_access' && 'Dashboard Locked'}
                  {redirectReason === 'tool_access' && 'Premium Feature'}
                </span>
              </div>
            </div>
          )}
          
          <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight">
            {headerMessage.title}
          </h1>
          <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
            {headerMessage.subtitle}
          </p>

          {/* ‚úÖ SECURE: Promo Code Section - NO CODE DISPLAY */}
          {showPromo ? (
            <div className="max-w-md mx-auto mt-8 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border-2 border-dashed border-green-200">
              <div className="flex items-center gap-2 mb-3">
                <Ticket className="w-5 h-5 text-green-600" />
                <h3 className="text-lg font-semibold text-green-800">Enter Promo Code</h3>
              </div>
              <p className="text-sm text-gray-600 mb-3">Enter your exclusive promo code for 7-day free access</p>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={promoCode}
                  onChange={(e) => setPromoCode(e.target.value.toUpperCase())}
                  placeholder="Enter your code here"
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
                <Button 
                  onClick={handlePromoSubmit} 
                  disabled={promoLoading || !promoCode.trim()}
                  className="bg-green-600 hover:bg-green-700 whitespace-nowrap"
                >
                  {promoLoading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                      Applying...
                    </>
                  ) : (
                    'Apply Code'
                  )}
                </Button>
              </div>
              {promoMessage && (
                <p className={`mt-2 text-sm ${promoMessage.includes('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>
                  {promoMessage}
                </p>
              )}
              <div className="mt-3 text-xs text-gray-500">
                <p>üí° <strong>Limited availability:</strong> 7-day trial codes are distributed privately</p>
              </div>
              <button 
                onClick={() => setShowPromo(false)}
                className="mt-3 text-sm text-gray-500 hover:text-gray-700 underline"
              >
                ‚Üê Back to pricing plans
              </button>
            </div>
          ) : (
            <div className="text-center mt-6">
              <button 
                onClick={() => setShowPromo(true)}
                className="inline-flex items-center gap-2 text-green-600 hover:text-green-800 text-sm font-medium bg-green-50 hover:bg-green-100 px-4 py-2 rounded-full transition-colors"
              >
                <Ticket className="w-4 h-4" />
                Have a promo code? Get 7-day free trial
              </button>
            </div>
          )}
        </header>

        {showLoginAlert && (
          <Alert className="mb-6 bg-blue-50 border-blue-200">
            <Info className="h-4 w-4 text-blue-600" />
            <AlertDescription className="text-blue-800 flex items-center justify-between">
              <span>Please log in to purchase a plan or use promo codes.</span>
              <Button 
                size="sm" 
                onClick={() => signInWithGoogle('/pricing')}
                className="ml-4"
              >
                Log In Now
              </Button>
            </AlertDescription>
          </Alert>
        )}

        {/* One-Time Credits */}
        <div className="mb-16">
          <h2 className="text-2xl font-bold text-center mb-8">One-Time Credits</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
            {(oneTimeCredits as OneTimeCreditPlan[]).map((plan) => (
              <Card
                key={plan.name}
                onClick={() => handlePlanClick(plan)}
                className="flex flex-col h-full cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-200"
              >
                <CardHeader>
                  <CardTitle className="text-xl md:text-2xl">{plan.name}</CardTitle>
                  <p className="text-2xl md:text-3xl font-bold pt-2">${plan.price}</p>
                  <CardDescription className="text-sm md:text-base">
                    {plan.description || ''}
                  </CardDescription>
                </CardHeader>
                <CardContent className="flex-1">
                  <ul className="space-y-3">
                    {plan.features.map((feature, index) => (
                      <li key={index} className="flex items-start text-sm">
                        <Check className="w-4 h-4 text-green-500 mr-2 mt-1 flex-shrink-0" />
                        <span className="text-muted-foreground">{feature}</span>
                      </li>
                    ))}
                  </ul>
                </CardContent>
                <CardFooter>
                  <Button className="w-full" variant="secondary">
                    {getCtaButton(plan)}
                  </Button>
                </CardFooter>
              </Card>
            ))}
          </div>
        </div>
        
        {/* Subscription Tiers */}
        <div>
          <h2 className="text-2xl font-bold text-center mb-8">Subscription Plans</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
              {(subscriptionTiers as SubscriptionTier[]).map((tier) => (
              <Card
                  key={tier.name}
                  onClick={() => handlePlanClick(tier)}
                  className={`flex flex-col h-full cursor-pointer hover:shadow-lg transition-shadow ${tier.popular ? 'border-primary ring-2 ring-primary' : 'border-2 hover:border-blue-200'}`}
              >
                  {tier.popular && (
                  <div className="py-1 px-4 bg-primary text-primary-foreground text-sm font-semibold rounded-t-lg text-center">
                      Most Popular
                  </div>
                  )}
                  <CardHeader className="text-center">
                  <CardTitle className="text-2xl md:text-3xl">{tier.name}</CardTitle>
                  <CardDescription>{tier.description}</CardDescription>
                  <div className="pt-4">
                      <span className="text-3xl md:text-4xl font-bold">${tier.price}</span>
                      <span className="text-muted-foreground">{tier.frequency}</span>
                  </div>
                  </CardHeader>
                  <CardContent className="flex-1">
                  <ul className="space-y-3 md:space-y-4">
                      {tier.features.map((feature, index) => (
                      <li key={index} className="flex items-start">
                          <Check className="w-5 h-5 text-green-500 mr-2 mt-1 flex-shrink-0" />
                          <span>{feature}</span>
                      </li>
                      ))}
                  </ul>
                  </CardContent>
                  <CardFooter>
                  <Button className="w-full" variant={tier.popular ? 'default' : 'outline'}>
                      {getCtaButton(tier)}
                  </Button>
                  </CardFooter>
              </Card>
              ))}
          </div>
        </div>

        {/* Additional Info */}
        <div className="text-center mt-16 text-sm text-muted-foreground">
          <p>All plans include access to our AI visa assistant and basic features.</p>
          <p>Need help choosing? <Link href="/contact-us" className="text-blue-600 underline">Contact our team</Link></p>
        </div>

        <AlertDialog open={showModal} onOpenChange={setShowModal}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Accept Terms & Conditions</AlertDialogTitle>
              <AlertDialogDescription>
                Please accept our terms to proceed with your purchase of the {selectedPlan?.name}.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <div className="flex items-start space-x-2 my-4">
              <Checkbox 
                id="terms" 
                checked={acceptedTerms} 
                onCheckedChange={(checked) => setAcceptedTerms(!!checked)} 
              />
              <label htmlFor="terms" className="text-sm">
                I agree to the{' '}
                <Link href="/terms-and-conditions" className="text-blue-600 underline" target="_blank">Terms & Conditions</Link>
                {' '}and{' '}
                <Link href="/privacy-policy" className="text-blue-600 underline" target="_blank">Privacy Policy</Link>.
              </label>
            </div>
            <AlertDialogFooter>
              <Button variant="outline" onClick={() => setShowModal(false)}>Cancel</Button>
              <Button onClick={handleAccept} disabled={!acceptedTerms}>
                Proceed to Checkout
              </Button>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </div>
  );
}

--- src/app/chat-widget/page.tsx ---
import ChatPanel from '@/components/layout/chat-panel';

export default function ChatWidgetPage() {
  return (
    <div className="h-full bg-transparent">
      <ChatPanel />
    </div>
  );
}

--- src/app/debug-mobile/page.tsx ---
export default function DebugMobilePage() {
  return (
    <div className="p-6">
      <h1 className="text-3xl font-bold mb-6">Mobile Debug - Quick Check</h1>
      <div className="p-4 bg-green-50 border border-green-200 rounded">
        <h2 className="text-xl font-semibold mb-3">Viewport Status</h2>
        <p>Check Chrome DevTools Console for diagnostics.</p>
        <p>Press F12 ‚Üí Console ‚Üí Paste diagnostic code</p>
      </div>
    </div>
  )
}

--- src/app/kyc-profile/page.tsx ---
// src/app/kyc-profile/page.tsx - COMPLETE FIXED VERSION WITH ALTERNATIVE COUNTRIES
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/AuthContext';
import { createClient } from '@/lib/supabase/client';
import { ALL_COUNTRIES } from '@/lib/countries';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { AlertCircle, CheckCircle2, Plus, X } from 'lucide-react';
import NameModal from '@/components/modals/NameModal';

export default function KYCProfilePage() {
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const supabase = createClient();
  const [country, setCountry] = useState('');
  const [destination, setDestination] = useState('');
  const [alternativeCountries, setAlternativeCountries] = useState<string[]>([]);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [initialLoad, setInitialLoad] = useState(true);

  useEffect(() => {
    const loadProfile = async () => {
      if (!user) {
        setInitialLoad(false);
        return;
      }
      
      try {
        console.log('Loading profile for user:', user.id);
        const { data, error } = await supabase
          .from('user_profiles')
          .select('country, destination_country, alternative_countries')
          .eq('id', user.id)
          .single();

        if (error) {
          console.error('Error loading profile:', error);
        } else if (data) {
          console.log('Loaded profile data:', data);
          setCountry(data.country || '');
          setDestination(data.destination_country || '');
          setAlternativeCountries(data.alternative_countries || []);
        }
      } catch (err) {
        console.error('Unexpected error loading profile:', err);
      } finally {
        setInitialLoad(false);
      }
    };

    loadProfile();
  }, [user, supabase]);

  const handleSave = async () => {
    console.log('üö® handleSave CALLED');
    
    if (!country || !destination) {
      console.log('‚ùå Validation failed');
      setError('Both fields are required');
      return;
    }
    
    if (!user) {
      console.log('‚ùå No user found');
      setError('User not authenticated');
      return;
    }

    console.log('‚úÖ Starting save for user:', user.id);
    setSaving(true);
    setError(null);
    setSuccess(false);

    try {
      // üöÄ SAVE WITH ALTERNATIVE COUNTRIES
      const { data, error: saveError } = await supabase
        .from('user_profiles')
        .upsert({
          id: user.id,
          country,
          destination_country: destination,
          alternative_countries: alternativeCountries,
          kyc_completed: true,
          kyc_last_updated: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'id'
        })
        .select()
        .single();

      if (saveError) {
        console.log('‚ùå SAVE FAILED:', saveError);
        setError(`Save failed: ${saveError.message}`);
        return;
      }

      console.log('üéâ SUCCESS! Profile saved:', data);
      
      // üöÄ SAVE KYC DATA TO SESSION STORAGE FOR CHAT
      sessionStorage.setItem('kycData', JSON.stringify({
        country,
        destination,
        alternativeCountries,
        age: data?.age || '',
        visaType: data?.visa_type || '',
        profession: data?.profession || ''
      }));

      setSuccess(true);

      // üöÄ FORCE REFRESH DASHBOARD BY RELOADING
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1000);

    } catch (err) {
      console.log('üí• UNEXPECTED ERROR:', err);
      setError('Unexpected error occurred');
    } finally {
      setSaving(false);
    }
  };

  const addAlternativeCountry = (country: string) => {
    if (country && !alternativeCountries.includes(country) && country !== destination) {
      setAlternativeCountries([...alternativeCountries, country]);
    }
  };

  const removeAlternativeCountry = (country: string) => {
    setAlternativeCountries(alternativeCountries.filter(c => c !== country));
  };

  if (authLoading || initialLoad) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <>
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
          <h1 className="text-3xl font-bold text-center mb-2">Quick Update</h1>
          <p className="text-center text-muted-foreground mb-8">
            We just need your origin and destination to keep your journey accurate
          </p>
          
          {error && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700">
              <AlertCircle className="w-5 h-5" />
              {error}
            </div>
          )}
          
          {success && (
            <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2 text-green-700">
              <CheckCircle2 className="w-5 h-5" />
              Profile updated successfully! Redirecting...
            </div>
          )}

          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium mb-2">Where are you from?</label>
              <Select value={country} onValueChange={setCountry}>
                <SelectTrigger>
                  <SelectValue placeholder="Your country" />
                </SelectTrigger>
                <SelectContent>
                  {ALL_COUNTRIES.map(c => (
                    <SelectItem key={c} value={c}>{c}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Where do you want to go?</label>
              <Select value={destination} onValueChange={setDestination}>
                <SelectTrigger>
                  <SelectValue placeholder="Destination" />
                </SelectTrigger>
                <SelectContent>
                  {ALL_COUNTRIES.map(c => (
                    <SelectItem key={c} value={c}>{c}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* ALTERNATIVE COUNTRIES SECTION */}
            <div>
              <label className="block text-sm font-medium mb-2">Alternative Countries (Optional)</label>
              <div className="space-y-2">
                {alternativeCountries.map((altCountry) => (
                  <div key={altCountry} className="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                    <span className="flex-1">{altCountry}</span>
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => removeAlternativeCountry(altCountry)}
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </div>
                ))}
                <Select onValueChange={addAlternativeCountry}>
                  <SelectTrigger>
                    <SelectValue placeholder="Add alternative country" />
                  </SelectTrigger>
                  <SelectContent>
                    {ALL_COUNTRIES.filter(c => c !== destination && !alternativeCountries.includes(c)).map(c => (
                      <SelectItem key={c} value={c}>{c}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <Button 
              onClick={handleSave} 
              className="w-full h-12 text-lg" 
              disabled={saving || !country || !destination || success}
            >
              {saving ? "Saving..." : success ? "Saved! Redirecting..." : "Save & Enter Dashboard"}
            </Button>
          </div>
        </div>
      </div>
      {user && <NameModal user={user} />}
    </>
  );
}
--- src/app/dashboard/proof-of-funds/page.tsx ---
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import ProofOfFundsClient from './client';

export default async function ProofOfFundsPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/auth/signin');

  const { data: userProfile } = await supabase
    .from('user_profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  return <ProofOfFundsClient user={user} userProfile={userProfile || {}} />;
}

--- src/app/dashboard/page.tsx ---
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import DashboardClient from './client';

export default async function DashboardPage() {
  const supabase = await createClient(); // ‚Üê This line is fixed with 'await'
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  // Get user profile
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  console.log('‚úÖ DASHBOARD PAGE - Profile:', profile);

  return <DashboardClient user={user} userProfile={profile} />;
}
--- src/app/document-check/report/page.tsx ---
'use client';
import { useSearchParams } from 'next/navigation';
import { useEffect, useState } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

export default function ReportPage() {
  const search = useSearchParams();
  const [letter, setLetter] = useState<string>('');

  useEffect(() => {
    const data = search.get('data');
    if (!data) return;
    const result = JSON.parse(decodeURIComponent(data));
    const aiLetter = generateLetter(result);
    setLetter(aiLetter);
  }, [search]);

  function generateLetter(r: any): string {
    const issues = r.criticalIssues?.map((i: any) => `<li><strong>${i.issue}</strong><br/>${i.recommendation}</li>`).join('') ?? '';
    const warnings = r.warnings?.map((w: any) => `<li>${w.issue} ‚Äì ${w.recommendation}</li>`).join('') ?? '';
    return `
<h1>Document Analysis Report</h1>
<p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
<p><strong>Document Type:</strong> ${r.documentType}</p>
<p><strong>Overall Status:</strong> ${r.overallStatus.toUpperCase()}</p>

<h2>Executive Summary</h2>
<p>Our AI has reviewed your document against ${r.targetCountry || 'General'} visa requirements. The analysis reveals the following:</p>

<h2>Critical Issues (Must Fix)</h2>
<ul>${issues}</ul>

<h2>Warnings (Recommended Fixes)</h2>
<ul>${warnings}</ul>

<h2>Next Steps</h2>
<ol>
  <li>Address all critical issues before submission.</li>
  <li>Re-upload the corrected document for a fresh check.</li>
  <li>Once status shows "PASS", attach this report to your application.</li>
</ol>

<p style="margin-top:2rem;">Generated by Japa-Genie AI ‚Äì Rejection-Proof Your Documents</p>
`;
  }

  return (
    <div className="min-h-screen bg-white text-slate-900 p-8">
      <div className="max-w-3xl mx-auto">
        <div dangerouslySetInnerHTML={{ __html: letter }} />
        <div className="mt-8 flex gap-4">
          <Button onClick={() => window.print()}>Print Report</Button>
          <Button variant="outline" onClick={() => window.close()}>Close</Button>
        </div>
      </div>
    </div>
  );
}

--- src/app/document-check/page.tsx ---
'use client';
import DocumentCheckClient from './client';
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { FileWarning, Shield, CheckCircle } from 'lucide-react';

export default function DocumentCheckPage() {
  return (
    <div className="min-h-screen bg-background">
      <section className="relative bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white overflow-hidden">
        <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,rgba(34,97,255,0.15),transparent_60%)]" />
        <div className="relative container mx-auto px-6 pt-20 pb-16 text-center">
          <h1 className="text-5xl md:text-6xl font-bold tracking-tight bg-gradient-to-r from-white to-primary bg-clip-text text-transparent">
            Rejection-Proof Your Documents
          </h1>
          <p className="mt-4 max-w-2xl mx-auto text-lg text-slate-300">
            80 % of visa rejections stem from document errors. Let AI scan, verify and fortify your application before submission.
          </p>
        </div>
      </section>

      <section className="-mt-12 px-6">
        <div className="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
          {[
            { icon: FileWarning, title: 'Error Detection', desc: 'Spot missing signatures, wrong dates and conflicts agents miss.' },
            { icon: Shield,   title: 'Fraud Prevention', desc: 'Source verifiable documents that withstand embassy scrutiny.' },
            { icon: CheckCircle, title: 'Format Compliance', desc: 'Meet the exact formatting rules of your target country.' }
          ].map((f) => (
            <Card key={f.title} className="group backdrop-blur-lg bg-white/60 border-white/20 shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
              <CardHeader className="items-center text-center">
                <div className="p-3 rounded-full bg-primary/10 text-primary group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
                  <f.icon className="w-7 h-7" />
                </div>
                <CardTitle className="mt-4 text-lg">{f.title}</CardTitle>
                <CardDescription className="text-sm text-slate-600">{f.desc}</CardDescription>
              </CardHeader>
            </Card>
          ))}
        </div>
      </section>

      <section className="py-16 px-6">
        <div className="max-w-4xl mx-auto">
          <Card className="backdrop-blur-lg bg-white/70 border-white/30 shadow-xl">
            <DocumentCheckClient />
          </Card>
        </div>
      </section>
    </div>
  );
}

--- src/app/verified-agents/page.tsx ---
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Check, Star, MessageSquare } from 'lucide-react';
import Link from 'next/link';

const agents = [
  {
    name: 'Amina Adebayo',
    avatar: 'AA',
    specialties: ['Canada', 'UK', 'Student Visas'],
    rating: 4.9,
    reviews: 128,
    verified: true,
  },
  {
    name: 'Kwame Osei',
    avatar: 'KO',
    specialties: ['USA', 'Work Permits', 'Tech Visas'],
    rating: 4.8,
    reviews: 94,
    verified: true,
  },
  {
    name: 'Fatou Jallow',
    avatar: 'FJ',
    specialties: ['Schengen Area', 'France', 'Business Visas'],
    rating: 4.9,
    reviews: 76,
    verified: true,
  },
  {
    name: 'Chinedu Eze',
    avatar: 'CE',
    specialties: ['Australia', 'Skilled Migration', 'Family Visas'],
    rating: 4.7,
    reviews: 112,
    verified: true,
  }
];

export default function VerifiedAgentsPage() {
  return (
    <div className="space-y-8">
      <header className="space-y-2 text-center">
        <h1 className="text-4xl font-bold tracking-tight">Japa Genie Verified Agents</h1>
        <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
          Connect with trusted, independent immigration consultants who can provide expert guidance for your specific case.
        </p>
      </header>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {agents.map((agent, index) => (
          <Card key={index} className="flex flex-col">
            <CardHeader className="items-center text-center">
              <Avatar className="w-24 h-24 mb-4">
                <AvatarFallback className="text-4xl bg-primary/20">{agent.avatar}</AvatarFallback>
              </Avatar>
              <CardTitle className="text-2xl">{agent.name}</CardTitle>
              {agent.verified && (
                <Badge variant="default" className="bg-green-500 hover:bg-green-600">
                  <Check className="w-4 h-4 mr-1.5" />
                  Verified
                </Badge>
              )}
            </CardHeader>
            <CardContent className="flex-grow flex flex-col">
              <div className="flex-grow space-y-4">
                <div>
                  <p className="font-semibold text-sm mb-2 text-center">Specialties</p>
                  <div className="flex flex-wrap gap-2 justify-center">
                    {agent.specialties.map(spec => (
                      <Badge key={spec} variant="secondary">{spec}</Badge>
                    ))}
                  </div>
                </div>
                <div className="flex justify-center items-center gap-4 text-sm text-muted-foreground">
                    <div className="flex items-center gap-1">
                        <Star className="w-4 h-4 text-amber-400 fill-amber-400" />
                        <span className="font-bold text-foreground">{agent.rating}</span>
                    </div>
                    <span>({agent.reviews} reviews)</span>
                </div>
              </div>
              <Button className="w-full mt-6" asChild>
                <Link href="/contact-us">
                  <MessageSquare className="w-4 h-4 mr-2" />
                  Book Consultation
                </Link>
              </Button>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}

--- src/app/kyc/page.tsx ---

// src/app/kyc/page.tsx - FINAL FIX VERSION
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/AuthContext';
import { createClient } from '@/lib/supabase/client';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ArrowRight, User, MapPin, Calendar, Briefcase, Clock, DollarSign, Target } from 'lucide-react';
import { ALL_COUNTRIES } from '@/lib/countries';
import NameModal from '@/components/modals/NameModal';

interface KYCData {
  country: string;
  destination: string;
  age: string;
  visaType: string;
  profession: string;
  userType: string;
  timelineUrgency: string;
  budget?: string;
}

const generateSessionId = () => `anon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

export default function KYCPage() {
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const supabase = createClient();
  
  const [formData, setFormData] = useState<KYCData>({
    country: '', destination: '', age: '', visaType: '', profession: '', userType: '', timelineUrgency: '', budget: ''
  });
  const [loading, setLoading] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const sessionId = user ? null : generateSessionId();
      
      await supabase.from('kyc_sessions').insert({
        user_id: user?.id || null,
        session_id: sessionId,
        country: formData.country,
        destination_country: formData.destination,
        age: parseInt(formData.age),
        visa_type: formData.visaType,
        profession: formData.profession,
        user_type: formData.userType,
        timeline_urgency: formData.timelineUrgency,
        budget: formData.budget || null
      });

      if (user?.id) {
        await supabase.from('user_profiles').upsert({
          id: user.id,
          country: formData.country,
          destination_country: formData.destination,
          age: parseInt(formData.age),
          visa_type: formData.visaType,
          profession: formData.profession,
          user_type: formData.userType,
          timeline_urgency: formData.timelineUrgency,
          kyc_completed: true,
          kyc_last_updated: new Date().toISOString(),
          updated_at: new Date().toISOString()
        });
      }

      // ‚úÖ FIX: Pass data via URL parameters to guarantee delivery
      const params = new URLSearchParams();
      params.append('country', formData.country);
      params.append('destination', formData.destination);
      params.append('age', formData.age);
      params.append('visaType', formData.visaType);
      if (formData.profession) params.append('profession', formData.profession);
      if (formData.userType) params.append('userType', formData.userType);
      if (formData.timelineUrgency) params.append('timelineUrgency', formData.timelineUrgency);
      if (sessionId) params.append('sessionId', sessionId);

      router.push(`/chat?${params.toString()}`);
      
    } catch (error) {
      console.error('KYC submission error:', error);
      alert('Error saving data. Please try again.');
      setLoading(false);
    }
  };

  const updateField = (field: keyof KYCData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const nextStep = () => {
    if (currentStep < 5) setCurrentStep(currentStep + 1);
  };

  const prevStep = () => {
    if (currentStep > 0) setCurrentStep(currentStep - 1);
  };

  if (authLoading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>;

  const visaTypes = ['Study Visa','Work Visa','Tourist Visa','Business Visa','Family Visa','Permanent Residency','Not Sure'];
  const userTypes = ['Student','Working Professional','Business Owner','Tourist/Visitor','Career Changer','Family Migrant'];
  const timelineOptions = [
    { value: 'asap', label: 'üöÄ ASAP (0-3 months)' },
    { value: '3-6_months', label: 'üìÖ 3-6 months' },
    { value: '6-12_months', label: 'üóìÔ∏è 6-12 months' },
    { value: 'exploring', label: 'üîç Exploring options' }
  ];
  const budgetOptions = [
    { value: 'under_5k', label: 'Under $5,000' },
    { value: '5k_15k', label: '$5,000 - $15,000' },
    { value: '15k_30k', label: '$15,000 - $30,000' },
    { value: '30k_50k', label: '$30,000 - $50,000' },
    { value: 'over_50k', label: 'Over $50,000' },
    { value: 'not_sure', label: 'Not sure yet' }
  ];

  const steps = [
    {
      title: "Where are you from?",
      icon: MapPin,
      field: 'country' as keyof KYCData,
      placeholder: "Select your country",
      required: true
    },
    {
      title: "Where do you want to go?",
      icon: Target,
      field: 'destination' as keyof KYCData,
      placeholder: "Choose destination",
      required: true
    },
    {
      title: "What's your age?",
      icon: Calendar,
      field: 'age' as keyof KYCData,
      placeholder: "Your age",
      required: true
    },
    {
      title: "What's your profession/field?",
      icon: Briefcase,
      field: 'profession' as keyof KYCData,
      placeholder: "e.g., Software Engineer, Nurse, Teacher",
      required: true
    },
    {
      title: "What's your timeline?",
      icon: Clock,
      field: 'timelineUrgency' as keyof KYCData,
      placeholder: "Select timeline",
      required: true
    },
    {
      title: "What's your budget range? (Optional)",
      icon: DollarSign,
      field: 'budget' as keyof KYCData,
      placeholder: "Select budget range",
      required: false
    }
  ];

  const currentStepData = steps[currentStep];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12">
      {user && <NameModal user={user} />}
      <div className="container mx-auto px-4 max-w-2xl">
        <Card className="shadow-lg border-0 overflow-hidden">
          <CardHeader className="text-center pb-4">
            <CardTitle className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
              Your Global Journey Starts Here
            </CardTitle>
            <CardDescription className="text-lg mt-2">
              Answer a few questions for personalized visa advice
            </CardDescription>
            
            {/* Progress indicator */}
            <div className="mt-4">
              <div className="flex justify-center space-x-2">
                {steps.map((_, index) => (
                  <div
                    key={index}
                    className={`w-3 h-3 rounded-full transition-all ${
                      index <= currentStep ? 'bg-blue-600' : 'bg-gray-300'
                    }`}
                  />
                ))}
              </div>
              <p className="text-sm text-muted-foreground mt-2">
                Step {currentStep + 1} of {steps.length}
              </p>
            </div>
          </CardHeader>
          
          <CardContent className="pt-6">
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* Current Question */}
              <div className="space-y-4">
                <Label className="flex items-center gap-2 text-lg font-semibold">
                  <currentStepData.icon className="w-5 h-5" />
                  {currentStepData.title}
                </Label>
                
                {currentStep === 0 || currentStep === 1 ? (
                  <Select 
                    onValueChange={(v) => updateField(currentStepData.field, v)} 
                    required={currentStepData.required}
                    value={formData[currentStepData.field]}
                  >
                    <SelectTrigger className="h-12 text-lg">
                      <SelectValue placeholder={currentStepData.placeholder} />
                    </SelectTrigger>
                    <SelectContent>
                      {ALL_COUNTRIES.map(c => (
                        <SelectItem key={c} value={c}>{c}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                ) : currentStep === 2 ? (
                  <Input
                    type="number"
                    placeholder={currentStepData.placeholder}
                    className="h-12 text-lg"
                    value={formData[currentStepData.field]}
                    onChange={(e) => updateField(currentStepData.field, e.target.value)}
                    required={currentStepData.required}
                    min="18"
                    max="99"
                  />
                ) : currentStep === 4 ? (
                  <Select 
                    onValueChange={(v) => updateField(currentStepData.field, v)} 
                    required={currentStepData.required}
                    value={formData[currentStepData.field]}
                  >
                    <SelectTrigger className="h-12 text-lg">
                      <SelectValue placeholder={currentStepData.placeholder} />
                    </SelectTrigger>
                    <SelectContent>
                      {timelineOptions.map(opt => (
                        <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                ) : currentStep === 5 ? (
                  <Select 
                    onValueChange={(v) => updateField(currentStepData.field, v)} 
                    required={currentStepData.required}
                    value={formData[currentStepData.field]}
                  >
                    <SelectTrigger className="h-12 text-lg">
                      <SelectValue placeholder={currentStepData.placeholder} />
                    </SelectTrigger>
                    <SelectContent>
                      {budgetOptions.map(opt => (
                        <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                ) : (
                  <Input
                    placeholder={currentStepData.placeholder}
                    className="h-12 text-lg"
                    value={formData[currentStepData.field]}
                    onChange={(e) => updateField(currentStepData.field, e.target.value)}
                    required={currentStepData.required}
                  />
                )}
              </div>

              {/* Navigation buttons */}
              <div className="flex gap-3">
                {currentStep > 0 && (
                  <Button
                    type="button"
                    variant="outline"
                    onClick={prevStep}
                    className="flex-1"
                  >
                    Previous
                  </Button>
                )}
                
                {currentStep < steps.length - 1 ? (
                  <Button
                    type="button"
                    onClick={nextStep}
                    className="flex-1"
                    disabled={!formData[currentStepData.field] && currentStepData.required}
                  >
                    Next <ArrowRight className="w-4 h-4 ml-2" />
                  </Button>
                ) : (
                  <Button
                    type="submit"
                    className="flex-1 h-14 text-lg bg-gradient-to-r from-blue-600 to-purple-600"
                    disabled={loading || (currentStepData.required && !formData[currentStepData.field])}
                  >
                    {loading ? "Saving..." : "Get Personalized Advice"}
                  </Button>
                )}
              </div>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

--- src/app/interview/page.tsx ---
import EligibilityCheckClient from './client';

export default function EligibilityCheckPage() {
  return (
    <div className="container py-12 space-y-8">
      <EligibilityCheckClient />
    </div>
  );
}
--- src/app/visa-readiness-check/page.tsx ---
'use client';

import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { useState } from 'react';
import { ArrowRight, CheckCircle, Shield } from 'lucide-react';
import { useRouter } from 'next/navigation';
import type { UserProfile } from '@/lib/visa-readiness-calculator';

export default function VisaReadinessCheck() {
  const router = useRouter();
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState<Partial<UserProfile>>({});

  const questions = [
    {
      id: 'hasValidPassport',
      question: 'Is your passport valid for at least 6 months beyond your intended travel date?',
      type: 'boolean' as const
    },
    {
      id: 'allFormsCompleted',
      question: 'Have you completed all required application forms accurately?',
      type: 'boolean' as const
    },
    {
      id: 'bankBalanceAdequate',
      question: 'Do your bank statements show sufficient funds for your destination?',
      type: 'boolean' as const
    },
    {
      id: 'savingsDurationMonths',
      question: 'How many months of consistent bank statements can you provide?',
      type: 'number' as const,
      options: [
        { value: 0, label: 'Less than 3 months' },
        { value: 3, label: '3-5 months' },
        { value: 6, label: '6-11 months' },
        { value: 12, label: '12+ months' }
      ]
    },
    {
      id: 'hasLanguageCertification',
      question: 'Do you have language certification for your destination country?',
      type: 'boolean' as const
    },
    {
      id: 'hasPreviousVisas',
      question: 'Have you successfully obtained and used international visas before?',
      type: 'boolean' as const
    },
    {
      id: 'neverOverstayed',
      question: 'Have you always complied with visa conditions (never overstayed)?',
      type: 'boolean' as const
    },
    {
      id: 'educationVerified',
      question: 'Are your educational credentials officially verified?',
      type: 'boolean' as const
    },
    {
      id: 'workExperienceMatchesJob',
      question: 'Does your work experience align with your intended visa category?',
      type: 'boolean' as const
    },
    {
      id: 'practicedMockInterview',
      question: 'Have you practiced for visa interview questions?',
      type: 'boolean' as const
    },
    {
      id: 'dependentsInHomeCountry',
      question: 'Do you have family dependents remaining in your home country?',
      type: 'boolean' as const
    },
    {
      id: 'propertyOwnership',
      question: 'Do you own property or have significant assets in your home country?',
      type: 'boolean' as const
    }
  ];

  const handleAnswer = (value: boolean | number) => {
    const questionId = questions[currentQuestion].id;
    const newAnswers = { ...answers, [questionId]: value };
    setAnswers(newAnswers);

    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      // Store answers and navigate to results
      localStorage.setItem('visaReadinessAnswers', JSON.stringify(newAnswers));
      router.push('/visa-readiness-results');
    }
  };

  const progress = ((currentQuestion + 1) / questions.length) * 100;
  const currentQ = questions[currentQuestion];

  return (
    <section className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 py-20">
      <div className="container mx-auto px-4 max-w-3xl">
        {/* Header */}
        <div className="text-center mb-12">
          <div className="inline-flex items-center gap-2 bg-gradient-to-r from-purple-100 to-pink-100 px-4 py-2 rounded-full text-sm font-medium text-purple-700 mb-4">
            <Shield className="w-4 h-4" />
            Free Assessment ‚Ä¢ No Signup Required
          </div>
          
          <h1 className="text-3xl md:text-5xl font-bold mb-4 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
            Visa Readiness Check
          </h1>
          
          <p className="text-lg text-gray-700">
            Discover your 3 biggest application weaknesses before embassies see them
          </p>
        </div>

        {/* Progress Bar */}
        <div className="mb-8">
          <div className="flex justify-between text-sm text-gray-600 mb-2">
            <span>Question {currentQuestion + 1} of {questions.length}</span>
            <span>{Math.round(progress)}% Complete</span>
          </div>
          <div className="h-3 bg-white/50 rounded-full overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-purple-600 to-pink-600 transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Question Card */}
        <Card className="p-8 md:p-12 bg-white/80 backdrop-blur-sm border-2 border-white/60 shadow-xl">
          <h2 className="text-2xl md:text-3xl font-bold mb-8 text-gray-800">
            {currentQ.question}
          </h2>

          {currentQ.type === 'boolean' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Button
                onClick={() => handleAnswer(true)}
                size="lg"
                className="h-20 text-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white"
              >
                <CheckCircle className="mr-2 h-6 w-6" />
                Yes
              </Button>
              <Button
                onClick={() => handleAnswer(false)}
                size="lg"
                variant="outline"
                className="h-20 text-lg border-2 border-gray-300 hover:bg-gray-50"
              >
                No
              </Button>
            </div>
          ) : (
            <div className="space-y-3">
              {currentQ.options?.map((option) => (
                <Button
                  key={option.value}
                  onClick={() => handleAnswer(option.value)}
                  size="lg"
                  variant="outline"
                  className="w-full h-16 text-lg border-2 border-purple-200 hover:bg-purple-50 hover:border-purple-400"
                >
                  {option.label}
                </Button>
              ))}
            </div>
          )}
        </Card>

        {/* Navigation */}
        {currentQuestion > 0 && (
          <div className="mt-6 text-center">
            <Button
              onClick={() => setCurrentQuestion(currentQuestion - 1)}
              variant="ghost"
              className="text-gray-600"
            >
              ‚Üê Previous Question
            </Button>
          </div>
        )}
      </div>
    </section>
  );
}

--- src/app/privacy-policy/page.tsx ---
export default function PrivacyPolicyPage() {
  return (
    <div className="container max-w-4xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold mb-6">Privacy Policy</h1>
      <div className="prose max-w-none">
        <p><em>Last updated: {new Date().toLocaleDateString()}</em></p>

        <h3>1. Introduction</h3>
        <p>Welcome to Japa Genie. We are committed to protecting your personal information and your right to privacy. If you have any questions or concerns about our policy, or our practices with regards to your personal information, please contact us.</p>

        <h3>2. Information We Collect</h3>
        <p>We collect personal information that you voluntarily provide to us when you register on the app, express an interest in obtaining information about us or our products and services, when you participate in activities on the app (such as using our AI chat) or otherwise when you contact us.</p>
        <p>The personal information that we collect depends on the context of your interactions with us and the app, the choices you make and the products and features you use.</p>

        <h3>3. How We Use Your Information</h3>
        <p>We use personal information collected via our app for a variety of business purposes described below. We process your personal information for these purposes in reliance on our legitimate business interests, in order to enter into or perform a contract with you, with your consent, and/or for compliance with our legal obligations.</p>
        <ul>
            <li>To facilitate account creation and logon process.</li>
            <li>To send you marketing and promotional communications.</li>
            <li>To send administrative information to you.</li>
            <li>To protect our Services.</li>
            <li>To respond to user inquiries/offer support to users.</li>
        </ul>

        <h3>4. Will Your Information Be Shared With Anyone?</h3>
        <p>We only share information with your consent, to comply with laws, to provide you with services, to protect your rights, or to fulfill business obligations.</p>

        <h3>5. How We Keep Your Information Safe</h3>
        <p>We have implemented appropriate technical and organizational security measures designed to protect the security of any personal information we process. However, despite our safeguards and efforts to secure your information, no electronic transmission over the Internet or information storage technology can be guaranteed to be 100% secure.</p>
        
        <h3>6. Contact Us</h3>
        <p>If you have questions or comments about this policy, you may email us at support@japagenie.com</p>
      </div>
    </div>
  )
}

--- src/app/blog/rejection-risk-score/page.tsx ---
'use client';

import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { ArrowLeft } from 'lucide-react';

export default function RejectionRiskScorePost() {
  return (
    <section className="py-20 bg-gray-50 min-h-screen">
      <div className="container mx-auto px-4 max-w-4xl">
        {/* Back Button */}
        <div className="mb-8">
          <Button variant="outline" asChild>
            <a href="/blog" className="flex items-center gap-2">
              <ArrowLeft className="h-4 w-4" /> Back to Japa News
            </a>
          </Button>
        </div>

        {/* Main Article */}
        <article className="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
          {/* Header */}
          <header className="text-center mb-12 border-b pb-8">
            <h1 className="text-3xl md:text-4xl font-bold mb-6">
              How Japa Genie Calculates Your Visa Rejection Risk Score
            </h1>
            <p className="text-xl text-gray-600 mb-4">
              And exactly what you can do to reduce your risk ‚Äî before you even apply.
            </p>
            <div className="flex justify-center gap-4 text-sm text-gray-500">
              <span>By Japa Genie Team</span>
              <span>‚Ä¢</span>
              <span>5 min read</span>
            </div>
          </header>

          {/* Intro */}
          <section className="mb-12">
            <p className="text-lg text-gray-600 leading-relaxed mb-6">
              We analyzed 1,247 visa applications from African applicants.
              68% were rejected ‚Äî not because they weren't qualified,
              but because embassies couldn't verify their story.
            </p>
            
            <p className="text-lg text-gray-600 leading-relaxed">
              That's why we built the <strong>Japa Genie Rejection Risk Score</strong> ‚Äî
              Africa's first AI-powered tool that predicts your likelihood of rejection
              across 7 key factors, and tells you exactly how to fix each one.
            </p>
          </section>

          {/* The 7 Factors */}
          <section className="space-y-8 mb-12">
            <h2 className="text-2xl font-bold">The 7 Hidden Factors Embassies Actually Check</h2>
            
            {riskFactors.map((factor, index) => (
              <Card key={index} className="p-6 border-l-4 border-purple-500">
                <h3 className="text-xl font-bold mb-3">{factor.title}</h3>
                <p className="text-gray-600 mb-4">{factor.description}</p>
                
                <div className="bg-gray-50 rounded-lg p-4">
                  <h4 className="font-semibold mb-2">What Japa Genie Checks:</h4>
                  <ul className="list-disc list-inside space-y-1 text-sm text-gray-600">
                    {factor.checks.map((check, i) => (
                      <li key={i}>{check}</li>
                    ))}
                  </ul>
                </div>
              </Card>
            ))}
          </section>

          {/* How It Works */}
          <section className="bg-white rounded-xl p-8 shadow-sm border border-gray-200 mb-12">
            <h2 className="text-2xl font-bold mb-6">How Your Rejection Risk Score Is Calculated</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-bold mb-3">Step 1: Complete Your Profile</h3>
                <p className="text-gray-600 mb-4">Answer 12 quick questions about your background.</p>
                
                <h3 className="font-bold mb-3">Step 2: Get Your Score</h3>
                <p className="text-gray-600 mb-4">Receive a 0-100 score + color-coded risk level.</p>
                
                <h3 className="font-bold mb-3">Step 3: Fix Weaknesses</h3>
                <p className="text-gray-600">Get specific, actionable steps to reduce your risk.</p>
              </div>
              
              <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6 flex items-center justify-center">
                <div className="text-center">
                  <div className="inline-block bg-red-100 text-red-800 text-2xl font-bold px-4 py-2 rounded-full mb-3">
                    78%
                  </div>
                  <p className="text-gray-600 font-semibold">High Risk</p>
                  <p className="text-sm text-gray-500 mt-1">Based on incomplete travel history</p>
                </div>
              </div>
            </div>
          </section>

          {/* Real Story - UPDATED NAME TO TIMI */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold mb-6">Real User: Timi Reduced His Risk by 62%</h2>
            
            <blockquote className="border-l-4 border-green-500 pl-6 italic text-gray-600 text-lg mb-4">
              "My first Japan SSW visa application was rejected. Japa Genie showed my Proof of Funds had a 93% risk score ‚Äî my agent told me N500k was enough, but Japan needed documented savings over 6 months. I fixed it and got approved on my second try."
            </blockquote>
            
            <p className="text-gray-600">
              <strong>Timi O., Lagos ‚Üí Tokyo | Truck Driver | Approved in 4 weeks</strong>
            </p>
          </section>

          {/* CTA */}
          <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-8 border border-blue-100 text-center">
            <h2 className="text-2xl font-bold mb-4">Get Your Free Rejection Risk Score</h2>
            <p className="text-gray-600 mb-6">
              Join 2,800+ Africans who discovered hidden weaknesses in their application 
              before applying ‚Äî no signup needed.
            </p>
            
            <Button 
              className="bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:opacity-90"
              asChild
            >
              <a href="/kyc">Get My Free Score Now</a>
            </Button>
            
            <p className="text-xs text-gray-500 mt-3">
              You'll get all 7 scores + 1 free wish to fix the biggest risk factor
            </p>
          </div>

          {/* FAQ */}
          <section className="mt-16 space-y-6">
            <h2 className="text-2xl font-bold">Frequently Asked Questions</h2>
            
            <div className="bg-white rounded-lg p-6 border border-gray-200">
              <h3 className="font-bold mb-3">Is this score accurate?</h3>
              <p className="text-gray-600">
                Yes. Our model was trained on real rejection patterns from Japanese, German, 
                and Korean embassies. We validated it against 312 actual cases with 92% accuracy.
              </p>
            </div>
            
            <div className="bg-white rounded-lg p-6 border border-gray-200">
              <h3 className="font-bold mb-3">Do I need to pay to see my score?</h3>
              <p className="text-gray-600">
                No. You get your full Rejection Risk Score breakdown for free. 
                Only pay if you use more than 3 wishes to fix issues.
              </p>
            </div>
          </section>
        </article>
      </div>
    </section>
  );
}

// Data object for risk factors
const riskFactors = [
  {
    title: "‚úÖ Document Completeness",
    description: "Embassies reject 41% of applications due to missing or inconsistent documents.",
    checks: [
      "All required forms properly filled and signed",
      "Passport validity (minimum 6 months beyond visa duration)",
      "Photo meets embassy specifications (size, background, expression)",
      "No gaps or inconsistencies in employment/education history"
    ]
  },
  {
    title: "üí∞ Proof of Funds Adequacy",
    description: "Having money isn't enough ‚Äî you must prove it's yours and stable.",
    checks: [
      "Bank statements show consistent balance over 6+ months",
      "Funds are in your name or immediate family member's account",
      "No sudden large deposits without explanation",
      "Amount meets or exceeds embassy requirements for your destination"
    ]
  },
  {
    title: "üó£Ô∏è Language Proficiency Level",
    description: "Even 'English-speaking' countries test basic comprehension.",
    checks: [
      "Can understand simple instructions in destination country's language",
      "Basic reading/writing ability demonstrated",
      "No language test fraud (we verify through interactive assessment)",
      "TOEFL/IELTS/JLPT/TOPIK scores match speaking ability"
    ]
  },
  {
    title: "‚úàÔ∏è Travel History",
    description: "Your past trips reveal trustworthiness to new embassies.",
    checks: [
      "No overstays on previous visas",
      "Consistent return to home country after visits",
      "Travel to other countries strengthens credibility",
      "Explained gaps in passport stamps"
    ]
  },
  {
    title: "üéì Education & Work Background",
    description: "Your qualifications must match your intended job abroad.",
    checks: [
      "Degree/diploma verified through official channels",
      "Work experience matches job application claims",
      "Employment gaps properly explained",
      "Skills align with labor market needs in target country"
    ]
  },
  {
    title: "üë§ Age & Life Stage",
    description: "Some countries prefer applicants in specific age ranges.",
    checks: [
      "Age within optimal range for destination (e.g., 25-35 for Japan SSW)",
      "Life stage suggests stability (not too young/old for independent work)",
      "Family situation supports long-term stay abroad"
    ]
  },
  {
    title: "üë®‚Äçüë©‚Äçüëß Family Ties",
    description: "Strong ties to home country reduce 'overstay' concerns.",
    checks: [
      "Dependents remaining in home country",
      "Property ownership or business interests",
      "Elderly parents requiring care",
      "Clear intention to return after contract ends"
    ]
  }
];

--- src/app/blog/page.tsx ---
'use client';

import { Button } from '@/components/ui/button';
import { ArrowRight, Target, CheckCircle, Users, Zap, X, MessageCircle, Rocket } from 'lucide-react';
import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/AuthContext';
import { createClient } from '@/lib/supabase/client';

export default function JapaNewsPage() {
  const router = useRouter();
  const { user, loading: authLoading } = useAuth();
  const [mounted, setMounted] = useState(false);
  const [showExitIntent, setShowExitIntent] = useState(false);
  const [visitorCount, setVisitorCount] = useState(0);
  const [hasKYC, setHasKYC] = useState(false);
  const supabase = createClient();

  // Check if user has completed KYC
  useEffect(() => {
    const checkKYCStatus = async () => {
      if (user) {
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('country, destination_country, visa_type, age, user_type, timeline_urgency')
          .eq('id', user.id)
          .single();
        
        const kycComplete = profile && 
          profile.country && 
          profile.destination_country && 
          profile.visa_type &&
          profile.age &&
          profile.user_type &&
          profile.timeline_urgency;
          
        setHasKYC(!!kycComplete);
      }
    };

    if (user) {
      checkKYCStatus();
    }
  }, [user, supabase]);

  useEffect(() => {
    setMounted(true);
    setVisitorCount(Math.floor(Math.random() * 500) + 1250);
    
    const handleMouseLeave = (e: MouseEvent) => {
      if (e.clientY <= 0 && !localStorage.getItem('exitIntentShown')) {
        setShowExitIntent(true);
        localStorage.setItem('exitIntentShown', 'true');
      }
    };
    
    document.addEventListener('mouseleave', handleMouseLeave);
    return () => document.removeEventListener('mouseleave', handleMouseLeave);
  }, []);

  // üéØ SMART NAVIGATION: Different paths for different user states
  const handleSmartNavigation = () => {
    if (!user) {
      // Non-users: KYC ‚Üí Chat flow
      router.push('/kyc');
    } else if (user && !hasKYC) {
      // Signed-in but no KYC: Complete profile
      router.push('/kyc');
    } else {
      // Signed-in with KYC: Straight to Genie!
      router.push('/chat');
    }
  };

  // üéØ GET SMART CTA TEXT & ICON
  const getCTADetails = () => {
    if (!user) {
      return {
        text: "Start Free Assessment",
        icon: Rocket,
        description: "Get your personalized visa roadmap"
      };
    } else if (user && !hasKYC) {
      return {
        text: "Complete Your Profile",
        icon: Target,
        description: "Finish KYC for personalized advice"
      };
    } else {
      return {
        text: "Continue with AI Genie",
        icon: MessageCircle,
        description: "Pick up where you left off"
      };
    }
  };

  const stories = [
    {
      slug: 'rejection-risk-score',
      title: 'How Japa Genie Calculates Your Visa Rejection Risk Score',
      excerpt: 'Discover the 7 hidden factors embassies check that cause 68% of rejections.',
      author: 'Japa Genie Team',
      location: 'Lagos, Nigeria',
      outcome: '62% risk reduction',
      hook: '"My Japan SSW visa was rejected until I fixed my Proof of Funds risk score."',
      readTime: '5 min read'
    },
    {
      slug: 'amara-visa-rejection-reversal',
      title: 'From Heartbreak to Toronto: Amara\'s Visa Rejection Reversal',
      excerpt: 'Three rejections couldn\'t stop this Ivorian software engineer from reaching Canada.',
      author: 'Amara Kone',
      location: 'C√¥te d\'Ivoire ‚Üí Toronto, Canada',
      outcome: 'CAD $85,000 salary',
      hook: '"They rejected me three times. The fourth time, I got my Canadian PR."',
      readTime: '5 min read'
    },
    {
      slug: 'kwame-teacher-to-uk-global-talent',
      title: 'The Impossible Dream: From Teacher to UK Global Talent',
      excerpt: 'Rural Ghana teacher proves everyone wrong with innovative EdTech approach.',
      author: 'Kwame Asante',
      location: 'Rural Ghana ‚Üí London, UK',
      outcome: '¬£65,000 salary',
      hook: '"Everyone said teachers can\'t get UK Global Talent visas. I proved them wrong."',
      readTime: '6 min read'
    }
  ];

  const SmartProgressiveCTA = () => {
    const [step, setStep] = useState(1);
    const ctaDetails = getCTADetails();
    const CTAIcon = ctaDetails.icon;

    const steps = [
      {
        icon: Target,
        title: "Get Your Visa Score",
        subtitle: "60-second assessment",
        cta: "Check My Eligibility",
        description: "See which visas you qualify for right now"
      },
      {
        icon: CheckCircle,
        title: "See Your Options", 
        subtitle: "Personalized pathways",
        cta: "View My Routes",
        description: "Get 3 tailored visa strategies with success rates"
      },
      {
        icon: Zap,
        title: "Full AI Analysis",
        subtitle: "Complete roadmap", 
        cta: user && hasKYC ? "Continue Journey" : "Start My Journey",
        description: user && hasKYC ? "Pick up with AI Genie" : "Comprehensive plan with documents, timeline & tips"
      }
    ];

    const currentStep = steps[step - 1];
    const StepIcon = currentStep.icon;

    return (
      <div className="bg-white/30 backdrop-blur-sm border border-white/40 rounded-2xl sm:rounded-3xl shadow-xl p-4 sm:p-8 text-center mb-8 sm:mb-12">
        <div className="flex justify-center mb-4 sm:mb-6">
          <div className="flex space-x-2">
            {steps.map((_, index) => (
              <div
                key={index}
                className={`w-2 h-2 sm:w-3 sm:h-3 rounded-full transition-all duration-300 ${
                  index + 1 === step
                    ? 'bg-gradient-to-r from-purple-500 to-pink-600'
                    : index + 1 < step
                    ? 'bg-green-500'
                    : 'bg-gray-300'
                }`}
              />
            ))}
          </div>
        </div>

        <div className="mb-4 sm:mb-6">
          <div className="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl sm:rounded-2xl flex items-center justify-center">
            <StepIcon className="w-6 h-6 sm:w-8 sm:h-8 text-white" />
          </div>
          <h3 className="text-xl sm:text-2xl font-bold mb-1 sm:mb-2">{currentStep.title}</h3>
          <p className="text-gray-600 text-sm sm:text-base mb-1">{currentStep.subtitle}</p>
          <p className="text-xs sm:text-sm text-gray-500">{currentStep.description}</p>
        </div>

        <Button
          className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white mb-3 sm:mb-4 text-sm sm:text-base"
          size="lg"
          onClick={() => {
            if (step < 3) {
              setStep(step + 1);
            } else {
              handleSmartNavigation();
            }
          }}
        >
          {step === 3 ? ctaDetails.text : currentStep.cta} 
          <ArrowRight className="ml-2 h-3 w-3 sm:h-4 sm:w-4" />
        </Button>

        {step < 3 && (
          <p className="text-xs sm:text-sm text-gray-500">
            Step {step} of 3 ‚Ä¢ Takes {step === 1 ? '1' : step === 2 ? '3' : '10'} minute{step === 1 ? '' : 's'}
          </p>
        )}
      </div>
    );
  };

  if (!mounted) {
    return (
      <section className="py-12 sm:py-20 bg-gray-50">
        <div className="container mx-auto px-4 max-w-6xl">
          <div className="animate-pulse space-y-8">
            <div className="h-6 sm:h-8 bg-gray-300 rounded w-1/2 mx-auto"></div>
            <div className="h-3 sm:h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
          </div>
        </div>
      </section>
    );
  }

  const ctaDetails = getCTADetails();
  const CTAIcon = ctaDetails.icon;

  return (
    <>
      <section className="py-8 sm:py-12 md:py-20 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
        <div className="container mx-auto px-4 max-w-6xl">
          <div className="text-center mb-8 sm:mb-16">
            <div className="inline-flex items-center gap-1 sm:gap-2 bg-gradient-to-r from-purple-100 to-pink-100 px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-medium text-purple-700 mb-3 sm:mb-4">
              <Users className="w-3 h-3 sm:w-4 sm:h-4" />
              {visitorCount.toLocaleString()}+ Africans reading success stories this month
            </div>
            
            <h1 className="text-2xl sm:text-4xl md:text-6xl font-bold mb-4 sm:mb-6 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent leading-tight">
              Japa News: Real Success Stories
            </h1>
            
            <p className="text-base sm:text-xl text-gray-700 max-w-3xl mx-auto mb-6 sm:mb-8">
              Breaking: Africans are winning their visa battles with AI guidance. Read the stories mainstream media won't tell you.
            </p>
          </div>

          <SmartProgressiveCTA />

          <div className="grid gap-4 sm:gap-6 md:gap-8 mb-8 sm:mb-16">
            {stories.map((story) => (
              <div key={story.slug} className="bg-white/30 backdrop-blur-sm border border-white/40 rounded-xl sm:rounded-3xl shadow-xl p-4 sm:p-6 md:p-8 group hover:scale-[1.02] transition-all duration-300">
                <div className="flex justify-between items-start mb-3 sm:mb-4">
                  <span className="px-2 sm:px-3 py-1 bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 rounded-full text-xs font-medium">
                    {story.readTime}
                  </span>
                  <div className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>

                <blockquote className="text-sm sm:text-lg font-semibold text-transparent bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text mb-3 sm:mb-4 leading-relaxed">
                  {story.hook}
                </blockquote>
                
                <h2 className="text-lg sm:text-xl md:text-2xl font-bold mb-2 sm:mb-3 group-hover:text-purple-600 transition-colors leading-tight">
                  {story.title}
                </h2>
                <p className="text-gray-600 text-sm sm:text-base mb-3 sm:mb-4">{story.excerpt}</p>
                
                <div className="text-xs sm:text-sm text-gray-500 mb-4 sm:mb-6">
                  <div className="mb-1">
                    <strong>{story.author}</strong> ‚Ä¢ {story.location}
                  </div>
                  <div className="text-transparent bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text font-semibold">
                    {story.outcome}
                  </div>
                </div>
                
                <Button variant="outline" asChild className="w-full border-purple-300 text-purple-700 hover:bg-purple-50 text-xs sm:text-sm">
                  <a href={`/blog/${story.slug}`} className="flex items-center justify-center gap-1 sm:gap-2">
                    Read Full Story <ArrowRight className="h-3 w-3 sm:h-4 sm:w-4" />
                  </a>
                </Button>
              </div>
            ))}
          </div>

          <div className="bg-white/30 backdrop-blur-sm border border-white/40 rounded-xl sm:rounded-3xl shadow-xl p-6 sm:p-8 md:p-12 text-center">
            <h2 className="text-xl sm:text-2xl md:text-3xl font-bold mb-4 sm:mb-6 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
              Your Success Story is Next
            </h2>
            <p className="text-base sm:text-xl text-gray-700 mb-6 sm:mb-8 max-w-2xl mx-auto">
              {user && hasKYC 
                ? "Continue your journey with AI Genie - pick up where you left off!"
                : "Join the AI-powered movement. Get your personalized visa roadmap in 3 minutes."
              }
            </p>
            
            <div className="grid grid-cols-3 gap-3 sm:gap-6 mb-6 sm:mb-8">
              <div className="text-center">
                <div className="text-lg sm:text-xl md:text-2xl font-bold text-purple-600">2,847</div>
                <div className="text-xs sm:text-sm text-gray-600">Visas Approved</div>
              </div>
              <div className="text-center">
                <div className="text-lg sm:text-xl md:text-2xl font-bold text-pink-600">94%</div>
                <div className="text-xs sm:text-sm text-gray-600">Success Rate</div>
              </div>
              <div className="text-center">
                <div className="text-lg sm:text-xl md:text-2xl font-bold text-blue-600">6 Months</div>
                <div className="text-xs sm:text-sm text-gray-600">Average Timeline</div>
              </div>
            </div>

            <Button 
              size="lg" 
              className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-sm sm:text-lg px-6 sm:px-8 py-3 sm:py-4" 
              onClick={handleSmartNavigation}
            >
              <CTAIcon className="mr-2 h-4 w-4 sm:h-5 sm:w-5" />
              {ctaDetails.text}
              <ArrowRight className="ml-2 h-4 w-4 sm:h-5 sm:w-5" />
            </Button>
            <p className="text-xs sm:text-sm text-gray-500 mt-3">
              {ctaDetails.description}
            </p>
          </div>
        </div>
      </section>

      {/* Fixed Bottom Banner */}
      <div className="fixed bottom-0 left-0 right-0 z-40 p-2 sm:p-4">
        <div className="max-w-4xl mx-auto">
          <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-purple-700 backdrop-blur-xl border border-white/20 rounded-xl sm:rounded-2xl shadow-2xl p-3 sm:p-4">
            <div className="flex flex-col sm:flex-row items-center gap-2 sm:gap-4">
              <div className="flex-1 text-center sm:text-left">
                <p className="text-white font-semibold text-xs sm:text-sm md:text-base">
                  {user && hasKYC ? "Continue with AI Genie" : "Ready to be our next success story?"}
                </p>
                <p className="text-purple-100 text-xs">
                  {user && hasKYC ? "Pick up where you left off" : "Join 2,847+ approved applicants"}
                </p>
              </div>
              <Button 
                className="bg-white/20 hover:bg-white/30 text-white text-xs sm:text-sm" 
                onClick={handleSmartNavigation}
              >
                <CTAIcon className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
                {ctaDetails.text}
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Exit Intent Popup */}
      {showExitIntent && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
          <div className="bg-white/90 backdrop-blur-sm border border-white/40 rounded-xl sm:rounded-3xl shadow-xl max-w-md w-full p-4 sm:p-6">
            <button onClick={() => setShowExitIntent(false)} className="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800">
              <X className="w-5 h-5 sm:w-6 sm:h-6" />
            </button>
            <h3 className="text-lg sm:text-xl font-bold mb-3 sm:mb-4">
              {user && hasKYC ? "Continue your visa journey" : "Wait! Get your free visa score"}
            </h3>
            <p className="text-gray-600 text-sm sm:text-base mb-4 sm:mb-6">
              {user && hasKYC 
                ? "Don't lose your progress! Continue with AI Genie to complete your visa plan."
                : "Before you leave, discover which visa you're closest to getting. Takes just 60 seconds."
              }
            </p>
            <div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
              <Button 
                className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white flex-1 text-sm sm:text-base" 
                onClick={handleSmartNavigation}
              >
                <CTAIcon className="w-4 h-4 mr-2" />
                {ctaDetails.text}
              </Button>
              <Button variant="outline" onClick={() => setShowExitIntent(false)} className="text-sm sm:text-base">
                Maybe Later
              </Button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
--- src/app/blog/amara-visa-rejection-reversal/page.tsx ---
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';

export default function AmaraStory() {
  return (
    <section className="py-20 bg-gray-50">
      <div className="container mx-auto px-4 max-w-4xl">
        <div className="mb-8">
          <Button variant="outline" asChild>
            <a href="/blog" className="flex items-center gap-2">
              <ArrowLeft className="h-4 w-4" /> Back to Japa News
            </a>
          </Button>
        </div>
        
        <article className="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
          <h1 className="text-3xl md:text-4xl font-bold mb-4">From Heartbreak to Toronto: Amara's Visa Rejection Reversal</h1>
          
          <div className="flex flex-wrap items-center gap-4 text-gray-600 mb-8">
            <span>Software Engineer from C√¥te d'Ivoire</span>
            <span>‚Ä¢</span>
            <span>Now in Toronto, Canada</span>
            <span>‚Ä¢</span>
            <span>CAD $85,000 salary</span>
          </div>

          <div className="prose max-w-none mb-8">
            <blockquote className="text-xl font-semibold text-primary border-l-4 border-primary pl-6 mb-6">
              "They rejected me three times. The fourth time, I got my Canadian PR."
            </blockquote>

            <p className="text-lg mb-4">
              Amara Kone faced three devastating visa rejections for Canada Express Entry. Each rejection letter crushed her dreams of joining her sister in Toronto. The immigration consultants she paid $3,000 kept giving generic advice that didn't address her specific weaknesses.
            </p>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Breaking Point</h3>
            <p>
              After the third rejection, Amara was ready to give up. She had spent her life savings on consultants who couldn't identify what was wrong with her application. That's when she discovered Japa Genie's AI-powered analysis.
            </p>

            <h3 className="text-2xl font-bold mt-6 mb-4">The AI Breakthrough</h3>
            <p>
              Japa Genie's AI identified the exact issues human consultants missed:
            </p>
            <ul className="list-disc pl-6 mb-4">
              <li>Weak proof of funds documentation</li>
              <li>Work experience descriptions that didn't match NOC codes</li>
              <li>Incorrect settlement funds calculation</li>
            </ul>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Transformation</h3>
            <p>
              Within 2 months of following Japa Genie's personalized roadmap, Amara:
            </p>
            <ul className="list-disc pl-6 mb-4">
              <li>Fixed her proof of funds with proper bank statements and gift deed documentation</li>
              <li>Rewrote her work experience to perfectly match NOC 2173 requirements</li>
              <li>Increased her CRS score from 438 to 472</li>
            </ul>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Victory</h3>
            <p>
              <strong>Fourth application: APPROVED.</strong> Amara landed in Toronto in March 2024 and now works as a Senior Developer at a fintech startup, earning CAD $85,000.
            </p>

            <blockquote className="text-lg font-medium text-gray-700 border-l-4 border-primary pl-6 mt-6">
              "Japa Genie didn't just fix my application - it rebuilt my confidence. The AI saw patterns the human consultants missed."
            </blockquote>
          </div>

          <div className="border-t pt-8 mt-8 text-center">
            <h3 className="text-xl font-bold mb-4">Ready to Write Your Success Story?</h3>
            <p className="text-gray-600 mb-6">
              Get your personalized visa analysis like Amara did. Discover what's holding you back and get your roadmap to success.
            </p>
            <Button className="bg-primary hover:bg-primary/90" asChild>
              <a href="/kyc">Start Your Japa Journey</a>
            </Button>
          </div>
        </article>
      </div>
    </section>
  );
}

--- src/app/blog/kwame-teacher-to-uk-global-talent/page.tsx ---
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';

export default function KwameStory() {
  return (
    <section className="py-20 bg-gray-50">
      <div className="container mx-auto px-4 max-w-4xl">
        <div className="mb-8">
          <Button variant="outline" asChild>
            <a href="/blog" className="flex items-center gap-2">
              <ArrowLeft className="h-4 w-4" /> Back to Japa News
            </a>
          </Button>
        </div>
        
        <article className="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
          <h1 className="text-3xl md:text-4xl font-bold mb-4">The Impossible Dream: From Teacher to UK Global Talent</h1>
          
          <div className="flex flex-wrap items-center gap-4 text-gray-600 mb-8">
            <span>Math Teacher from Rural Ghana</span>
            <span>‚Ä¢</span>
            <span>Now in London, UK</span>
            <span>‚Ä¢</span>
            <span>¬£65,000 salary</span>
          </div>

          <div className="prose max-w-none mb-8">
            <blockquote className="text-xl font-semibold text-primary border-l-4 border-primary pl-6 mb-6">
              "Everyone said teachers can't get UK Global Talent visas. I proved them wrong."
            </blockquote>

            <p className="text-lg mb-4">
              Kwame Asante taught mathematics in rural Ghana for 8 years, earning just $200 monthly. His dream of reaching the UK seemed impossible - he wasn't a tech entrepreneur or acclaimed researcher. Immigration lawyers laughed when he mentioned the Global Talent visa.
            </p>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Hidden Potential</h3>
            <p>
              But Kwame had been developing innovative math education apps in his spare time, used by over 10,000 African students. He just didn't know how to package his achievements for visa success.
            </p>

            <h3 className="text-2xl font-bold mt-6 mb-4">The AI Discovery</h3>
            <p>
              Japa Genie's AI analyzed Kwame's background and identified something remarkable: his educational technology work qualified for the "Digital Technology" category of the Global Talent visa. The AI guided him to:
            </p>
            <ul className="list-disc pl-6 mb-4">
              <li>Document his app's impact with user testimonials and download statistics</li>
              <li>Get endorsements from education technology leaders</li>
              <li>Present his work as scalable innovation, not just teaching</li>
            </ul>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Strategic Pivot</h3>
            <p>
              Instead of applying as a teacher (impossible for Global Talent), Kwame repositioned himself as an EdTech innovator. His apps had:
            </p>
            <ul className="list-disc pl-6 mb-4">
              <li>50,000+ downloads across 12 African countries</li>
              <li>Testimonials from students who improved grades by 40%</li>
              <li>Recognition from UNESCO for innovative education solutions</li>
            </ul>

            <h3 className="text-2xl font-bold mt-6 mb-4">The Breakthrough</h3>
            <p>
              Six months later: <strong>Global Talent visa APPROVED.</strong>
            </p>
            <p>
              Kwame now leads educational technology initiatives at a London-based EdTech company, earning ¬£65,000. His apps have reached over 100,000 students across Africa.
            </p>

            <blockquote className="text-lg font-medium text-gray-700 border-l-4 border-primary pl-6 mt-6">
              "I was selling myself short. Japa Genie's AI helped me see my true value and present it properly. Now I'm building the future of African education from London."
            </blockquote>
          </div>

          <div className="border-t pt-8 mt-8 text-center">
            <h3 className="text-xl font-bold mb-4">What Hidden Talents Do You Have?</h3>
            <p className="text-gray-600 mb-6">
              Like Kwame, you might be closer to your visa goal than you think. Let Japa Genie's AI analyze your unique profile and find your pathway.
            </p>
            <Button className="bg-primary hover:bg-primary/90" asChild>
              <a href="/kyc">Discover Your Potential</a>
            </Button>
          </div>
        </article>
      </div>
    </section>
  );
}

--- src/app/terms-and-conditions/page.tsx ---
// src/app/terms-and-conditions/page.tsx
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export default function TermsPage() {
  return (
    <div className="container max-w-4xl mx-auto py-12 px-4">
      <Card>
        <CardHeader>
          <CardTitle className="text-3xl font-bold text-center">Terms & Conditions</CardTitle>
        </CardHeader>
        <CardContent className="prose max-w-none">
          <p className="text-center text-sm text-muted-foreground">
            <em>Last updated: {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</em>
          </p>

          <h2 className="text-xl font-semibold mt-6">1. DEFINITIONS</h2>
          <p><strong>‚ÄúJapa Genie‚Äù, ‚Äúwe‚Äù, ‚Äúus‚Äù or ‚Äúour‚Äù</strong> means <strong>Japa Genie Inc.</strong>, a corporation incorporated under the <strong>Canada Business Corporations Act</strong>.</p>
          <p><strong>‚ÄúService‚Äù</strong> means our AI-powered visa guidance web app.</p>

          <h2 className="text-xl font-semibold mt-6">2. ACCEPTANCE</h2>
          <p>By creating an account or making a payment, you agree to these Terms and our Privacy Policy. If you do not agree, do not use the Service.</p>

          <h2 className="text-xl font-semibold mt-6">3. SERVICE DESCRIPTION & DISCLAIMERS</h2>
          <p>Japa Genie provides algorithmic recommendations, checklists, and AI-generated mock interviews. We are <strong>not</strong> a law firm or immigration consultant. Nothing provided constitutes legal advice or guarantees visa approval. Immigration authorities make independent decisions.</p>

          <h2 className="text-xl font-semibold mt-6">4. FEES, BILLING & REFUNDS</h2>
          <p>Premium features are billed as described on our pricing page. You may cancel subscriptions at any time. Our refund policy is as follows:</p>
          <ul>
            <li>Users in Qu√©bec and Ontario may cancel within 7 days for a pro-rata refund of unused full months.</li>
            <li>Outside those provinces, refunds are discretionary.</li>
            <li>Services already substantially used (e.g., AI roadmap generation, mock interviews) are considered rendered and non-refundable.</li>
          </ul>

          <h2 className="text-xl font-semibold mt-6">5. GOVERNING LAW & DISPUTE RESOLUTION</h2>
          <p>These Terms are governed by the laws of Ontario, Canada. Disputes shall be resolved by binding arbitration in Toronto.</p>
          
          <p className="text-center font-bold mt-8">
            ¬© {new Date().getFullYear()} Japa Genie Inc. ‚Äì All rights reserved.
          </p>
        </CardContent>
      </Card>
    </div>
  )
}

--- src/app/eligibility/page.tsx ---
import { Suspense } from "react";
import EligibilityCheckClient from './client';

function EligibilityContent() {
  return (
    <div className="container py-12 space-y-8">
      <EligibilityCheckClient />
    </div>
  );
}

export default function EligibilityCheckPage() {
  return (
    <Suspense fallback={<div className="container py-12">Loading eligibility check...</div>}>
      <EligibilityContent />
    </Suspense>
  );
}

--- src/app/visitor-chat/page.tsx ---
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { MessageCircle } from 'lucide-react';
import ChatPanel from '@/components/layout/chat-panel';

export default function VisitorChatPage() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <div className="min-h-screen bg-background">
      <Button
        onClick={() => setIsOpen(true)}
        size="icon"
        className="fixed bottom-6 right-6 z-50 h-14 w-14 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 shadow-lg transition-transform hover:scale-110"
        aria-label="Open AI Chat"
      >
        <MessageCircle className="h-7 w-7" />
      </Button>
      <Sheet open={isOpen} onOpenChange={setIsOpen}>
        <SheetContent className="w-full max-w-md p-0 flex flex-col">
          <SheetHeader className="p-4 border-b">
            <SheetTitle>Japa Genie Assistant</SheetTitle>
          </SheetHeader>
          <div className="flex-1 overflow-y-auto">
            <ChatPanel />
          </div>
        </SheetContent>
      </Sheet>
    </div>
  );
}

--- src/app/priority-processing/page.tsx ---

import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Zap, Clock, Shield, ArrowRight } from 'lucide-react';
import Link from 'next/link';

export default function PriorityProcessingPage() {
  return (
    <div className="space-y-8">
      <header className="space-y-2 text-center max-w-3xl mx-auto">
        <h1 className="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-amber-400 to-primary bg-clip-text text-transparent">
          Fast-Track Your Visa Application
        </h1>
        <p className="text-lg text-muted-foreground">
          Visa processing can be slow and unpredictable. Discover insider strategies and official programs to reduce your wait time and get your decision faster.
        </p>
      </header>
      
      <div className="grid md:grid-cols-2 gap-6">
        <Card className="flex flex-col">
          <CardHeader className="flex-1">
            <div className="flex items-start gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <Zap className="w-7 h-7" />
                </div>
                <div className="flex-1">
                    <CardTitle>Official Expedited Programs</CardTitle>
                    <CardDescription>Identify if your destination country offers premium processing services (like the US Premium Processing) and learn how to qualify and apply for them.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
        <Card className="flex flex-col">
          <CardHeader className="flex-1">
            <div className="flex items-start gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <Clock className="w-7 h-7" />
                </div>
                <div className="flex-1">
                    <CardTitle>Strategic Application Timing</CardTitle>
                    <CardDescription>Avoid peak submission periods. We analyze historical data to recommend the best months to apply for quicker turnaround times at specific embassies.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
         <Card className="flex flex-col">
          <CardHeader className="flex-1">
             <div className="flex items-start gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <Shield className="w-7 h-7" />
                </div>
                <div className="flex-1">
                    <CardTitle>Flawless Application Method</CardTitle>
                    <CardDescription>A perfectly prepared, error-free application is less likely to face delays. Use our Document Checker to ensure your submission is pristine from day one.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
         <Card className="flex flex-col">
          <CardHeader className="flex-1">
            <div className="flex items-start gap-4">
                <div className="p-3 bg-primary/10 rounded-full text-primary">
                    <ArrowRight className="w-7 h-7" />
                </div>
                <div className="flex-1">
                    <CardTitle>Direct Consular Follow-up</CardTitle>
                    <CardDescription>Learn the professional and correct way to inquire about your case status after the standard processing time has passed, without jeopardizing your application.</CardDescription>
                </div>
            </div>
          </CardHeader>
        </Card>
      </div>

      <Card className="text-center bg-primary/5 border-primary/20">
        <CardHeader>
          <CardTitle>Ready to Speed Things Up?</CardTitle>
          <CardDescription className="mb-4">Let Japa Genie build a personalized priority roadmap for you.</CardDescription>
          <Button asChild>
            <Link href="/kyc">Get My Priority Plan</Link>
          </Button>
        </CardHeader>
      </Card>
    </div>
  );
}

--- src/app/experts/page.tsx ---
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { CheckCircle, Star, Users, Shield, Clock, MessageCircle, FileText, Plane } from 'lucide-react';
import Link from 'next/link';

const experts = [
  {
    name: "Sarah Chen",
    role: "Canada Study Visa Specialist",
    experience: "8+ years",
    successRate: "94%",
    specialty: "Student Visas, Proof of Funds",
    description: "Former visa officer with deep knowledge of Canadian immigration policies. Helped 500+ African students get approved.",
    features: ["Document Review", "Interview Prep", "Proof of Funds Plan", "Unlimited Q&A"]
  },
  {
    name: "David Okafor",
    role: "UK Work Visa Expert", 
    experience: "12+ years",
    successRate: "91%",
    specialty: "Skilled Worker Visas, Sponsorship",
    description: "UK immigration consultant with track record of helping tech professionals relocate from Nigeria and Ghana.",
    features: ["CV Optimization", "Sponsor Matching", "Application Strategy", "Priority Support"]
  },
  {
    name: "Amina Bello",
    role: "US Visitor Visa Specialist",
    experience: "6+ years",
    successRate: "89%",
    specialty: "B1/B2 Visas, Family Sponsorship",
    description: "Expert in overcoming visa denials and building strong cases for African families visiting the US.",
    features: ["Overcoming Rejection", "Family Applications", "Financial Documentation", "Embassy Prep"]
  }
];

const services = [
  {
    icon: FileText,
    title: "Document Review",
    description: "Get your application documents checked by experts before submission.",
  },
  {
    icon: MessageCircle,
    title: "Mock Interview",
    description: "Practice with former visa officers who know what embassies really look for.",
  },
  {
    icon: Shield,
    title: "Full Application Support",
    description: "End-to-end guidance from document prep to interview readiness.",
  },
  {
    icon: Plane,
    title: "Fast-Track Consultation", 
    description: "Quick answers to urgent questions before your interview or submission.",
  }
];

export default function ExpertsPage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white py-12">
      <div className="container mx-auto px-4 max-w-6xl">
        {/* Header */}
        <div className="text-center mb-16">
          <Badge className="mb-4 bg-orange-100 text-orange-800 hover:bg-orange-100">
            <Shield className="w-3 h-3 mr-1" />
            Verified Experts
          </Badge>
          <h1 className="text-4xl md:text-5xl font-bold tracking-tight mb-4">
            Get Help from Trusted Visa Experts
          </h1>
          <p className="text-xl text-muted-foreground max-w-2xl mx-auto">
            When AI isn't enough, connect with our network of verified immigration consultants with proven success helping African applicants.
          </p>
        </div>

        {/* Why Choose Human Experts */}
        <div className="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 mb-16">
          <h2 className="text-3xl font-bold text-center mb-12">Why Choose Human Experts?</h2>
          <div className="grid md:grid-cols-3 gap-8">
            <div className="text-center">
              <div className="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="w-6 h-6 text-green-600" />
              </div>
              <h3 className="font-semibold mb-2">Proven Track Records</h3>
              <p className="text-sm text-muted-foreground">Our experts have 85%+ success rates with African applicants</p>
            </div>
            <div className="text-center">
              <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <Shield className="w-6 h-6 text-blue-600" />
              </div>
              <h3 className="font-semibold mb-2">Thoroughly Vetted</h3>
              <p className="text-sm text-muted-foreground">Every expert verified through background checks and client reviews</p>
            </div>
            <div className="text-center">
              <div className="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <Star className="w-6 h-6 text-purple-600" />
              </div>
              <h3 className="font-semibold mb-2">Specialized Knowledge</h3>
              <p className="text-sm text-muted-foreground">Country-specific expertise for your target destination</p>
            </div>
          </div>
        </div>

        {/* Featured Experts */}
        <div className="mb-16">
          <h2 className="text-3xl font-bold text-center mb-12">Meet Our Verified Experts</h2>
          <div className="grid md:grid-cols-3 gap-8">
            {experts.map((expert, index) => (
              <Card key={index} className="hover:shadow-lg transition-all border-2 border-transparent hover:border-orange-200">
                <CardHeader>
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <CardTitle className="text-xl">{expert.name}</CardTitle>
                      <CardDescription>{expert.role}</CardDescription>
                    </div>
                    <Badge variant="secondary" className="bg-green-100 text-green-800">
                      {expert.successRate} Success
                    </Badge>
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center text-sm">
                      <Clock className="w-4 h-4 mr-2 text-muted-foreground" />
                      {expert.experience} experience
                    </div>
                    <div className="flex items-center text-sm">
                      <Users className="w-4 h-4 mr-2 text-muted-foreground" />
                      {expert.specialty}
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <p className="text-sm text-muted-foreground mb-4">{expert.description}</p>
                  <div className="space-y-2 mb-6">
                    {expert.features.map((feature, idx) => (
                      <div key={idx} className="flex items-center text-sm">
                        <CheckCircle className="w-4 h-4 mr-2 text-green-500" />
                        {feature}
                      </div>
                    ))}
                  </div>
                  <div className="flex items-center justify-between">
                    <Badge variant="secondary" className="bg-orange-100 text-orange-800">Premium Feature</Badge>
                    <Button asChild className="bg-orange-500 hover:bg-orange-600 text-sm px-3">
                      <Link href="/contact-us">Book Now</Link>
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        {/* Services */}
        <div className="mb-16">
          <h2 className="text-3xl font-bold text-center mb-12">Popular Services</h2>
          <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            {services.map((service, index) => (
              <Card key={index} className="text-center hover:shadow-md transition-all">
                <CardHeader>
                  <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                    <service.icon className="w-6 h-6 text-blue-600" />
                  </div>
                  <CardTitle className="text-lg">{service.title}</CardTitle>
                  <CardDescription>{service.description}</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    <Button asChild variant="outline" className="w-full">
                      <Link href="/your-next-steps">Sign Up</Link>
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        {/* CTA Section */}
        <div className="text-center">
          <Card className="bg-gradient-to-r from-blue-500 to-purple-600 text-white border-0">
            <CardContent className="pt-6">
              <h3 className="text-2xl font-bold mb-4">Not Sure Which Expert to Choose?</h3>
              <p className="mb-6 opacity-90">
                Let us match you with the perfect expert for your specific situation.
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <Button size="lg" className="bg-white text-blue-600 hover:bg-blue-50" asChild>
                  <Link href="/contact-us">Get Matched with an Expert</Link>
                </Button>
                <Button size="lg" variant="outline" className="border-white/50 text-white hover:bg-white/10 bg-white/10" asChild>
                  <Link href="/contact-us">Speak to Our Team</Link>
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}

--- src/app/your-next-steps/page.tsx ---
import { Suspense } from 'react';
import YourNextStepsClient from './client';

export default function YourNextStepsPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading plans...</p>
        </div>
      </div>
    }>
      <YourNextStepsClient />
    </Suspense>
  );
}

--- src/app/contact-us/page.tsx ---
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from "@/components/ui/card";

export default function ContactUsPage() {
  return (
    <div className="container max-w-2xl mx-auto py-12 px-4">
        <Card>
            <CardHeader className="text-center">
                <CardTitle className="text-3xl">Contact Us</CardTitle>
                <CardDescription>We'd love to hear from you. Here's how you can reach us.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4 text-center">
                <div>
                    <h3 className="font-semibold">General Support & Inquiries</h3>
                    <p className="text-primary">support@japagenie.com</p>
                </div>
                <div>
                    <h3 className="font-semibold">Partnerships</h3>
                    <p className="text-primary">partners@japagenie.com</p>
                </div>
                <div>
                    <h3 className="font-semibold">Press & Media</h3>
                    <p className="text-primary">media@japagenie.com</p>
                </div>
                <p className="text-sm text-muted-foreground pt-4">
                    Our team will get back to you within 24-48 business hours.
                </p>
            </CardContent>
        </Card>
    </div>
  )
}

--- src/app/mock-interview/page.tsx ---
import InterviewClient from './client';

export default function InterviewPage() {
  return (
    <div className="space-y-8">
      <header className="space-y-2">
        <h1 className="text-4xl font-bold tracking-tight">AI Mock Interview</h1>
        <p className="text-lg text-muted-foreground">
          Prepare for your visa interview with realistic questions generated by AI.
        </p>
      </header>
      <InterviewClient />
    </div>
  );
}

=== 2. ALL API ROUTES ===
--- src/app/api/create-checkout/route.ts ---
// src/app/api/create-checkout/route.ts - UPDATE SUCCESS URL ONLY
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '@/lib/stripe/stripe-server';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { name, price, duration } = await request.json();

    if (!price) {
      return NextResponse.json({ error: 'Price required' }, { status: 400 });
    }

    const session = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      line_items: [
        {
          price_data: {
            currency: 'usd',
            product_data: {
              name: name,
              description: duration || 'Premium access',
            },
            unit_amount: Math.round(price * 100),
          },
          quantity: 1,
        },
      ],
      mode: 'payment',
      // ‚úÖ UPDATED: Point to our payment-success handler
      success_url: `${request.headers.get('origin')}/api/payment-success?returnTo=/dashboard&plan=pro`,
      cancel_url: `${request.headers.get('origin')}/checkout?canceled=true`,
      client_reference_id: user.id,
      customer_email: user.email,
      metadata: {
        userId: user.id,
        planName: name,
      },
    });

    return NextResponse.json({ url: session.url });
  } catch (error) {
    console.error('Stripe error:', error);
    return NextResponse.json({ error: 'Payment failed' }, { status: 500 });
  }
}
--- src/app/api/paystack/create/route.ts ---
// src/app/api/paystack/create/route.ts - UPDATE SUCCESS URL ONLY
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

// Fixed exchange rate (update periodically)
const USD_TO_NGN_RATE = 1500;

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { name, price, duration } = await request.json();

    if (!price) {
      return NextResponse.json({ error: 'Plan price required' }, { status: 400 });
    }

    // Convert USD to NGN
    const priceInNGN = price * USD_TO_NGN_RATE;
    const amount = Math.round(priceInNGN * 100); // Kobo
    const reference = `tx_${user.id}_${Date.now()}`;

    console.log(`üí∞ Converting: $${price} USD = ‚Ç¶${priceInNGN.toLocaleString()} NGN`);

    const response = await fetch('https://api.paystack.co/transaction/initialize', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.PAYSTACK_SECRET_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        amount,
        email: user.email,
        currency: 'NGN',
        reference,
        // ‚úÖ UPDATED: Point to our payment-success handler
        callback_url: `${request.headers.get('origin')}/api/payment-success?returnTo=/dashboard&plan=pro`,
        metadata: {
          userId: user.id,
          planName: name,
          planDuration: duration,
          usdPrice: price,
          ngnPrice: priceInNGN,
          exchangeRate: USD_TO_NGN_RATE,
        },
        channels: ['card', 'bank_transfer', 'ussd', 'mobile_money'],
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Paystack initialize error:', errorData);
      throw new Error(errorData.message || 'Initialize failed');
    }

    const data = await response.json();
    return NextResponse.json({
      url: data.data.authorization_url,
      reference: data.data.reference,
      ngnAmount: priceInNGN,
      usdAmount: price,
    });
  } catch (error: any) {
    console.error('Paystack error:', error);
    return NextResponse.json({ 
      error: error.message || 'Failed to create Paystack session' 
    }, { status: 500 });
  }
}
--- src/app/api/rejection-reversal/route.ts ---
import { groq } from '@/lib/groq-client';
import { NextRequest, NextResponse } from 'next/server';


export async function POST(request: NextRequest) {
  try {
    const body = await request.json();

    if (!body.visaType || !body.destination || !body.userBackground) {
      return NextResponse.json(
        { error: 'Missing required fields: visaType, destination, and userBackground are required' },
        { status: 400 }
      );
    }

    const prompt = `You are an expert visa rejection reversal strategist.

User Details:
- Visa Type: ${body.visaType}
- Destination: ${body.destination}
- Background: ${body.userBackground}
${body.rejectionReason ? `- Rejection Reason: ${body.rejectionReason}` : ''}
${body.previousAttempts ? `- Previous Attempts: ${body.previousAttempts}` : ''}

Generate a comprehensive rejection reversal strategy with:

1. IMMEDIATE ACTION PLAN (what to do in the next 7 days)
2. DOCUMENTATION FIXES (specific documents to improve)
3. APPEAL/REAPPLICATION STRATEGY (timeline and approach)
4. COMMON PITFALLS TO AVOID
5. SUCCESS RATE ESTIMATE (percentage and reasoning)

Return as JSON in this exact format:
{
  "immediateActions": ["action 1", "action 2", "action 3"],
  "documentationFixes": {
    "required": ["doc 1", "doc 2"],
    "recommended": ["doc 3", "doc 4"]
  },
  "strategy": {
    "timelineWeeks": 8,
    "approach": "Detailed approach description",
    "estimatedSuccessRate": 75
  },
  "pitfalls": ["pitfall 1", "pitfall 2"],
  "professionalHelp": "When to consult an immigration lawyer"
}`;

    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { 
          role: 'system', 
          content: 'You are an expert immigration consultant specializing in visa rejection reversals. Return ONLY valid JSON, no other text.' 
        },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 1500
    });

    const responseText = completion.choices[0]?.message?.content?.trim() || '';
    const cleanText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    let result;
    try {
      result = JSON.parse(cleanText);
    } catch (parseError) {
      console.error('JSON parse error:', parseError);
      // Fallback response
      result = {
        immediateActions: ["Review rejection letter carefully", "Consult with an immigration expert", "Gather all required documents"],
        documentationFixes: {
          required: ["Updated bank statements", "Revised invitation letter"],
          recommended: ["Professional cover letter", "Additional supporting evidence"]
        },
        strategy: {
          timelineWeeks: 8,
          approach: "Reapply with stronger documentation and address all rejection points",
          estimatedSuccessRate: 65
        },
        pitfalls: ["Rushing reapplication", "Not addressing all rejection reasons"],
        professionalHelp: "Consult lawyer if multiple rejections or complex case"
      };
    }

    return NextResponse.json(result);
    
  } catch (error: any) {
    console.error('Rejection reversal error:', error.message || error);
    return NextResponse.json(
      { 
        error: 'Failed to generate strategy',
        fallback: {
          immediateActions: ["Review the rejection reasons carefully", "Consider professional consultation"],
          documentationFixes: { required: [], recommended: [] },
          strategy: { timelineWeeks: 12, approach: "Standard reapplication", estimatedSuccessRate: 50 },
          pitfalls: [],
          professionalHelp: "Recommended for all rejection cases"
        }
      },
      { status: 500 }
    );
  }
}

export const dynamic = 'force-dynamic';

--- src/app/api/chat/route.ts ---
// src/app/api/chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { visaChatAssistant } from '@/ai/flows/visa-chat-assistant';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { question, wishCount = 1, conversationHistory = [], userContext, isSignedIn = false } = body;

    if (!question || typeof question !== 'string') {
      return NextResponse.json({ error: 'Question required' }, { status: 400 });
    }

    let realUserContext = userContext || {};
    let isUserSignedIn = isSignedIn;

    // REAL DATA PIPELINE
    if (!isSignedIn) {
      realUserContext = userContext || {};
    } else {
      const supabase = await createClient();
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      
      if (user && !authError) {
        const { data: profile } = await supabase.from('user_profiles').select('*').eq('id', user.id).single();
        
        if (profile) {
          realUserContext = {
            name: profile.preferred_name || user.user_metadata?.name || user.email?.split('@')[0],
            country: profile.country,
            destination: profile.destination_country,
            visaType: profile.visa_type,
            profession: profile.profession,
            userType: profile.user_type,
            timelineUrgency: profile.timeline_urgency,
            age: profile.age,
          };
        }
      }
    }

    // ADD LOGGING TO SEE WHAT'S BEING SENT
    console.log('üì§ Sending to visaChatAssistant:', {
      question: question.substring(0, 50) + '...',
      wishCount,
      hasHistory: conversationHistory.length > 0,
      userContext: realUserContext,
      isSignedIn: isUserSignedIn
    });

    const result = await visaChatAssistant({
      question,
      wishCount,
      conversationHistory,
      userContext: realUserContext,
      isSignedIn: isUserSignedIn,
    });

    console.log('‚úÖ visaChatAssistant returned successfully');
    return NextResponse.json(result);
    
  } catch (error: any) {
    // ENHANCED ERROR LOGGING
    console.error('‚ùå Chat API error:', error);
    console.error('Error stack:', error.stack);
    console.error('Error message:', error.message);
    
    return NextResponse.json({ 
      error: 'Failed to process question', 
      details: error.message,
      errorType: error.constructor.name
    }, { status: 500 });
  }
}
--- src/app/api/generate-report/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { generatePersonalizedReport } from '@/ai/flows/report-generator';

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    if (!body.analysisResult) return NextResponse.json({ error: 'analysisResult required' }, { status: 400 });
    const report = await generatePersonalizedReport(body.analysisResult, body.targetCountry || 'General', body.visaType || 'Tourist');
    return NextResponse.json(report);
  } catch (e: any) {
    return NextResponse.json({ error: e.message }, { status: 500 });
  }
}

--- src/app/api/test/route.ts ---
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    const body = await request.json();
    return NextResponse.json({ 
      status: 'OK', 
      message: 'Basic API is working',
      received: body 
    });
  } catch (error: any) {
    return NextResponse.json({ 
      error: 'Test failed', 
      details: error.message 
    }, { status: 500 });
  }
}

--- src/app/api/insights/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { generateInsights } from '@/ai/insights-generator';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  let userQuestion: string | undefined;
  let userId: string | undefined;
  
  try {
    const body = await request.json();
    const { question, userId: requestUserId } = body;
    userQuestion = question;
    userId = requestUserId;

    if (!userQuestion || userQuestion.trim().length === 0) {
      return NextResponse.json(
        { error: 'Question is required and cannot be empty' }, 
        { status: 400 }
      );
    }

    console.log('üîÑ Generating premium insights for question:', userQuestion.substring(0, 100));

    let userProfile = undefined;
    
    if (userId) {
      try {
        const supabase = await createClient();
        const { data: profile, error: profileError } = await supabase
          .from('user_profiles')
          .select('age, profession, country, destination_country, visa_type')
          .eq('id', userId)
          .single();

        if (profile && !profileError) {
          userProfile = {
            age: profile.age,
            profession: profile.profession,
            country: profile.country,
            destinationCountry: profile.destination_country,
            visaType: profile.visa_type,
          };
          console.log('‚úÖ User profile loaded for personalization:', {
            country: userProfile.country,
            destination: userProfile.destinationCountry,
          });
        }
      } catch (profileFetchError) {
        console.error('‚ùå Error fetching user profile:', profileFetchError);
      }
    }

    let insights;
    let attempts = 0;
    const maxAttempts = 3;
    let lastError;

    while (attempts < maxAttempts) {
      try {
        attempts++;
        console.log(`üîÑ Attempt ${attempts}/${maxAttempts} to generate insights...`);
        
        // CALL WITH JUST question - NO userProfile parameter
        insights = await generateInsights({ 
          question: userQuestion
        });

        if (insights && insights.insights && insights.insights.length > 0) {
          console.log('‚úÖ Premium insights generated successfully on attempt', attempts);
          break;
        } else {
          throw new Error('AI returned empty insights');
        }
        
      } catch (attemptError: any) {
        lastError = attemptError;
        console.error(`‚ùå Attempt ${attempts} failed:`, attemptError.message);
        
        if (attempts < maxAttempts) {
          const delay = Math.min(1000 * Math.pow(2, attempts - 1), 5000);
          console.log(`‚è≥ Waiting ${delay}ms before retry...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    if (!insights || !insights.insights || insights.insights.length === 0) {
      throw lastError || new Error('Failed to generate insights after all retries');
    }

    if (userId) {
      try {
        const supabase = await createClient();
        
        const { error: saveError } = await supabase
          .from('visa_insights')
          .insert({
            user_id: userId,
            insight_data: insights,
            question: userQuestion,
            created_at: new Date().toISOString(),
          });

        if (!saveError) {
          console.log('‚úÖ Insights saved to database for user:', userId);
        }
      } catch (dbError) {
        console.error('‚ùå Database save error:', dbError);
      }
    }

    return NextResponse.json(insights, { 
      status: 200,
      headers: {
        'Content-Type': 'application/json',
      }
    });

  } catch (error: any) {
    console.error('‚ùå Critical error in insights API:', error);

    return NextResponse.json({
      insights: [
        {
          headline: 'Service Temporarily Unavailable',
          detail: 'The Genie is experiencing technical difficulties. Please try again in a moment, or rephrase your question.',
          url: undefined,
        }
      ],
      costEstimates: [],
      visaAlternatives: [],
      genieRecommendation: undefined,
      levelUpSuggestions: undefined,
      similarCountries: undefined,
      insiderTips: undefined,
      chartData: undefined,
      timeline: undefined,
      alternativeStrategies: undefined,
      error: true,
      errorMessage: error.message || 'Unknown error occurred',
    }, { 
      status: 500 
    });
  }
}

export async function OPTIONS(request: NextRequest) {
  return new NextResponse(null, {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    },
  });
}
--- src/app/api/debug-my-sub/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user) {
      return NextResponse.json({ error: 'Not signed in' });
    }
    
    console.log('üîç Checking subscription for user:', user.id);
    
    // Check ALL subscriptions for this user
    const { data: subscriptions, error } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', user.id);
    
    if (error) {
      return NextResponse.json({ error: 'Database error: ' + error.message });
    }
    
    return NextResponse.json({ 
      user_id: user.id,
      has_subscriptions: subscriptions?.length > 0,
      subscriptions: subscriptions,
      subscription_count: subscriptions?.length || 0
    });
    
  } catch (error: any) {
    return NextResponse.json({ error: 'Debug error: ' + error.message });
  }
}

--- src/app/api/visa-matchmaker/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { visaMatchmaker } from '@/ai/flows/visa-matchmaker';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const results = await visaMatchmaker(body);
    return NextResponse.json(results);
  } catch (error: any) {
    console.error('API Error:', error);
    return NextResponse.json(
      { error: 'AI service failed: ' + error.message },
      { status: 500 }
    );
  }
}

--- src/app/api/generate-pof-pdf/route.ts ---
// src/app/api/generate-pof-pdf/route.ts - PREMIUM ONE-PAGER
import { NextResponse } from 'next/server';
import { PDFDocument, StandardFonts, rgb, degrees } from 'pdf-lib';

export const runtime = 'nodejs';

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { analysisData, userProfile } = body;

    const pdfDoc = await PDFDocument.create();
    const page = pdfDoc.addPage([595, 842]); // A4
    const { width, height } = page.getSize();
    
    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
    const fontRegular = await pdfDoc.embedFont(StandardFonts.Helvetica);

    let y = height - 40;
    const margin = 40;
    const contentWidth = width - (2 * margin);

    // === HEADER SECTION ===
    page.drawText('JAPA GENIE', {
      x: margin,
      y,
      size: 32,
      font: fontBold,
      color: rgb(0.09, 0.32, 0.68),
    });

    page.drawText('PROOF OF FUNDS INTELLIGENCE', {
      x: margin,
      y: y - 25,
      size: 11,
      font: fontRegular,
      color: rgb(0.4, 0.4, 0.4),
    });

    // PRE-APPROVED Stamp
    const stampX = width - 200;
    const stampY = y - 10;
    page.drawRectangle({
      x: stampX,
      y: stampY,
      width: 160,
      height: 35,
      borderColor: rgb(0, 0.6, 0),
      borderWidth: 3,
      color: rgb(0.9, 1, 0.9),
    });
    page.drawText('PRE-APPROVED', {
      x: stampX + 15,
      y: stampY + 10,
      size: 16,
      font: fontBold,
      color: rgb(0, 0.6, 0),
    });

    y -= 70;

    // === REPORT METADATA ===
    page.drawRectangle({
      x: margin,
      y: y - 50,
      width: contentWidth,
      height: 50,
      color: rgb(0.95, 0.97, 1),
    });

    page.drawText(`Embassy: ${analysisData.embassy}`, {
      x: margin + 10,
      y: y - 20,
      size: 11,
      font: fontBold,
    });

    page.drawText(`Report Date: ${new Date().toLocaleDateString('en-NG', { day: 'numeric', month: 'long', year: 'numeric' })}`, {
      x: margin + 10,
      y: y - 38,
      size: 9,
      font: fontRegular,
      color: rgb(0.3, 0.3, 0.3),
    });

    page.drawText(`Applicant Age: ${userProfile.age} | Family: ${userProfile.familyMembers} | Timeline: ${userProfile.travelTimeline}`, {
      x: width - 350,
      y: y - 38,
      size: 9,
      font: fontRegular,
      color: rgb(0.3, 0.3, 0.3),
    });

    y -= 80;

    // === APPROVAL PREDICTION ===
    const bannerHeight = 60;
    const approvalScore = analysisData.riskScore || 94;
    const bannerColor = approvalScore >= 80 ? rgb(0, 0.6, 0) : approvalScore >= 60 ? rgb(0.9, 0.6, 0) : rgb(0.9, 0, 0);

    page.drawRectangle({
      x: margin,
      y: y - bannerHeight,
      width: contentWidth,
      height: bannerHeight,
      color: bannerColor,
    });

    page.drawText(`${approvalScore}% APPROVAL PREDICTION`, {
      x: margin + 140,
      y: y - 35,
      size: 24,
      font: fontBold,
      color: rgb(1, 1, 1),
    });

    y -= bannerHeight + 30;

    // === HELPER FUNCTIONS ===
    const drawSectionHeader = (title: string) => {
      page.drawText(title, {
        x: margin,
        y,
        size: 14,
        font: fontBold,
        color: rgb(0.09, 0.32, 0.68),
      });
      y -= 25;
    };

    const drawBullet = (text: string, isGood: boolean = true) => {
      const bulletColor = isGood ? rgb(0, 0.6, 0) : rgb(0.9, 0, 0);
      page.drawText('‚óè', {
        x: margin + 5,
        y,
        size: 10,
        font: fontBold,
        color: bulletColor,
      });
      
      const maxWidth = contentWidth - 20;
      const words = text.split(' ');
      let line = '';
      let lines = [];
      
      words.forEach(word => {
        const testLine = line + word + ' ';
        if (testLine.length * 5 < maxWidth) {
          line = testLine;
        } else {
          lines.push(line);
          line = word + ' ';
        }
      });
      lines.push(line);
      
      lines.forEach((l, i) => {
        page.drawText(l.trim(), {
          x: margin + 20,
          y: y - (i * 12),
          size: 10,
          font: fontRegular,
        });
      });
      
      y -= (lines.length * 12) + 8;
    };

    // === FINANCIAL SUMMARY ===
    drawSectionHeader('YOUR FINANCIAL DNA');
    
    page.drawText(`Total Visible Funds: ‚Ç¶${(analysisData.requiredFunds.yourTotal / 1000000).toFixed(1)}M`, {
      x: margin + 5,
      y,
      size: 11,
      font: fontBold,
    });
    y -= 18;

    page.drawText(`Embassy Requirement: ‚Ç¶${(analysisData.requiredFunds.minimum / 1000000).toFixed(1)}M (Minimum) | ‚Ç¶${(analysisData.requiredFunds.recommended / 1000000).toFixed(1)}M (Recommended)`, {
      x: margin + 5,
      y,
      size: 10,
      font: fontRegular,
    });
    y -= 18;

    page.drawText(`Buffer: ${analysisData.requiredFunds.buffer}`, {
      x: margin + 5,
      y,
      size: 10,
      font: fontBold,
      color: analysisData.requiredFunds.buffer.includes('+') ? rgb(0, 0.6, 0) : rgb(0.9, 0.6, 0),
    });
    y -= 30;

    // === STRENGTHS ===
    drawSectionHeader('YOUR SUPERPOWERS');
    (analysisData.yourProfile.strengths || []).slice(0, 4).forEach((strength: string) => {
      drawBullet(strength, true);
    });
    y -= 10;

    // === RED FLAGS ===
    drawSectionHeader('RED FLAGS DETECTED');
    (analysisData.yourProfile.redFlags || []).slice(0, 3).forEach((flag: string) => {
      drawBullet(flag, false);
    });
    y -= 10;

    // === OFFICER INTELLIGENCE ===
    drawSectionHeader(`WHAT ${userProfile.destinationCountry.toUpperCase()} OFFICERS LOOK FOR`);
    (analysisData.officerPatterns || []).slice(0, 3).forEach((pattern: string) => {
      drawBullet(pattern, true);
    });
    y -= 10;

    // === ACTION PLAN ===
    drawSectionHeader('IMMEDIATE ACTION ITEMS');
    (analysisData.actionPlan.immediate || []).forEach((action: string) => {
      drawBullet(action, true);
    });
    y -= 20;

    // === FOOTER - PREMIUM UPSELL ===
    const footerY = 80;
    page.drawRectangle({
      x: margin,
      y: footerY - 45,
      width: contentWidth,
      height: 45,
      color: rgb(0.95, 0.92, 1),
      borderColor: rgb(0.5, 0.3, 0.8),
      borderWidth: 2,
    });

    page.drawText('üèÜ WANT GUARANTEED APPROVAL?', {
      x: margin + 10,
      y: footerY - 20,
      size: 11,
      font: fontBold,
      color: rgb(0.3, 0.1, 0.6),
    });

    page.drawText('Our verified sponsorship team: 41/41 successes last year | Contact: sponsor@japagenie.com', {
      x: margin + 10,
      y: footerY - 38,
      size: 9,
      font: fontRegular,
    });

    // === WATERMARK ===
    page.drawText('JAPA GENIE INTELLIGENCE REPORT', {
      x: width / 2 - 120,
      y: height / 2,
      size: 40,
      font: fontBold,
      color: rgb(0.95, 0.95, 0.95),
      opacity: 0.1,
      rotate: degrees(-45),
    });

    // === PAGE NUMBER ===
    page.drawText('Page 1 of 1 | Generated by Japa Genie AI | For embassy use only', {
      x: margin,
      y: 25,
      size: 7,
      font: fontRegular,
      color: rgb(0.5, 0.5, 0.5),
    });

    const pdfBytes = await pdfDoc.save();
    
    return new NextResponse(pdfBytes as any, {
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="POF-Report-${userProfile.destinationCountry}-${new Date().toISOString().split('T')[0]}.pdf"`,
      },
    });
  } catch (error: any) {
    console.error('PDF generation error:', error);
    return new NextResponse(JSON.stringify({ error: 'PDF generation failed', details: error.message }), { 
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

--- src/app/api/test-chat/route.ts ---
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { question } = body;
    
    console.log('Test chat endpoint called with:', question);
    
    // Just return a simple response without calling your assistant
    return NextResponse.json({
      answer: `Test response to: "${question}". This endpoint works!`,
      insights: { test: true }
    });
    
  } catch (error: any) {
    console.error('Test endpoint error:', error);
    return NextResponse.json({ 
      error: error.message,
      stack: error.stack 
    }, { status: 500 });
  }
}

--- src/app/api/cron/visa-pulse/route.ts ---
import { NextRequest } from 'next/server';
import { createAdminClient } from "../../../../lib/supabase/admin";

export const runtime = 'edge';

const todayRows = [
  { category:'approval', headline:'80 Ghanaian applicants approved ‚Äì strong proof of funds', count:80, country_code:'GH' },
  { category:'refusal',  headline:'9 Nigerian refusals ‚Äì poor documentation',            count:9,  country_code:'NG' },
  { category:'tip',      headline:'Kenya: new 6-month bank-statement rule now enforced', count:null, country_code:'KE' },
];

export async function GET(req: NextRequest) {
  if (req.headers.get('Authorization') !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  const supabase = createAdminClient();
  const { error } = await supabase.from('visa_pulse').insert(
    todayRows.map(r => ({ ...r, created_at: new Date().toISOString().slice(0,10) }))
  );

  return new Response(JSON.stringify({ ok: !error }), { status: error ? 500 : 200 });
}

--- src/app/api/test-doc/route.ts ---
import { NextResponse } from 'next/server';
import { documentChecker } from '@/ai/flows/document-checker';
import fs from 'fs';

export async function GET() {
  try {
    const pdfBuffer = fs.readFileSync('/home/user/uploads/statement.pdf');
    const base64 = pdfBuffer.toString('base64');
    const dataUri = `data:application/pdf;base64,${base64}`;
    
    const result = await documentChecker({
      documentDataUri: dataUri,
      targetCountry: 'USA',
      visaType: 'Tourist'
    });
    
    return NextResponse.json(result);
  } catch (error: any) {
    return NextResponse.json({ error: error.message });
  }
}

--- src/app/api/document-check/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { documentChecker } from '@/ai/flows/document-checker';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    console.log('üìÑ Document check request received');
    
    // Validate required fields
    if (!body.documentDataUri) {
      return NextResponse.json(
        { error: 'documentDataUri is required' },
        { status: 400 }
      );
    }

    console.log('ü§ñ Calling AI document checker...');

    // Call your AI flow
    const result = await documentChecker({
      documentDataUri: body.documentDataUri,
      targetCountry: body.targetCountry || 'General',
      visaType: body.visaType || 'Tourist',
      userId: body.userId
    });

    console.log('‚úÖ AI analysis complete:', {
      documentType: result.documentType,
      status: result.overallStatus,
      criticalIssues: result.criticalIssues?.length || 0,
      warnings: result.warnings?.length || 0,
      passed: result.passed?.length || 0
    });

    // ‚úÖ FIX: Return result DIRECTLY (no wrapper)
    // This matches what the client expects
    return NextResponse.json(result);

  } catch (error: any) {
    console.error('‚ùå Document check API error:', error);
    return NextResponse.json(
      { error: error.message || 'Analysis failed' },
      { status: 500 }
    );
  }
}

--- src/app/api/interview/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { generateInterviewQuestion } from '@/ai/flows/interview-flow';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();

    if (!body.visaType || !body.destination || !body.userBackground) {
      return NextResponse.json(
        { 
          error: 'Missing required fields', 
          details: 'visaType, destination, and userBackground are required' 
        },
        { status: 400 }
      );
    }

    console.log('‚úÖ Generating interview question with input:', body);
    const result = await generateInterviewQuestion(body);
    console.log('‚úÖ Interview question generated successfully');
    
    return NextResponse.json(result);
  } catch (error: any) {
    console.error('üî• INTERVIEW API ERROR:', error.message || error);
    return NextResponse.json(
      { 
        error: 'Failed to generate interview question',
        debug: error.message || 'Check server logs'
      },
      { status: 500 }
    );
  }
}
--- src/app/api/promo/use/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      return NextResponse.json({ error: 'Please log in to use promo codes' }, { status: 401 });
    }

    const { promoCode } = await request.json();

    if (!promoCode) {
      return NextResponse.json({ error: 'Promo code required' }, { status: 400 });
    }

    console.log('üéØ Checking promo code:', promoCode, 'for user:', user.id);

    // Check if promo code exists and is valid
    const { data: promo, error: promoError } = await supabase
      .from('promo_codes')
      .select('*')
      .eq('code', promoCode.toUpperCase())
      .eq('is_active', true)
      .gte('expires_at', new Date().toISOString())
      .single();

    if (promoError || !promo) {
      return NextResponse.json({ error: 'Invalid or expired promo code' }, { status: 400 });
    }

    // Check if promo code has reached max uses
    if (promo.uses_count >= promo.max_uses) {
      return NextResponse.json({ error: 'Promo code has reached maximum uses' }, { status: 400 });
    }

    // Check if user already has an active subscription
    const { data: existingSubscription } = await supabase
      .from('subscriptions')
      .select('id')
      .eq('user_id', user.id)
      .eq('status', 'active')
      .single();

    if (existingSubscription) {
      return NextResponse.json({ error: 'You already have an active subscription' }, { status: 400 });
    }

    // Calculate subscription end date (duration_days from now)
    const periodEnd = new Date(Date.now() + promo.duration_days * 24 * 60 * 60 * 1000);

    // Create subscription using promo code
    const { data: subscription, error: subError } = await supabase
      .from('subscriptions')
      .insert({
        user_id: user.id,
        status: 'active',
        plan_type: promo.plan_type,
        current_period_start: new Date().toISOString(),
        current_period_end: periodEnd.toISOString(),
        promo_code_id: promo.id,
        is_trial: true
      })
      .select()
      .single();

    if (subError) {
      console.error('‚ùå Subscription creation error:', subError);
      return NextResponse.json({ error: 'Failed to activate promo code' }, { status: 500 });
    }

    // Increment promo code uses
    await supabase
      .from('promo_codes')
      .update({ uses_count: promo.uses_count + 1 })
      .eq('id', promo.id);

    console.log(`‚úÖ Promo code ${promoCode} activated for user ${user.id}`);
    console.log(`üìÖ Access granted until: ${periodEnd.toISOString()}`);

    return NextResponse.json({ 
      success: true, 
      message: `Promo code activated! You now have ${promo.duration_days} days of premium access.`,
      plan: promo.plan_type,
      expires_at: periodEnd.toISOString(),
      duration_days: promo.duration_days
    });

  } catch (error: any) {
    console.error('üí• Promo code error:', error);
    return NextResponse.json({ error: 'Internal server error: ' + error.message }, { status: 500 });
  }
}

--- src/app/api/payment-success/route.ts ---
// src/app/api/payment-success/route.ts ‚Üí FINAL VERSION
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url);
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return NextResponse.redirect(`${requestUrl.origin}/auth`);

  const planType = requestUrl.searchParams.get('plan') || 'pro';
  const returnTo = requestUrl.searchParams.get('returnTo') || '/dashboard';

  // 1. Create/lookup subscription (loose status check)
  const { data: sub } = await supabase
    .from('subscriptions')
    .select('id')
    .eq('user_id', user.id)
    .neq('status', 'canceled')
    .maybeSingle();

  if (!sub) {
    await supabase.from('subscriptions').insert({
      user_id: user.id,
      status: 'active',
      plan_type: planType,
      current_period_start: new Date().toISOString(),
      current_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
    });
  }

  // 2. THIS IS THE MISSING PIECE ‚Üí CREATE PROFILE SO KYC STOPS POPPING
  await supabase
    .from('user_profiles')
    .upsert(
      {
        id: user.id,
        subscription_active: true,
        updated_at: new Date().toISOString(),
      },
      { onConflict: 'id' }
    );

  return NextResponse.redirect(`${requestUrl.origin}${returnTo}`);
}
--- src/app/api/test-pof/route.ts ---
import { groq } from '@/lib/groq-client';
import { NextRequest, NextResponse } from 'next/server';


export async function POST(request: NextRequest) {
  try {
    const { financialData } = await request.json();

    console.log('üß™ Testing POF analysis with Groq');

    const prompt = `Analyze this financial data: ${JSON.stringify(financialData)}. Just respond with "POF ANALYSIS IS WORKING!" if you can read this.`;

    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.7,
    });

    const response = completion.choices[0].message.content;

    return NextResponse.json({ 
      success: true, 
      message: 'POF Analysis is WORKING!',
      response: response
    });

  } catch (error: any) {
    console.error('POF Test Error:', error);
    return NextResponse.json(
      { error: 'POF Test Failed: ' + error.message },
      { status: 500 }
    );
  }
}

--- src/app/api/generate-report-pdf/route.ts ---
import { NextResponse } from 'next/server';
import { PDFDocument, StandardFonts, rgb } from 'pdf-lib';

export const runtime = 'nodejs';

export async function POST(req: Request) {
  try {
    const { letterHTML, analysisResult, targetCountry, visaType } = await req.json();
    const pdfDoc = await PDFDocument.create();
    const page = pdfDoc.addPage([595, 842]);
    const { width, height } = page.getSize();
    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
    const fontRegular = await pdfDoc.embedFont(StandardFonts.Helvetica);
    let y = height - 40;
    const margin = 40;
    const maxWidth = width - 2 * margin;

    // ===== HEADER =====
    page.drawText('JAPA GENIE', { x: margin, y, size: 28, font: fontBold, color: rgb(0.09, 0.32, 0.68) });
    page.drawText('DOCUMENT VERIFICATION REPORT', { x: margin, y: y - 22, size: 10, font: fontRegular, color: rgb(0.4, 0.4, 0.4) });

    // Status badge
    const statusColor = analysisResult.overallStatus === 'pass' ? rgb(0, 0.6, 0) : analysisResult.overallStatus === 'warning' ? rgb(0.9, 0.6, 0) : rgb(0.9, 0, 0);
    page.drawRectangle({ x: width - 180, y: y - 10, width: 140, height: 32, borderColor: statusColor, borderWidth: 2.5, color: rgb(0.95, 0.95, 0.95) });
    page.drawText(analysisResult.overallStatus.toUpperCase(), { x: width - 155, y: y - 1, size: 14, font: fontBold, color: statusColor });
    y -= 65;

    // ===== METADATA BOX =====
    page.drawRectangle({ x: margin, y: y - 45, width: maxWidth, height: 45, color: rgb(0.95, 0.97, 1) });
    page.drawText(`Destination: ${targetCountry} | Visa Type: ${visaType}`, { x: margin + 10, y: y - 18, size: 10, font: fontBold });
    page.drawText(`Document Type: ${analysisResult.documentType} | Generated: ${new Date().toLocaleDateString('en-US')}`, { x: margin + 10, y: y - 35, size: 9, font: fontRegular });
    y -= 75;

    // ===== LETTER CONTENT ‚Äì WORD-WRAPPED =====
    const text = letterHTML
      .replace(/<h[1-3]>/gi, '\n\n')
      .replace(/<\/h[1-3]>/gi, '\n')
      .replace(/<strong>/gi, '')
      .replace(/<\/strong>/gi, '')
      .replace(/<p>/gi, '')
      .replace(/<\/p>/gi, '\n\n')
      .replace(/<li>/gi, '‚Ä¢ ')
      .replace(/<\/li>/gi, '\n')
      .replace(/<br\s*\/?>/gi, '\n')
      .trim();

    const paragraphs = text.split('\n');
    for (const para of paragraphs) {
      if (y < 100) break;
      const words = para.split(' ');
      let line = '', testLine;
      for (const w of words) {
        testLine = line + w + ' ';
        if (fontRegular.widthOfTextAtSize(testLine, 10) > maxWidth) {
          page.drawText(line.trim(), { x: margin, y, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });
          y -= 14;
          line = w + ' ';
        } else {
          line = testLine;
        }
      }
      if (line.trim()) {
        page.drawText(line.trim(), { x: margin, y, size: 10, font: fontRegular, color: rgb(0.1, 0.1, 0.1) });
        y -= 14;
      }
      y -= 6; // paragraph spacing
    }

    // ===== FOOTER =====
    page.drawText('Generated by Japa Genie AI | For official use only', { x: margin, y: 60, size: 8, font: fontRegular, color: rgb(0.5, 0.5, 0.5) });

    const pdfBytes = await pdfDoc.save();
    return new NextResponse(pdfBytes as any, {
      headers: { 'Content-Type': 'application/pdf', 'Content-Disposition': `attachment; filename="Document-Report-${targetCountry}-${Date.now()}.pdf"` }
    });
  } catch (e: any) {
    return new NextResponse(JSON.stringify({ error: e.message }), { status: 500, headers: { 'Content-Type': 'application/json' } });
  }
}
--- src/app/api/visitor-chat/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { siteAssistant } from '@/ai/flows/site-assistant-flow';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { message } = body;

    if (!message || typeof message !== 'string') {
      return NextResponse.json({ error: 'Message is required' }, { status: 400 });
    }

    const result = await siteAssistant({ question: message });
    return NextResponse.json({ response: result.answer });
    
  } catch (error: any) {
    console.error('Visitor Chat API error:', error);
    return NextResponse.json({
      response: "I'm having trouble connecting right now. Please try asking about our visa services, pricing, or features."
    });
  }
}

--- src/app/api/analytics/track/route.ts ---
// src/app/api/analytics/track/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { event, page, metadata = {} } = await request.json();
    
    if (!event || !page) {
      return NextResponse.json(
        { error: 'Event and page are required' },
        { status: 400 }
      );
    }

    // Get user if available
    const { data: { user } } = await supabase.auth.getUser();

    // Generate session ID for anonymous users
    const sessionId = user?.id 
      ? `user_${user.id}`
      : `anon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    console.log('üìä ANALYTICS TRACKING:', { event, page, metadata, user: user?.id });

    // Save to Supabase
    const { error } = await supabase
      .from('analytics_events')
      .insert({
        event,
        page,
        metadata,
        session_id: sessionId,
        user_id: user?.id || null,
        created_at: new Date().toISOString()
      });

    if (error) {
      console.error('Analytics save error:', error);
      // Still return success to not break user experience
    }

    return NextResponse.json({ 
      success: true,
      event,
      session_id: sessionId
    });
    
  } catch (error) {
    console.log('üìä Analytics error (silent):', error);
    // Always return success to not break user experience
    return NextResponse.json({ success: false });
  }
}
--- src/app/api/test-progress/route.ts ---
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const testCases = [
    { docs: 0, expected: 0, old_system: 40 },
    { docs: 1, expected: 14, old_system: 40 },
    { docs: 3, expected: 43, old_system: 40 },
    { docs: 5, expected: 71, old_system: 40 },
    { docs: 7, expected: 100, old_system: 40 }
  ];

  const results = testCases.map(({ docs, expected, old_system }) => {
    const progress = Math.round((docs / 7) * 100);
    return {
      documents: docs,
      new_progress: progress,
      old_progress: old_system,
      improvement: old_system !== progress ? "‚úÖ FIXED" : "‚ùå BROKEN",
      description: docs === 0 ? "NO DOCUMENTS: Was 40% (fake) ‚Üí Now 0% (truthful)" : "Accurate progress"
    };
  });

  return NextResponse.json({ 
    message: "Progress System Verification",
    summary: "Hardcoded 40% progress has been eliminated",
    test_results: results
  });
}

--- src/app/api/analyze-pof/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { analyzeProofOfFunds } from '@/ai/flows/analyze-proof-of-funds';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    // Validate required fields
    if (!body.userProfile || !body.financialData) {
      return NextResponse.json(
        { success: false, error: 'userProfile and financialData are required' },
        { status: 400 }
      );
    }

    // Call your AI flow
    const result = await analyzeProofOfFunds({
      userProfile: body.userProfile,
      financialData: body.financialData,
      familyMembers: body.familyMembers || 1
    });

    return NextResponse.json(result);

  } catch (error: any) {
    console.error('‚ùå POF analysis API error:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
--- src/app/api/webhooks/paystack/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';
import { createAdminClient } from '@/lib/supabase/admin';

export async function POST(request: NextRequest) {
  const body = await request.text();
  const signature = request.headers.get('x-paystack-signature');

  try {
    if (process.env.NODE_ENV === 'production' && process.env.PAYSTACK_WEBHOOK_SECRET) {
      const hash = crypto
        .createHmac('sha512', process.env.PAYSTACK_WEBHOOK_SECRET)
        .update(body)
        .digest('hex');

      if (hash !== signature) {
        return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
      }
    }

    const event = JSON.parse(body);

    if (event.event === 'charge.success') {
      const { reference, amount, metadata } = event.data;
      const userId = metadata?.userId;
      const planName = metadata?.planName;

      if (!userId) {
        return NextResponse.json({ error: 'Missing userId' }, { status: 400 });
      }

      const supabase = createAdminClient();

      await supabase.from('payments').insert({
        user_id: userId,
        stripe_payment_id: reference,
        amount: amount / 100,
        status: 'succeeded',
        product_name: planName,
        subscription_tier: 'premium',
      });

      await supabase.rpc('upgrade_to_premium', { user_uuid: userId });

      console.log(`‚úÖ Payment confirmed for user ${userId}`);
    }

    return NextResponse.json({ received: true });
  } catch (error) {
    console.error('Paystack webhook error:', error);
    return NextResponse.json({ error: 'Webhook failed' }, { status: 500 });
  }
}

--- src/app/api/webhooks/stripe/route.ts ---
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '@/lib/stripe/stripe-server';
import { createAdminClient } from '@/lib/supabase/admin';

export async function POST(request: NextRequest) {
  const body = await request.text();
  const signature = request.headers.get('stripe-signature');

  if (!signature) {
    return NextResponse.json({ error: 'No signature' }, { status: 400 });
  }

  try {
    const event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );

    console.log('Stripe webhook event:', event.type);

    if (event.type === 'checkout.session.completed') {
      const session = event.data.object;
      const userId = session.metadata?.userId;
      const planName = session.metadata?.planName;

      if (!userId) {
        console.error('Missing userId in session metadata');
        return NextResponse.json({ error: 'Missing userId' }, { status: 400 });
      }

      const supabase = createAdminClient();

      const { error: paymentError } = await supabase.from('payments').insert({
        user_id: userId,
        stripe_payment_id: session.payment_intent as string,
        amount: (session.amount_total || 0) / 100,
        status: 'succeeded',
        product_name: planName || 'Premium Plan',
        subscription_tier: 'premium',
      });

      if (paymentError) {
        console.error('Payment insert error:', paymentError);
        throw paymentError;
      }

      const { error: upgradeError } = await supabase.rpc('upgrade_to_premium', {
        user_uuid: userId,
      });

      if (upgradeError) {
        console.error('Upgrade error:', upgradeError);
        throw upgradeError;
      }

      console.log(`‚úÖ Stripe payment confirmed for user ${userId}, plan ${planName}`);
    }

    return NextResponse.json({ received: true });
  } catch (error) {
    console.error('Stripe webhook error:', error);
    return NextResponse.json({ error: 'Webhook failed' }, { status: 500 });
  }
}

--- src/app/api/debug/route.ts ---
import { NextResponse } from 'next/server';

export async function GET() {
  return NextResponse.json({
    hasKey: !!process.env.NEXT_PUBLIC_GEMINI_API_KEY,
    keyLength: process.env.NEXT_PUBLIC_GEMINI_API_KEY?.length || 0,
    envFile: process.env.NODE_ENV
  });
}

=== 3. CONTEXTS ===
--- AuthContext ---
'use client'
import { createContext, useContext, useEffect, useState, ReactNode } from 'react'
import { User } from '@supabase/supabase-js'
import { createClient } from './supabase/client'

interface AuthContextType {
  user: User | null
  loading: boolean
  signInWithGoogle: (redirectPath?: string) => Promise<void>
  signOut: () => Promise<void>
}

const AuthContext = createContext<AuthContextType>({} as AuthContextType)

export const useAuth = () => {
  const context = useContext(AuthContext)
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider')
  }
  return context
}

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)
  const supabase = createClient()

  useEffect(() => {
    const initAuth = async () => {
      try {
        // FORCE refresh session from cookies
        const { data: { session }, error } = await supabase.auth.getSession()
        
        if (error) {
          console.error('Error getting session:', error)
        }
        
        console.log('üîê Session check:', session ? 'Logged in' : 'Not logged in')
        setUser(session?.user ?? null)
        setLoading(false)
      } catch (error) {
        console.error('Error initializing auth:', error)
        setLoading(false)
      }
    }

    initAuth()

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîÑ Auth state changed:', event)
      setUser(session?.user ?? null)
      
      // Force reload on sign in to ensure UI updates
      if (event === 'SIGNED_IN') {
        console.log('‚úÖ User signed in, forcing UI update')
      }
    })

    return () => {
      subscription.unsubscribe()
    }
  }, [])

  const signInWithGoogle = async (redirectPath?: string): Promise<void> => {
    try {
      console.log('üöÄ Starting Google sign in...')
      
      // Get kyc_session_id from sessionStorage if exists
      const kycSessionId = sessionStorage.getItem('kyc_session_id')
      console.log('üìã KYC Session ID found:', kycSessionId)
      
      // Build state parameter: contains both next path and kyc_session_id
      let stateParams = ''
      if (redirectPath) {
        stateParams += `next=${encodeURIComponent(redirectPath)}`
      }
      if (kycSessionId) {
        if (stateParams) stateParams += '&'
        stateParams += `kyc_session_id=${encodeURIComponent(kycSessionId)}`
      }
      
      let callbackUrl = `${window.location.origin}/auth/callback`
      if (redirectPath) {
        callbackUrl += `?next=${encodeURIComponent(redirectPath)}`
      }
      
      console.log('üåê Callback URL:', callbackUrl)
      console.log('üîë State params:', stateParams)
      
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: callbackUrl,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          },
          // ‚úÖ CRITICAL FIX: Pass kyc_session_id in state
          ...(stateParams && { state: stateParams })
        },
      })
      
      if (error) {
        console.error('‚ùå Sign in error:', error)
        alert(`Login failed: ${error.message}`)
        throw error
      }
      
      console.log('‚úÖ OAuth initiated with KYC context')
    } catch (err) {
      console.error('üí• Error:', err)
      alert('An unexpected error occurred during login')
      throw err
    }
  }

  const signOut = async () => {
    console.log('üëã Signing out...')
    await supabase.auth.signOut()
    setUser(null)
    window.location.href = '/' // Force redirect to home
  }

  return (
    <AuthContext.Provider value={{ user, loading, signInWithGoogle, signOut }}>
      {children}
    </AuthContext.Provider>
  )
}
--- ChatContext ---
'use client';

import React, { createContext, useContext, useState, ReactNode } from 'react';

interface ChatContextType {
  isChatOpen: boolean;
  setIsChatOpen: (open: boolean) => void;
}

const ChatContext = createContext<ChatContextType | undefined>(undefined);

export function ChatProvider({ children }: { children: ReactNode }) {
  const [isChatOpen, setIsChatOpen] = useState(false);

  const setChatOpen = (open: boolean) => {
    console.log('ChatContext: Setting chat open to', open);
    setIsChatOpen(open);
  };

  return (
    <ChatContext.Provider value={{ isChatOpen, setIsChatOpen: setChatOpen }}>
      {children}
    </ChatContext.Provider>
  );
}

export function useChat() {
  const context = useContext(ChatContext);
  if (context === undefined) {
    throw new Error('useChat must be used within a ChatProvider');
  }
  return context;
}
=== 4. LAYOUTS ===
import type { Metadata } from 'next'
import './globals.css'
import { Inter } from 'next/font/google'
import { Toaster } from '@/components/ui/toaster'
import { AuthProvider } from '@/lib/AuthContext'
import { ChatProvider } from '@/context/ChatContext'
import AppShell from '@/components/pwa/AppShell'
import { InstallPrompt } from '@/components/pwa/InstallPrompt'
import FloatingChatButton from '@/components/layout/floating-chat-button'
import RegisterServiceWorker from '@/components/pwa/RegisterServiceWorker'

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
})

export const metadata: Metadata = {
  title: 'Japa Genie',
  description: 'Your AI-Powered Visa Guide',
  manifest: '/manifest.json',
}

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
      </head>
      <body className={inter.className}>
        <AuthProvider>
          <ChatProvider>
            <AppShell>
              {children}
            </AppShell>
            {/* Floating button hidden on mobile, shown on desktop */}
            <div className="hidden md:block">
              <FloatingChatButton />
            </div>
            <InstallPrompt />
            <RegisterServiceWorker />
          </ChatProvider>
          <Toaster />
        </AuthProvider>
      </body>
    </html>
  )
}
--- AppShell ---
'use client';

import { useEffect, useState } from 'react';
import SimpleHeader from '@/components/SimpleHeader';
import { AppFooter } from '@/components/layout/app-footer';
import { PWANavigation } from '@/components/pwa/PWANavigation';
import { JapaGenieLogo } from '@/components/icons';

export default function AppShell({ children }: { children: React.ReactNode }) {
  const [isLoading, setIsLoading] = useState(true);
  const [isFirstVisit, setIsFirstVisit] = useState(false);

  useEffect(() => {
    const hasVisited = localStorage.getItem('japa-first-visit');
    if (!hasVisited) {
      setIsFirstVisit(true);
      localStorage.setItem('japa-first-visit', 'true');
    }

    const timer = setTimeout(() => setIsLoading(false), 300);
    return () => clearTimeout(timer);
  }, []);

  return (
    <div className="min-h-screen bg-white flex flex-col">
      {/* Launch Animation - Only on first visit */}
      {isFirstVisit && (
        <div className="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-50 pwa-launch-logo animate-fade-out">
          <JapaGenieLogo className="w-32 h-32 animate-pulse" />
        </div>
      )}

      {/* Loading Progress Bar */}
      {isLoading && (
        <div className="fixed top-0 left-0 right-0 h-1 z-40">
          <div className="h-full bg-gradient-to-r from-blue-500 to-purple-600 animate-progress-bar" />
        </div>
      )}

      {/* App Shell Header */}
      <div className="sticky top-0 z-40">
        <SimpleHeader />
      </div>

      {/* Main Content - FLEX GROW TO PUSH FOOTER DOWN */}
      <main className="flex-grow pb-16"> {/* Added padding for bottom nav */}
        <div className={`${isLoading ? 'opacity-0' : 'opacity-100'} transition-opacity duration-300`}>
          {children}
        </div>
      </main>

      {/* PWA Navigation Bar (Mobile only) */}
      <PWANavigation />

      {/* App Footer */}
      <AppFooter />
    </div>
  );
}
=== 5. SUPABASE ===
Not found
=== 6. PACKAGE.JSON ===
{
  "name": "nextn",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack -p 9003 ",
    "genkit:dev": "genkit start -- tsx src/ai/dev.ts",
    "genkit:watch": "genkit start -- tsx --watch src/ai/dev.ts",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@genkit-ai/google-genai": "^1.21.0",
    "@genkit-ai/googleai": "^1.14.1",
    "@genkit-ai/next": "^1.19.3",
    "@google/generative-ai": "^0.24.1",
    "@hookform/resolvers": "^4.1.3",
    "@huggingface/inference": "^4.13.5",
    "@radix-ui/react-accordion": "^1.2.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.4",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-menubar": "^1.1.6",
    "@radix-ui/react-popover": "^1.1.6",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-radio-group": "^1.2.3",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.6",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slider": "^1.2.3",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.1.3",
    "@radix-ui/react-tabs": "^1.1.3",
    "@radix-ui/react-toast": "^1.2.6",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@radix-ui/react-visually-hidden": "^1.2.3",
    "@react-pdf/renderer": "^4.3.1",
    "@stripe/stripe-js": "^8.1.0",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.75.0",
    "@types/cookie": "^0.6.0",
    "ai": "^3.2.34",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cookie": "^1.0.2",
    "date-fns": "^3.6.0",
    "dotenv": "^16.5.0",
    "embla-carousel-autoplay": "^8.6.0",
    "embla-carousel-react": "^8.6.0",
    "firebase-admin": "^13.5.0",
    "genkit": "^1.14.1",
    "groq-sdk": "^0.37.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.475.0",
    "next": "15.3.8",
    "patch-package": "^8.0.0",
    "paystack": "^2.0.1",
    "pdf-lib": "^1.17.1",
    "pdf-parse": "^2.4.5",
    "pdf-to-png-converter": "^3.11.0",
    "pdfjs-dist": "^5.4.530",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.54.2",
    "react-markdown": "^10.1.0",
    "recharts": "^2.15.4",
    "remark-gfm": "^4.0.1",
    "stripe": "^19.1.0",
    "tailwind-merge": "^3.0.1",
    "tailwindcss-animate": "^1.0.7",
    "tesseract.js": "^6.0.1",
    "twemoji": "^14.0.2",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "@svgr/cli": "^8.1.0",
    "@types/handlebars": "^4.0.40",
    "@types/jspdf": "^1.3.3",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "@types/stripe": "^8.0.416",
    "genkit-cli": "^1.14.1",
    "next-pwa": "^5.6.0",
    "postcss": "^8",
    "sharp": "^0.34.5",
    "svgo": "^4.0.0",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  },
  "overrides": {
    "@types/minimatch": "3.0.5"
  }
}
=== 7. AI FLOWS ===
--- src/ai/genkit.ts ---
import { genkit } from 'genkit';
import { googleAI, gemini20Flash } from '@genkit-ai/googleai';

const aiInstance = genkit({
  plugins: [
    googleAI({
      apiKey: process.env.NEXT_PUBLIC_GEMINI_API_KEY,
    }),
  ],
});

// Named exports - FIXED MODEL REFERENCE
export const ai = aiInstance;
export const geminiFlash = gemini20Flash; // ‚úÖ Use the imported constant

// Keep default export for any potential future use
export default aiInstance;
--- src/ai/schemas/rejection-reversal-schema.ts ---
import { z } from 'zod';

export const RejectionStrategyInputSchema = z.object({
  visaType: z.string().describe('The type of visa that was rejected (e.g., Student Visa, Work Permit).'),
  destination: z.string().describe('The destination country for the visa application.'),
  rejectionReason: z.string().optional().describe('The official reason for rejection, as stated in the letter from the embassy.'),
  userBackground: z.string().describe("A brief summary of the user's profile and circumstances (e.g., profession, purpose of travel)."),
});

export type RejectionStrategyInput = z.infer<typeof RejectionStrategyInputSchema>;

export const StrategyStepSchema = z.object({
  step: z.number().describe('The step number in the plan.'),
  headline: z.string().describe('A short, actionable headline for the step.'),
  details: z.string().describe('A detailed explanation of what to do in this step, including specific actions to take or documents to prepare.'),
});

export const RejectionStrategyOutputSchema = z.object({
  introduction: z.string().describe('An encouraging introductory sentence for the user.'),
  strategy: z.array(StrategyStepSchema).describe('A list of 3-5 concrete steps for the user to follow to strengthen their reapplication.'),
  conclusion: z.string().describe('A final sentence of encouragement and a call to action.'),
});

export type RejectionStrategyOutput = z.infer<typeof RejectionStrategyOutputSchema>;
--- src/ai/schemas/unified-response.ts ---
/**
 * Unified response schema - single AI call returns both chat + structured insights
 */

export interface UnifiedVisaResponse {
  // Natural chat response
  answer: string;
  
  // Structured insights (like mini-app)
  insights?: {
    // Key insights with headlines
    keyInsights: Array<{
      headline: string;
      detail: string;
      url?: string;
    }>;
    
    // Cost breakdown
    costEstimates: Array<{
      item: string;
      cost: number;
      currency: string;
      localCost?: string; // Converted to user's currency
    }>;
    
    // Visa alternatives
    visaAlternatives: Array<{
      visaName: string;
      description: string;
      pros: string[];
      cons: string[];
    }>;
    
    // Chart data for beautiful visualizations
    chartData?: {
      title: string;
      data: Array<{
        name: string;
        value: number;
        color?: string;
      }>;
      type: 'bar' | 'line' | 'pie';
    };
    
    // Action buttons (stay in-app)
    actions: Array<{
      label: string;
      action: 'document-checklist' | 'compare-visas' | 'timeline-view' | 'cost-breakdown';
      icon?: string;
    }>;
  };
}

--- src/ai/schemas/insight-schemas.ts ---
import { z } from 'zod';

export const InsightInputSchema = z.object({
  question: z.string().optional(),
  userProfile: z.object({
    age: z.number().optional(),
    profession: z.string().optional(),
    country: z.string().optional(),
    destinationCountry: z.string().optional(),
    visaType: z.string().optional(),
  }).optional(),
});

export type InsightInput = z.infer<typeof InsightInputSchema>;

// ‚úÖ MATCHES YOUR WORKING insights-generator.ts
export const InsightOutputSchema = z.object({
  insights: z.array(z.object({
    headline: z.string(),
    detail: z.string(),
    url: z.string().optional(),
  })),
  costEstimates: z.array(z.object({
    item: z.string(),
    cost: z.number(),
    currency: z.string(),
  })),
  visaAlternatives: z.array(z.object({
    visaName: z.string(),
    description: z.string(),
  })),
  chartData: z.object({
    title: z.string(),
    data: z.array(z.object({
      name: z.string(),
      value: z.number(),
    })),
  }).optional(),
});

export type InsightOutput = z.infer<typeof InsightOutputSchema>;

--- src/ai/schemas/insight-schemas.ts.backup ---
/**
 * @fileOverview Fixed Insight Schemas - Build Error Resolved
 * 
 * KEY FIX: Made `question` optional to match actual usage patterns
 * 
 * Features:
 * - Optional question field (fixes TypeScript error)
 * - User profile context for personalization
 * - Country suggestions with difficulty ratings
 * - Timeline visualization data
 * - Alternative strategies
 */

import { z } from 'zod';

// ============================================================================
// INPUT SCHEMA - ‚úÖ FIXED: question is now optional
// ============================================================================

export const InsightInputSchema = z.object({
  question: z.string().optional(), // ‚úÖ FIXED: Made optional to match actual usage
  
  userProfile: z.object({
    age: z.number().optional(),
    profession: z.string().optional(),
    country: z.string().optional(),
    destinationCountry: z.string().optional(),
    visaType: z.string().optional(),
  }).optional(),
});

export type InsightInput = z.infer<typeof InsightInputSchema>;

// ============================================================================
// OUTPUT SCHEMA - Enhanced for better UX
// ============================================================================

export const InsightOutputSchema = z.object({
  
  // Suggested countries with all details
  suggestedCountries: z.array(z.object({
    name: z.string(),
    visaType: z.string(),
    estimatedCost: z.number(),
    processingTimeMonths: z.number(),
    pros: z.array(z.string()),
    cons: z.array(z.string()),
    difficulty: z.enum(['Easy', 'Medium', 'Hard']).optional(), // For color-coding
    personalityTag: z.string().optional(), // For personality feature
  })).optional(),

  // Timeline steps
  timeline: z.array(z.object({
    step: z.string(),
    durationWeeks: z.number(),
    criticalNotes: z.string().optional(), // Added for enhanced timeline
  })).optional(),

  // Alternative strategies
  alternativeStrategies: z.array(z.string()).optional(),

  // Overall difficulty assessment
  difficulty: z.string().optional(),

  // General recommendations
  recommendations: z.array(z.string()).optional(),
});

export type InsightOutput = z.infer<typeof InsightOutputSchema>;
--- src/ai/insights-generator.ts.backup-fix ---
import { groq } from '@/lib/groq-client';
'use server';

import { InsightInput, InsightOutput } from '@/ai/schemas/insight-schemas';

const groqClient = new Groq({
  apiKey: process.env.GROQ_API_KEY || process.env.NEXT_PUBLIC_GROQ_API_KEY!
});

export async function generateInsights(input: InsightInput): Promise<InsightOutput> {
  const prompt = `You are an expert immigration analyst.

Generate insights for: "${input.question}"

User Profile: ${JSON.stringify(input.userProfile, null, 2)}

Return ONLY valid JSON in this EXACT format (no markdown, no backticks):
{
  "insights": [
    {
      "headline": "Clear headline",
      "detail": "Detailed explanation",
      "url": "optional link"
    }
  ],
  "costEstimates": [
    {
      "item": "Cost item name",
      "cost": 1000,
      "currency": "USD"
    }
  ],
  "visaAlternatives": [
    {
      "visaName": "Alternative visa name",
      "description": "Why this alternative works"
    }
  ],
  "chartData": {
    "title": "Processing Times by Country",
    "data": [
      {"name": "USA", "value": 90},
      {"name": "UK", "value": 60}
    ]
  }
}

Generate 3-5 insights, 2-4 cost estimates, 2-3 alternatives, and chart data with 3-5 countries.`;

  try {
    const completion = await groqClient.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: 'You are an expert immigration analyst. Return ONLY valid JSON, no other text.' },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 1500
    });

    let text = completion.choices[0]?.message?.content?.trim() || '';
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    // Try to parse JSON, fallback if invalid
    try {
      return JSON.parse(text);
    } catch (parseError) {
      console.error('Failed to parse JSON:', text);
      return createFallbackInsights();
    }
  } catch (error) {
    console.error('Insights API error:', error);
    return createFallbackInsights();
  }
}

function createFallbackInsights(): InsightOutput {
  return {
    insights: [{ headline: "Temporary Service Issue", detail: "The Genie is experiencing technical difficulties. Please try again in a moment." }],
    costEstimates: [],
    visaAlternatives: [],
    chartData: { title: "Processing Times", data: [{ name: "USA", value: 90 }] }
  };
}

--- src/ai/tools/knowledge-retriever.ts ---
'use server';
/**
 * @fileOverview A Genkit tool for retrieving content from a local knowledge base.
 */
import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import * as fs from 'node:fs/promises';
import * as path from 'node:path';

const knowledgeBasePath = path.join(process.cwd(), 'src', 'ai', 'knowledge');

export const getKnowledge = ai.defineTool(
  {
    name: 'getKnowledge',
    description: 'Retrieves content from the knowledge base to answer user questions. Use this tool first before using general knowledge.',
    inputSchema: z.object({
      query: z.string().describe('A summary of the user\'s question to search for in the knowledge base.'),
    }),
    outputSchema: z.string().describe('The content of the knowledge base files.'),
  },
  async () => {
    try {
      const files = await fs.readdir(knowledgeBasePath);
      const markdownFiles = files.filter(file => file.endsWith('.md'));

      if (markdownFiles.length === 0) {
        return 'No knowledge base files found.';
      }

      let knowledge = '';
      for (const file of markdownFiles) {
        const filePath = path.join(knowledgeBasePath, file);
        const content = await fs.readFile(filePath, 'utf-8');
        knowledge += `--- KNOWLEDGE FROM ${file} ---\n${content}\n\n`;
      }

      return knowledge;
    } catch (error) {
      console.error('Error reading knowledge base:', error);
      if ((error as any).code === 'ENOENT') {
        return "The knowledge base directory does not exist. You may need to create it.";
      }
      return 'An error occurred while trying to access the knowledge base.';
    }
  }
);

--- src/ai/tools/knowledge-retriever.ts.backup-fix ---
'use server';
/**
 * @fileOverview A Genkit tool for retrieving content from a local knowledge base.
 */
import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import * as fs from 'node:fs/promises';
import * as path from 'node:path';

const knowledgeBasePath = path.join(process.cwd(), 'src', 'ai', 'knowledge');

export const getKnowledge = ai.defineTool(
  {
    name: 'getKnowledge',
    description: 'Retrieves content from the knowledge base to answer user questions. Use this tool first before using general knowledge.',
    inputSchema: z.object({
      query: z.string().describe('A summary of the user\'s question to search for in the knowledge base.'),
    }),
    outputSchema: z.string().describe('The content of the knowledge base files.'),
  },
  async () => {
    try {
      const files = await fs.readdir(knowledgeBasePath);
      const markdownFiles = files.filter(file => file.endsWith('.md'));

      if (markdownFiles.length === 0) {
        return 'No knowledge base files found.';
      }

      let knowledge = '';
      for (const file of markdownFiles) {
        const filePath = path.join(knowledgeBasePath, file);
        const content = await fs.readFile(filePath, 'utf-8');
        knowledge += `--- KNOWLEDGE FROM ${file} ---\n${content}\n\n`;
      }

      return knowledge;
    } catch (error) {
      console.error('Error reading knowledge base:', error);
      if ((error as any).code === 'ENOENT') {
        return "The knowledge base directory does not exist. You may need to create it.";
      }
      return 'An error occurred while trying to access the knowledge base.';
    }
  }
);

--- src/ai/flows/visa-chat-assistant.ts ---
'use server';
import { groq } from '@/lib/groq-client';
import { getCurrencyInfoWithLiveRate } from "@/lib/currency-live";

/* ---------- TYPES ---------- */
interface VisaAssistantInput {
  question: string;
  wishCount: number;
  conversationHistory?: Array<{ role: 'user' | 'assistant'; content: string }>;
  userContext?: {
    name?: string;
    country?: string;
    destination?: string;
    profession?: string;
    visaType?: string;
    age?: number;
    userType?: string;
    timelineUrgency?: string;
  };
  isSignedIn?: boolean;
}

interface VisaAssistantOutput {
  answer: string;
  insights?: {
    suggestedCountries?: Array<{
      name: string;
      visaType: string;
      estimatedCost: number;
      processingTimeMonths: number;
      pros: string[];
      cons: string[];
    }>;
    timeline?: Array<{ step: string; durationWeeks: number }>;
    alternativeStrategies?: string[];
    difficulty?: string;
    recommendations?: string[];
  };
}

/* ---------- SYSTEM PROMPT ---------- */
const SYSTEM_PROMPT = `You are Japa Genie, a world-class visa strategist with 8+ years analyzing African ‚Üí Global migration patterns.
Speak in Markdown, cite real stats, never guarantee approval.
Use the EXACT user details (age, country, destination, etc.) provided in the prompt below.

CRITICAL: You MUST return valid JSON with this EXACT structure:
{
  "chatResponse": "Your detailed markdown answer with [citation links] and specific stats",
  "suggestedCountries": [
    {
      "name": "Country Name",
      "visaType": "Specific Visa Type",
      "estimatedCost": 1500,
      "processingTimeMonths": 6,
      "pros": ["pro 1", "pro 2"],
      "cons": ["con 1", "con 2"]
    }
  ],
  "timeline": [
    {"step": "Step description", "durationWeeks": 4}
  ],
  "alternativeStrategies": ["Strategy 1", "Strategy 2"]
}`;

function buildPrompt(input: VisaAssistantInput): string {
  const { question, conversationHistory = [], userContext } = input;
  const ctx = userContext
    ? `${userContext.name || 'User'} (${userContext.age || 'unknown'} years) from ${userContext.country || 'unknown'} ‚Üí ${userContext.destination || 'unknown'} (${userContext.visaType || 'unknown'}), works as ${userContext.profession || 'unknown'}, timeline: ${userContext.timelineUrgency || 'unknown'}`
    : 'Profile not yet collected';
  const history = conversationHistory.length
    ? `History:\n${conversationHistory.map(m => `${m.role}: ${m.content}`).join('\n')}\n`
    : '';
  return `${SYSTEM_PROMPT}\n\n${history}Context: ${ctx}\nQuestion: ${question}`;
}

/* ---------- EXPORTED ACTION ---------- */
export async function visaChatAssistant(input: VisaAssistantInput): Promise<VisaAssistantOutput> {
  const { wishCount, isSignedIn } = input;

  try {
    const completion = await groq.chat.completions.create({
      messages: [
        { role: 'system', content: SYSTEM_PROMPT },
        { role: 'user', content: buildPrompt(input) }
      ],
      model: 'llama-3.3-70b-versatile',
      temperature: 0.7,
      max_tokens: 2000,
      response_format: { type: 'json_object' }
    });

    const content = completion.choices[0]?.message?.content || '{"chatResponse": "Error processing response"}';
    const data = JSON.parse(content);

    let answer = data.chatResponse?.replace(/\(?\d+\s*wishes?\s*remaining\)?/gi, '').trim() || '';

    if (!isSignedIn) {
      const left = Math.max(0, 3 - wishCount);
      answer += `\n\n_(${left} ${left === 1 ? 'wish' : 'wishes'} remaining)_`;
    }

    const hasInsights =
      (data.suggestedCountries?.length > 0) ||
      (data.timeline?.length > 0) ||
      (data.alternativeStrategies?.length > 0);

    return {
      answer,
      insights: hasInsights
        ? {
            suggestedCountries: data.suggestedCountries || [],
            timeline: data.timeline || [],
            alternativeStrategies: data.alternativeStrategies || [],
            difficulty: data.suggestedCountries?.length ? 'Medium' : undefined,
            recommendations: data.alternativeStrategies || [],
          }
        : undefined,
    };

  } catch (error) {
    console.error('Visa assistant error:', error);
    return {
      answer: `I encountered an issue while researching. Based on general patterns, consider skilled worker or express entry programs with 6-12 month timelines. Please try again or ask a more specific question.`
    };
  }
}

--- src/ai/flows/TEST-IMG.ts ---
'use server';
import { documentChecker } from './document-checker';
import fs from 'fs';
import path from 'path';

async function test() {
  // ‚úÖ POINT TO THE NEW, VISIBLE UPLOADS DIRECTORY
  const imgPath = path.join(process.cwd(), 'src', 'uploads', 'test.jpg');
  
  if (!fs.existsSync(imgPath)) {
    console.error(`‚ùå File not found at: ${imgPath}`);
    console.error("Please upload 'test.jpg' to the 'src/uploads' folder in your file explorer.");
    return;
  }
  
  const img = fs.readFileSync(imgPath);
  const base64 = img.toString('base64');
  const dataUri = `data:image/jpeg;base64,${base64}`;
  
  const result = await documentChecker({
    documentDataUri: dataUri,
    targetCountry: 'USA',
    visaType: 'Tourist'
  });
  
  console.log(JSON.stringify(result, null, 2));
}

test();

--- src/ai/flows/analyze-proof-of-funds.ts ---
'use server';
import { groq } from '@/lib/groq-client';

export interface ProofOfFundsInput {
  userProfile: {
    destination_country: string;
    visa_type: string;
    nationality?: string;
  };
  financialData: string | object;
  familyMembers: number;
}

export interface ProofOfFundsAnalysis {
  summary: {
    totalScore: number;
    meetsRequirements: boolean;
    riskLevel: 'low' | 'medium' | 'high';
    confidence: number;
  };
  financialAnalysis: {
    totalAssets: number;
    liquidAssets: number;
    seasoningDays: number;
    seasoningRequired: number; // üî• NEW: Required seasoning period
    seasoningStatus: 'meets' | 'insufficient' | 'risky'; // üî• NEW
    currency: string;
    stabilityScore: number;
  };
  complianceCheck: {
    passes: boolean;
    issues: string[];
    specificAdvice: string[];
  };
  accountBreakdown: Array<{
    institution: string;
    balance: number;
    seasoning: number;
    seasoningRequired: number; // üî• NEW: Per-account requirement
    type: string;
    status: string;
    notes: string;
  }>;
  recommendations: Array<{
    priority: 'high' | 'medium' | 'low';
    action: string;
    timeline: string;
    impact: string;
  }>;
  embassySpecific: {
    minimumFunds: number;
    seasoningRequirements: number; // üî• ENHANCED: Days required
    seasoningExplanation: string; // üî• NEW: Why seasoning matters
    documentChecklist: string[];
    commonRejectionReasons: string[];
    countrySpecificRules: string[]; // üî• NEW: Country-specific notes
  };
}

export interface ProofOfFundsOutput {
  success: boolean;
  analysis?: ProofOfFundsAnalysis;
  error?: string;
}

/**
 * üî• ENHANCED PROOF OF FUNDS ANALYZER
 * - Calculates account seasoning requirements
 * - Country-specific rules
 * - Real embassy requirements
 */
export async function analyzeProofOfFunds(
  input: ProofOfFundsInput
): Promise<ProofOfFundsOutput> {
  try {
    console.log('ü§ñ Starting POF analysis for:', input.userProfile.destination_country);

    // STEP 1: Get country-specific seasoning requirements
    const seasoningRules = getSeasoningRequirements(
      input.userProfile.destination_country,
      input.userProfile.visa_type
    );

    // STEP 2: Get minimum fund requirements
    const fundRequirements = getMinimumFundRequirements(
      input.userProfile.destination_country,
      input.userProfile.visa_type,
      input.familyMembers
    );

    // Convert financial data to string
    const financialDataStr = typeof input.financialData === 'string'
      ? input.financialData
      : JSON.stringify(input.financialData, null, 2);

    // STEP 3: Build comprehensive prompt with real requirements
    const prompt = `You are an expert visa financial analyst with deep knowledge of embassy requirements.

APPLICANT PROFILE:
- Destination: ${input.userProfile.destination_country}
- Visa Type: ${input.userProfile.visa_type}
- Nationality: ${input.userProfile.nationality || 'Not specified'}
- Family Members: ${input.familyMembers}

EMBASSY REQUIREMENTS FOR ${input.userProfile.destination_country}:
${fundRequirements}

ACCOUNT SEASONING REQUIREMENTS:
${seasoningRules}

FINANCIAL DATA PROVIDED:
${financialDataStr}

YOUR CRITICAL TASKS:
1. Extract ALL account balances, dates, and transaction patterns
2. Calculate how long funds have been maintained (seasoning period)
3. Check if seasoning meets embassy requirements (${seasoningRules.split('\n')[0]})
4. Identify recent large deposits (RED FLAG for embassies)
5. Calculate total liquid assets
6. Assess stability of funds over time
7. Check compliance with specific country rules

SEASONING ANALYSIS IS CRITICAL:
- Embassies reject applications with "sudden wealth" (funds deposited recently)
- They want to see funds maintained consistently for required period
- Large deposits within seasoning period are RED FLAGS
- Calculate: days between earliest transaction and today

Return your analysis as a JSON object with this structure (use REAL calculated values):
{
  "summary": {
    "totalScore": <0-10 based on analysis>,
    "meetsRequirements": <true/false>,
    "riskLevel": "<low/medium/high>",
    "confidence": <0-100>
  },
  "financialAnalysis": {
    "totalAssets": <calculated total>,
    "liquidAssets": <liquid funds only>,
    "seasoningDays": <days funds have been maintained>,
    "seasoningRequired": ${seasoningRules.match(/\d+/)?.[0] || 90},
    "seasoningStatus": "<meets/insufficient/risky>",
    "currency": "<detected currency>",
    "stabilityScore": <1-10>
  },
  "complianceCheck": {
    "passes": <true/false>,
    "issues": [<list specific issues>],
    "specificAdvice": [<actionable advice>]
  },
  "accountBreakdown": [
    {
      "institution": "<bank name>",
      "balance": <amount>,
      "seasoning": <days this account shows>,
      "seasoningRequired": ${seasoningRules.match(/\d+/)?.[0] || 90},
      "type": "<savings/checking/etc>",
      "status": "<meets/insufficient/risky>",
      "notes": "<observations about this account>"
    }
  ],
  "recommendations": [
    {
      "priority": "<high/medium/low>",
      "action": "<specific action>",
      "timeline": "<timeframe>",
      "impact": "<expected outcome>"
    }
  ],
  "embassySpecific": {
    "minimumFunds": <required amount>,
    "seasoningRequirements": ${seasoningRules.match(/\d+/)?.[0] || 90},
    "seasoningExplanation": "${seasoningRules.replace(/\n/g, ' ')}",
    "documentChecklist": [<required documents>],
    "commonRejectionReasons": [<common issues>],
    "countrySpecificRules": [<specific rules>]
  }
}

IMPORTANT: 
- Calculate REAL seasoning days from transaction history
- Flag ANY deposits within seasoning period as potential issues
- Be specific about what needs to be fixed
- Return ONLY valid JSON, no markdown`;

    // STEP 4: Call Groq AI for analysis
    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: 'You are an expert visa financial analyst.' },
        { role: 'user', content: prompt }
      ],
      response_format: { type: 'json_object' },
      temperature: 0.3,
      max_completion_tokens: 2048,
    });

    const responseText = completion.choices[0].message.content || '{}';
    
    // Clean the response
    let cleanedText = responseText.trim()
      .replace(/```json\n?/g, '')
      .replace(/```\n?/g, '')
      .trim();

    // Parse JSON
    let analysis: ProofOfFundsAnalysis;
    try {
      analysis = JSON.parse(cleanedText);
      console.log('‚úÖ JSON parsed successfully');
    } catch (parseError) {
      console.error('‚ùå JSON parse failed, attempting extraction...');
      const jsonMatch = cleanedText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        analysis = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error('Could not extract valid JSON from AI response');
      }
    }

    // Validate structure
    if (!analysis.summary || !analysis.summary.riskLevel) {
      throw new Error('AI returned incomplete analysis structure');
    }

    console.log('‚úÖ POF analysis completed successfully');
    return { success: true, analysis };

  } catch (error: any) {
    console.error('‚ùå POF analysis failed:', error.message);
    return {
      success: false,
      error: error.message || 'Analysis failed'
    };
  }
}

/**
 * üî• Get account seasoning requirements by country and visa type
 */
function getSeasoningRequirements(country: string, visaType: string): string {
  const seasoningRules: Record<string, Record<string, string>> = {
    'Canada': {
      'student': '90 days minimum. Canadian Student Direct Stream requires 4-6 months of bank statements showing consistent balance. Large deposits within 90 days will be questioned.',
      'work': '90 days minimum. IRCC scrutinizes account history for sudden increases.',
      'visitor': '90 days recommended. Short-term visitors should show stable funds.',
    },
    'United Kingdom': {
      'student': '28 consecutive days. CRITICAL: UK has strict 28-day rule. Funds must be in account for 28 consecutive days before application. Bank letter must be dated within 31 days of visa application.',
      'work': '90 days recommended. Show employment stability and consistent income.',
      'visitor': '90 days recommended. Recent large deposits raise red flags.',
    },
    'United States': {
      'student': '90-180 days. US embassy wants to see funds maintained for 3-6 months. Recent deposits (within 60 days) will be questioned during interview.',
      'work': '90 days minimum. Must demonstrate financial stability.',
      'visitor': '90 days minimum. Show travel history and financial ties to home country.',
    },
    'Australia': {
      'student': '90 days minimum. Australian Immigration requires genuine access to funds. Recent large deposits indicate lack of genuine capacity.',
      'work': '90 days minimum. Consistent income and savings pattern preferred.',
      'visitor': '90 days recommended. Show financial stability and reason to return home.',
    },
  };

  const countryRules = seasoningRules[country];
  if (countryRules) {
    return countryRules[visaType] || countryRules['visitor'] || '90 days minimum seasoning required';
  }

  return '90 days minimum seasoning required for most visa types';
}

/**
 * üî• Get minimum fund requirements by country, visa type, and family size
 */
function getMinimumFundRequirements(
  country: string,
  visaType: string,
  familyMembers: number
): string {
  const fundRules: Record<string, any> = {
    'Canada': {
      student: {
        base: 20635,
        perPerson: 4000,
        currency: 'CAD',
        notes: 'Must show tuition + CAD $20,635 for living expenses (as of 2025). Add CAD $4,000 per additional family member.'
      },
      work: {
        base: 15000,
        perPerson: 3000,
        currency: 'CAD',
        notes: 'Proof of employment and settlement funds required.'
      }
    },
    'United Kingdom': {
      student: {
        base: 13356, // ¬£1,483 x 9 months
        perPerson: 6000,
        currency: 'GBP',
        notes: '¬£1,483/month in London (¬£1,136 outside London) for 9 months. Add ¬£6,000 per family member.'
      }
    },
    'United States': {
      student: {
        base: 30000,
        perPerson: 8000,
        currency: 'USD',
        notes: 'Amount varies by university. Typically $30,000-$70,000 per year including tuition.'
      }
    },
    'Australia': {
      student: {
        base: 29710,
        perPerson: 7362,
        currency: 'AUD',
        notes: 'AUD $29,710 for 12 months. Add AUD $7,362 per family member.'
      }
    }
  };

  const countryRule = fundRules[country];
  if (countryRule && countryRule[visaType]) {
    const rule = countryRule[visaType];
    const totalRequired = rule.base + (rule.perPerson * (familyMembers - 1));
    return `Minimum Required: ${rule.currency} $${totalRequired.toLocaleString()}
Base Amount: ${rule.currency} $${rule.base.toLocaleString()}
Additional per family member: ${rule.currency} $${rule.perPerson.toLocaleString()}
Notes: ${rule.notes}`;
  }

  return 'Minimum $20,000 USD or equivalent recommended for most visa types';
}
--- src/ai/flows/document-checker.ts ---
'use server';

const GEMINI_API_KEY = 'AIzaSyDJMlSrIX7rMSV75Hrf0pbsx3XtWmuyvFw';
const GEMINI_MODEL = 'gemini-2.5-flash';

interface DocumentCheckerInput {
  documentDataUri: string;
  targetCountry?: string;
  visaType?: string;
  userId?: string;
}

interface DocumentAnalysis {
  documentType: string;
  overallStatus: 'pass' | 'warning' | 'critical';
  criticalIssues: Array<{
    issue: string;
    impact: string;
    recommendation: string;
  }>;
  warnings: Array<{
    issue: string;
    recommendation: string;
  }>;
  passed: string[];
  extractedData: {
    dates: string[];
    amounts: string[];
    signatures: string[];
    stamps: string[];
  };
  embassyCompliance: {
    meetsStandards: boolean;
    specificRequirements: string[];
    missingElements: string[];
  };
}

export async function documentChecker(input: DocumentCheckerInput): Promise<DocumentAnalysis> {
  try {
    console.log('üîç Analyzing document for:', input.visaType, 'visa to', input.targetCountry);
    
    console.log('üåê Getting embassy requirements...');
    const embassyRequirements = await getEmbassyRequirements(
      input.targetCountry || 'General',
      input.visaType || 'Tourist'
    );
    
    console.log('üì∏ Analyzing with Gemini Vision...');
    const analysis = await analyzeWithVision(
      input.documentDataUri,
      embassyRequirements,
      input.targetCountry || 'General',
      input.visaType || 'Tourist'
    );
    
    console.log('‚úÖ Analysis complete');
    return analysis;
    
  } catch (error: any) {
    console.error('‚ùå Analysis failed:', error);
    return createErrorResponse(error.message);
  }
}

async function getEmbassyRequirements(country: string, visaType: string): Promise<string> {
  try {
    const prompt = `List ${country} ${visaType} visa requirements for 2025: documents, financial proof, passport validity, rejection reasons. Concise.`;
    
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );
    
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    
  } catch (error) {
    return `${country} ${visaType} visa: Valid passport (6+ months), financial proof, photos, application, supporting documents.`;
  }
}

async function analyzeWithVision(
  imageDataUri: string,
  requirements: string,
  country: string,
  visaType: string
): Promise<DocumentAnalysis> {
  
  try {
    const base64Data = imageDataUri.split(',')[1];
    if (!base64Data) throw new Error('Invalid image data');
    
    const mimeMatch = imageDataUri.match(/data:(image\/[^;]+)/);
    const mimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
    
    const prompt = `Analyze this ${country} ${visaType} visa document image.

REQUIREMENTS: ${requirements}

Extract ALL visible text, dates, amounts, signatures, stamps. Identify document type and compliance issues for ${country} ${visaType} visa.

Return ONLY valid JSON (no markdown):
{
  "documentType": "passport|bank_statement|employment_letter|travel_itinerary|sponsor_letter|other",
  "overallStatus": "pass|warning|critical",
  "extractedData": {
    "dates": ["all dates with labels"],
    "amounts": ["all amounts with currency"],
    "signatures": ["descriptions"],
    "stamps": ["descriptions"]
  },
  "criticalIssues": [
    {"issue": "specific problem", "impact": "why rejected", "recommendation": "exact fix"}
  ],
  "warnings": [
    {"issue": "concern", "recommendation": "improvement"}
  ],
  "passed": ["met requirements"],
  "embassyCompliance": {
    "meetsStandards": true,
    "specificRequirements": ["checklist"],
    "missingElements": ["missing items"]
  }
}`;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt },
              { inline_data: { mime_type: mimeType, data: base64Data }}
            ]
          }]
        })
      }
    );
    
    const data = await response.json();
    if (data.error) throw new Error(`Gemini: ${data.error.message}`);
    
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    if (!text) throw new Error('No response from Gemini');
    
    const cleanText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
    
    if (!jsonMatch) throw new Error('Could not parse JSON');
    
    const analysis = JSON.parse(jsonMatch[0]);
    
    if (!analysis.documentType || !analysis.overallStatus) {
      throw new Error('Invalid analysis structure');
    }
    
    return analysis;
    
  } catch (error: any) {
    console.error('‚ùå Vision failed:', error);
    throw error;
  }
}

function createErrorResponse(message: string): DocumentAnalysis {
  return {
    documentType: 'Unknown',
    overallStatus: 'critical',
    criticalIssues: [{
      issue: 'Analysis Failed',
      impact: message,
      recommendation: 'Upload a clear JPG or PNG image of your document'
    }],
    warnings: [],
    passed: [],
    extractedData: { dates: [], amounts: [], signatures: [], stamps: [] },
    embassyCompliance: { meetsStandards: false, specificRequirements: [], missingElements: [] }
  };
}

--- src/ai/flows/site-assistant-flow.ts ---
'use server';
import { groq } from '@/lib/groq-client';
import { SITE_ASSISTANT_CONTEXT } from '@/lib/site-assistant-context';

interface SiteAssistantInput {
  question: string;
}

interface SiteAssistantOutput {
  answer: string;
}

export async function siteAssistant(input: SiteAssistantInput): Promise<SiteAssistantOutput> {
  try {
    // PROPER GROQ STRUCTURE - SYSTEM MESSAGE FIRST
    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { 
          role: 'system', 
          content: `You are Japa Genie site assistant with this knowledge: ${SITE_ASSISTANT_CONTEXT}. 
          Answer based ONLY on this knowledge. Be concise and helpful.`
        },
        { role: 'user', content: input.question }
      ],
      temperature: 0.3, // Lower for factual consistency
    });
    
    const answer = completion.choices[0].message.content || '';
    return { answer };
  } catch (error) {
    console.error('Site assistant error:', error);
    return { answer: "I apologize, but I'm having trouble accessing our knowledge base right now. Please try asking about our pricing, services, or specific visa questions." };
  }
}

--- src/ai/flows/TEST-DOC.ts ---
import { documentChecker } from './document-checker';
import fs from 'fs';

async function test() {
  const pdf = fs.readFileSync('/home/user/uploads/statement.pdf');
  const base64 = pdf.toString('base64');
  const dataUri = `data:application/pdf;base64,${base64}`;
  
  const result = await documentChecker({
    documentDataUri: dataUri,
    targetCountry: 'USA',
    visaType: 'Tourist'
  });
  
  console.log(JSON.stringify(result, null, 2));
}

test();

--- src/ai/flows/interview-flow.ts ---
'use server';
import { groq } from '@/lib/groq-client';

interface InterviewQuestionInput {
  visaType: string;
  destination: string;
  userBackground: string;
  previousQuestions: string[];
}

interface InterviewQuestionOutput {
  question: string;
}

export async function generateInterviewQuestion(input: InterviewQuestionInput): Promise<InterviewQuestionOutput> {
  try {
    const prompt = `You are an expert visa consular officer. Generate ONE realistic visa interview question.

Visa: ${input.visaType}
Destination: ${input.destination} 
Background: ${input.userBackground}
Previous Questions: ${input.previousQuestions.join(', ') || 'None'}

Generate ONE new, relevant question that a real officer would ask.`;

    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0.7,
    });
    
    const question = completion.choices[0].message.content?.trim() || '';
    return { question };
  } catch (error: any) {
    console.error('Interview error:', error);
    throw new Error('Failed to generate interview question');
  }
}

--- src/ai/flows/report-generator.ts ---
'use server';

const GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'AIzaSyDJMlSrIX7rMSV75Hrf0pbsx3XtWmuyvFw';
const GEMINI_MODEL = 'gemini-2.5-flash';

export async function generatePersonalizedReport(analysisResult: any, targetCountry: string, visaType: string) {
  const prompt = `You are a friendly visa consultant writing a personalized report for someone applying for a ${visaType} visa to ${targetCountry}.

Document analysis results:
${JSON.stringify(analysisResult, null, 2)}

Write a warm, encouraging letter (400-600 words, HTML tags: <h1><h2><p><strong><ul><li>) that:
1. Greets the reader
2. Summarises the analysed document
3. Explains each critical issue in plain language with step-by-step fixes
4. Lists warnings with practical recommendations
5. Celebrates passed checks
6. Ends with encouraging next steps

Return ONLY the HTML content (no markdown, no code blocks).`;

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`,
    { method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }
  );
  const data = await res.json();
  if (data.error) throw new Error(`Gemini: ${data.error.message}`);
  const html = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  return { letterHTML: html.trim(), generatedAt: new Date().toISOString() };
}

--- src/ai/flows/rejection-reversal.ts ---
'use server';
import { groq } from '@/lib/groq-client';
import { 
  type RejectionStrategyInput,
  type RejectionStrategyOutput 
} from '@/ai/schemas/rejection-reversal-schema';


export type { RejectionStrategyInput, RejectionStrategyOutput };

export async function generateRejectionStrategy(input: RejectionStrategyInput): Promise<RejectionStrategyOutput> {
  try {
    const prompt = `You are Japa Genie, an expert immigration consultant specializing in visa rejection analysis.

User's situation:
- Visa Type: ${input.visaType}
- Destination: ${input.destination}
- Rejection Reason: ${input.rejectionReason || 'Not provided'}
- Background: ${input.userBackground}

Create a comeback strategy with 3-5 actionable steps. Each step needs: step number, headline, and detailed instructions.

CRITICAL: Respond with ONLY valid JSON. No markdown, no code blocks, no explanations. Just pure JSON.

Format:
{
  "introduction": "One encouraging sentence here",
  "strategy": [
    {"step": 1, "headline": "Action headline", "details": "Detailed explanation"},
    {"step": 2, "headline": "Action headline", "details": "Detailed explanation"},
    {"step": 3, "headline": "Action headline", "details": "Detailed explanation"}
  ],
  "conclusion": "One encouraging conclusion with call to action"
}`;

    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: 'You are an expert immigration consultant specializing in visa rejection analysis.' },
        { role: 'user', content: prompt }
      ],
      response_format: { type: 'json_object' },
      temperature: 0.7,
    });

    const text = completion.choices[0].message.content || '{}';
    
    let cleaned = text
      .trim()
      .replace(/```json\n?/gi, '')
      .replace(/```\n?/g, '')
      .replace(/^[^{]*/, '')
      .replace(/[^}]*$/, '')
      .trim();
    
    const parsed = JSON.parse(cleaned);
    
    if (!parsed.introduction || !Array.isArray(parsed.strategy)) {
      throw new Error('Invalid AI response structure');
    }
    
    const output: RejectionStrategyOutput = {
      introduction: parsed.introduction,
      strategy: parsed.strategy.map((s: any, i: number) => ({
        step: typeof s.step === 'number' ? s.step : i + 1,
        headline: s.headline || `Step ${i + 1}`,
        details: s.details || s.description || 'Follow this guidance.'
      })),
      conclusion: parsed.conclusion || "With proper preparation, you can successfully reapply!"
    };
    
    return output;
    
  } catch (error) {
    console.error('‚ùå Rejection strategy generation failed:', error);
    
    return {
      introduction: "Don't let this rejection discourage you - there's always a path forward.",
      strategy: [
        {
          step: 1,
          headline: "Analyze the Rejection Letter",
          details: `Review the official rejection letter for your ${input.destination} ${input.visaType} visa.`
        },
        {
          step: 2,
          headline: "Address the Core Issues",
          details: `The rejection reason "${input.rejectionReason || 'not specified'}" indicates specific weaknesses.`
        },
        {
          step: 3,
          headline: "Strengthen Your Documentation",
          details: `Based on your background, compile comprehensive supporting documents.`
        }
      ],
      conclusion: "Many applicants succeed on their second attempt with proper preparation!"
    };
  }
}

--- src/ai/flows/visa-matchmaker.ts ---
'use server';
import { groq } from '@/lib/groq-client';


interface UserProfile {
  age: number;
  education: string;
  profession: string;
  workExperience: number;
  englishProficiency: 'Basic' | 'Intermediate' | 'Advanced' | 'Native';
  budget: number;
  primaryGoal: 'Study' | 'Work' | 'Business' | 'Family' | 'Tourism';
  preferredRegions: string[];
  hasSpouse?: boolean;
  hasDependents?: boolean;
  currentCountry: string;
}

interface VisaMatchmakerInput {
  userProfile: UserProfile;
  isPremium: boolean;
}

interface CountryMatch {
  country: string;
  visaType: string;
  matchScore: number;
  successRate: number;
  processingTime: string;
  requirements: {
    mustHave: string[];
    recommended: string[];
    commonPitfalls: string[];
  };
  strengths: string[];
  redFlags: string[];
}

interface VisaMatchmakerOutput {
  topMatches: CountryMatch[];
  overallAnalysis: string;
  nextSteps: string[];
  warningsAndCautions: string[];
}

export async function visaMatchmaker(input: VisaMatchmakerInput): Promise<VisaMatchmakerOutput> {
  const prompt = `ACT AS: Expert immigration consultant specializing in African professionals with 15+ years experience
ANALYZE THIS PROFILE FOR GLOBAL VISA OPPORTUNITIES:

APPLICANT DETAILS:
- Age: ${input.userProfile.age}
- Education: ${input.userProfile.education}
- Profession: ${input.userProfile.profession}
- Experience: ${input.userProfile.workExperience} years
- English: ${input.userProfile.englishProficiency}
- Budget: $${input.userProfile.budget}
- Goal: ${input.userProfile.primaryGoal}
- Preferred Regions: ${input.userProfile.preferredRegions.join(', ')}
- Current Country: ${input.userProfile.currentCountry}
${input.userProfile.hasSpouse ? '- Has Spouse' : ''}
${input.userProfile.hasDependents ? '- Has Dependents' : ''}

Premium Status: ${input.isPremium ? 'YES' : 'NO'}

Return as JSON matching this EXACT structure:
{
  "topMatches": [
    {
      "country": "string",
      "visaType": "string",
      "matchScore": 85,
      "successRate": 75,
      "processingTime": "6-8 months",
      "requirements": {
        "mustHave": ["string"],
        "recommended": ["string"],
        "commonPitfalls": ["string"]
      },
      "strengths": ["specific strength 1", "specific strength 2", "specific strength 3"],
      "redFlags": ["string"]
    }
  ],
  "overallAnalysis": "string",
  "nextSteps": ["string"],
  "warningsAndCautions": ["string"]
}`;

  try {
    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' },
      temperature: 0.7,
    });

    const rawText = completion.choices[0].message.content || '{}';
    const parsed = JSON.parse(rawText);
    
    return parsed;
    
  } catch (error) {
    console.error('Visa matchmaker error:', error);
    
    // Fallback response
    return {
      topMatches: [
        {
          country: "Canada",
          visaType: "Express Entry",
          matchScore: 75,
          successRate: 65,
          processingTime: "6-8 months",
          requirements: {
            mustHave: ["Valid passport", "Education credential assessment", "Language test"],
            recommended: ["Job offer", "Provincial nomination"],
            commonPitfalls: ["Low CRS score", "Incomplete documentation"]
          },
          strengths: ["Good education match", "English proficiency meets requirement", "Profession in demand"],
          redFlags: ["Limited work experience may lower CRS score"]
        }
      ],
      overallAnalysis: "Strong candidate for skilled worker visas with good prospects.",
      nextSteps: ["Take language test", "Get credential assessment", "Build professional network"],
      warningsAndCautions: ["Consider premium upgrade for personalized guidance"]
    };
  }
}

--- src/ai/insights-generator.ts.gemini-backup ---
'use server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { InsightInput, InsightOutput } from '@/ai/schemas/insight-schemas';

const genAI = new GoogleGenerativeAI(process.env.NEXT_PUBLIC_GEMINI_API_KEY!);

export async function generateInsights(input: InsightInput): Promise<InsightOutput> {
  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = `You are an expert immigration analyst.

Generate insights for: "${input.question}"

Return ONLY valid JSON in this EXACT format (no markdown, no backticks):
{
  "insights": [
    {
      "headline": "Clear headline",
      "detail": "Detailed explanation",
      "url": "optional link"
    }
  ],
  "costEstimates": [
    {
      "item": "Cost item name",
      "cost": 1000,
      "currency": "USD"
    }
  ],
  "visaAlternatives": [
    {
      "visaName": "Alternative visa name",
      "description": "Why this alternative works"
    }
  ],
  "chartData": {
    "title": "Processing Times by Country",
    "data": [
      {"name": "USA", "value": 90},
      {"name": "UK", "value": 60}
    ]
  }
}

Generate 3-5 insights, 2-4 cost estimates, 2-3 alternatives, and chart data with 3-5 countries.`;

  try {
    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().trim();
    
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    return JSON.parse(text);
  } catch (error) {
    console.error('Insights API error:', error);
    return {
      insights: [{ headline: "Temporary Service Issue", detail: "The Genie is experiencing technical difficulties. Please try again in a moment." }],
      costEstimates: [],
      visaAlternatives: [],
      chartData: { title: "Processing Times", data: [{ name: "USA", value: 90 }] }
    };
  }
}

--- src/ai/dev.ts ---
import { config } from 'dotenv';
config();

import '@/ai/flows/interview-flow.ts';
import '@/ai/flows/visa-chat-assistant.ts';
import '@/ai/flows/document-checker.ts';
import '@/ai/flows/rejection-reversal.ts';
import '@/ai/flows/insights-generator.ts';
import '@/ai/flows/site-assistant-flow.ts';
import '@/ai/tools/knowledge-retriever.ts';

--- src/ai/knowledge/faq.md ---
# Frequently Asked Questions

This document contains answers to common questions about Japa Genie.

## General Questions

### Where do I sign up?
You can get started by clicking the "Get Started" or "Start Your Journey" button on our website, which will take you to our AI chat assistant. For full features, you can create an account using the "Log In" button and signing in with Google.

### Can I apply for multiple visa applications at once?
Japa Genie is designed to help you focus on one primary visa application at a time to ensure the highest quality and chance of success. While you can explore different options, we recommend completing one application before starting another.

### How do I save and continue my application later?
Your conversations with the AI assistant and your progress on your dashboard are automatically saved when you are logged into your account. You can sign out and sign back in at any time to continue where you left off.

### Can I edit my application after submitting it?
No. Once a visa application is submitted to an embassy or consulate, it cannot be edited. Our service helps you prepare and review your application thoroughly *before* you submit it to avoid this.

### What do I do if there‚Äôs a mistake in my form?
If you find a mistake before submitting your application, you should correct it immediately. Our AI Document Checker is designed to help you catch common errors. If you've already submitted, you will likely need to contact the embassy to withdraw and resubmit, which can cause delays.

### What payment methods are accepted?
We accept international credit and debit cards through **Stripe**. For users in Nigeria, we also support payments via card, bank transfer, USSD, and mobile money through **Paystack**.

### Will I receive an invoice?
Yes, after a successful payment, you will receive an email confirmation that serves as your receipt. Your payment history will also be available in your account.

### Is the payment portal secured?
Absolutely. We use industry-leading payment processors, Stripe and Paystack, both of which are PCI-compliant and use the highest level of security for all transactions. Your payment information is never stored on our servers.

### Are visa fees refundable?
The fees paid to Japa Genie for our services have a specific refund policy outlined in our Terms & Conditions. However, **application fees paid directly to embassies or governments are non-refundable**, regardless of the outcome of your application.

### How can I contact customer care?
You can reach our support team by emailing **support@japagenie.com**. For partnerships or media inquiries, you can use the respective email addresses on our Contact Us page.

### Can you check the status of my application?
Japa Genie helps you prepare your application, but we cannot check the status with the embassy on your behalf. We provide guidance on how to use the official government portals to track your application status yourself.

### How will I be notified of any updates or decisions?
All official updates and decisions regarding your visa application will come directly from the embassy or consulate to which you applied, usually via email or their online portal.

### Is my personal data secure?
Yes. We take data security very seriously. As outlined in our Privacy Policy, we use appropriate technical and organizational measures to protect your information. Your data is not shared without your consent, and you can request its deletion.

### My uploaded files keep getting rejected. Why?
File rejection can happen for several reasons: the file size may be too large, the format may be incorrect (we recommend PDF, PNG, or JPG), or the document may be blurry. Please ensure your scans are clear and the file is a supported type. Our Document Checker can help analyze your files for quality issues.

### The website or app isn‚Äôt loading properly.
Please try clearing your browser cache and refreshing the page. If the issue persists, check your internet connection. Sometimes, browser extensions can interfere with site functionality, so try disabling them. If you continue to have problems, please contact our support team.

### Can I apply for a group or family visa?
Yes, our tools can help you prepare applications for family members. When using our Proof of Funds calculator, you can specify the number of family members to get accurate financial requirements. For complex family applications, we recommend connecting with one of our verified experts.

### How can I reapply if my previous visa was denied?
Our **Rejection Reversal** feature is designed specifically for this. It uses AI to analyze your rejection reason and personal background to create a new, stronger application strategy.

### What should I do if my passport is expiring soon?
Most countries require your passport to be valid for at least six months *beyond* your intended stay. If your passport is expiring sooner than that, you **must** renew it before submitting your visa application to avoid an automatic rejection.

### Can I apply on behalf of someone else?
While you can use our tools to prepare documents and information for someone else, the final application submitted to the embassy must be done by the applicant themselves or a legally authorized representative. Lying on a visa application can have serious consequences.

### Can I extend my visa using this software?
No. Japa Genie is a tool for preparing new visa applications. Visa extensions are handled by the immigration authorities of the country you are already in, and you must follow their specific renewal process.

### What‚Äôs the best pricing plan?
It depends on your needs!
- **One-Time Access (e.g., 1-4 Weeks):** Best if you have a specific, short-term goal like submitting an application soon.
- **Pro Plan (Monthly):** Ideal for ongoing support and peace of mind throughout your application journey.
- **Premium Plan (Monthly):** Perfect for those who want the added security of having a dedicated human expert to assist them.

### What if my payment fails?
If your payment fails, please double-check your card details, ensure you have sufficient funds, and that your card is enabled for international transactions. If the problem persists, try the alternative payment gateway (e.g., switch from Stripe to Paystack) or contact your bank.

--- src/ai/knowledge/starter-guide.md ---
# Welcome to Your Knowledge Base

This is the beginning of your AI's custom knowledge. You can add, edit, and delete markdown (.md) files in this `src/ai/knowledge` directory.

## How it Works

1.  **Add Files**: Create new `.md` files in this directory. Each file should cover a specific topic. For example, `schengen-visa-tips.md`.
2.  **Write Content**: Use standard markdown to write your content. You can use headers, lists, bold text, etc.
3.  **Ask the AI**: The AI Chat Assistant is now configured to read all the files in this directory before answering a question. It will use the information it finds here as its primary source of truth.

## Example

If you add a file named `canada-student-visa.md` with the content:

```
To apply for a Canadian student visa, you must have an acceptance letter from a Designated Learning Institution (DLI). The application fee is $150 CAD.
```

And then you ask the AI chat: "What is the fee for a Canadian student visa?", it will now answer "$150 CAD" based on the information you provided right here.

--- src/ai/insights-generator.ts ---
'use server';
import { groq } from '@/lib/groq-client';
import { InsightInput, InsightOutput } from '@/ai/schemas/insight-schemas';

export async function generateInsights(input: InsightInput): Promise<InsightOutput> {
  const prompt = `You are an expert immigration analyst.

Generate insights for: "${input.question}"

User Profile: ${JSON.stringify(input.userProfile, null, 2)}

Return ONLY valid JSON in this EXACT format (no markdown, no backticks):
{
  "insights": [
    {
      "headline": "Clear headline",
      "detail": "Detailed explanation",
      "url": "optional link"
    }
  ],
  "costEstimates": [
    {
      "item": "Cost item name",
      "cost": 1000,
      "currency": "USD"
    }
  ],
  "visaAlternatives": [
    {
      "visaName": "Alternative visa name",
      "description": "Why this alternative works"
    }
  ],
  "chartData": {
    "title": "Processing Times by Country",
    "data": [
      {"name": "USA", "value": 90},
      {"name": "UK", "value": 60}
    ]
  }
}

Generate 3-5 insights, 2-4 cost estimates, 2-3 alternatives, and chart data with 3-5 countries.`;

  try {
    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: 'You are an expert immigration analyst. Return ONLY valid JSON, no other text.' },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 1500
    });

    let text = completion.choices[0]?.message?.content?.trim() || '';
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    // Try to parse JSON, fallback if invalid
    try {
      return JSON.parse(text);
    } catch (parseError) {
      console.error('Failed to parse JSON:', text);
      return createFallbackInsights();
    }
  } catch (error) {
    console.error('Insights API error:', error);
    return createFallbackInsights();
  }
}

function createFallbackInsights(): InsightOutput {
  return {
    insights: [{ headline: "Temporary Service Issue", detail: "The Genie is experiencing technical difficulties. Please try again in a moment." }],
    costEstimates: [],
    visaAlternatives: [],
    chartData: { title: "Processing Times", data: [{ name: "USA", value: 90 }] }
  };
}

--- src/ai/insights-generator.ts.test-backup ---
'use server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { InsightInput, InsightOutput } from '@/ai/schemas/insight-schemas';

const genAI = new GoogleGenerativeAI(process.env.NEXT_PUBLIC_GEMINI_API_KEY!);

export async function generateInsights(input: InsightInput): Promise<InsightOutput> {
  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = `You are an expert immigration analyst.

Generate insights for: "${input.question}"

Return ONLY valid JSON in this EXACT format (no markdown, no backticks):
{
  "insights": [
    {
      "headline": "Clear headline",
      "detail": "Detailed explanation",
      "url": "optional link"
    }
  ],
  "costEstimates": [
    {
      "item": "Cost item name",
      "cost": 1000,
      "currency": "USD"
    }
  ],
  "visaAlternatives": [
    {
      "visaName": "Alternative visa name",
      "description": "Why this alternative works"
    }
  ],
  "chartData": {
    "title": "Processing Times by Country",
    "data": [
      {"name": "USA", "value": 90},
      {"name": "UK", "value": 60}
    ]
  }
}

Generate 3-5 insights, 2-4 cost estimates, 2-3 alternatives, and chart data with 3-5 countries.`;

  try {
    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().trim();
    
    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    return JSON.parse(text);
  } catch (error) {
    console.error('Insights API error:', error);
    return {
      insights: [{ headline: "Temporary Service Issue", detail: "The Genie is experiencing technical difficulties. Please try again in a moment." }],
      costEstimates: [],
      visaAlternatives: [],
      chartData: { title: "Processing Times", data: [{ name: "USA", value: 90 }] }
    };
  }
}

--- src/ai/utils/tesseract-ocr.ts ---
import Tesseract from 'tesseract.js';
import path from 'path';

export async function ocrScan(buffer: Buffer, lang = 'eng'): Promise<string> {
  try {
    // Create worker with explicit paths for Next.js
    const worker = await Tesseract.createWorker(lang, undefined, {
      workerPath: path.resolve(process.cwd(), 'node_modules/tesseract.js/dist/worker.min.js'),
      langPath: 'https://tessdata.projectnaptha.com/4.0.0',
      corePath: 'https://unpkg.com/tesseract.js-core@v4.0.2/tesseract-core.wasm.js',
      logger: () => {} // Suppress logs
    });

    const { data: { text } } = await worker.recognize(buffer);
    await worker.terminate();
    
    return text || '';
  } catch (error) {
    console.error('OCR failed:', error);
    // Return empty string instead of throwing to allow graceful degradation
    return '';
  }
}
--- src/ai/utils/pdf-text-extract.ts ---
export async function getPdfText(buffer: Buffer<ArrayBufferLike>): Promise<null> { return null; }

--- src/ai/utils/fx.ts ---
import axios from 'axios';

let cache: { rate: number; ts: number } | null = null;
const CACHE_MS = 24 * 60 * 60 * 1000; // 24 h

/* returns 1 EUR ‚Üí USD cross-rate */
async function ecbUsdRate(): Promise<number> {
  if (cache && Date.now() - cache.ts < CACHE_MS) return cache.rate;
  const { data } = await axios.get('https://www.ecb.europa.eu/stats/eurofxref/eurofxref-daily.xml');
  const m = data.match(/currency="USD" rate="([\d.]+)"/);
  const rate = m ? parseFloat(m[1]) : 1.08; // fallback
  cache = { rate, ts: Date.now() };
  return rate;
}

/* convert any ISO currency ‚Üí USD */
export async function fxToUSD(currency = 'USD'): Promise<number> {
  if (currency === 'USD') return 1;
  const eurUsd = await ecbUsdRate();
  if (currency === 'EUR') return eurUsd;

  // add more crosses if needed (same XML contains all)
  const crosses: Record<string, number> = {
    GBP: 0.85,
    CAD: 1.47,
    NGN: 460,
    KES: 135,
    GHS: 12.2,
  };
  const cross = crosses[currency.toUpperCase()];
  if (cross) return eurUsd / cross;

  return eurUsd; // fallback
}

--- src/ai/utils/extract-doc-text.ts ---
import { getPdfText } from './pdf-text-extract';
import { ocrScan } from './tesseract-ocr';
export async function extractTextFromFiles(
  files: { name: string; buffer: Buffer; mimetype: string }[]
): Promise<string> {
  const chunks: string[] = [];
  for (const f of files) {
    let text: string | null = null;
    if (f.mimetype === 'application/pdf') text = await getPdfText(f.buffer);
    if (!text) text = await ocrScan(f.buffer); // fallback
    chunks.push(`--- ${f.name} ---\n${text}`);
  }
  return chunks.join('\n');
}

